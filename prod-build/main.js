(()=>{var e={1537:e=>{function t(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=1537,e.exports=t},2979:(e,t,a)=>{var i={"./Department.js":5,"./Dispatch.js":8809,"./DispatchItem.js":3686,"./Invoice.js":812,"./InvoiceItem.js":9167,"./Item.js":6064,"./ItemGroup.js":9637,"./LogbookEntry.js":3262,"./MachineCategory.js":9422,"./MachineServiceInterval.js":3866,"./MachineTransfer.js":7509,"./Machinery.js":1103,"./MachineryItemCode.js":4441,"./MaintenanceLog.js":5832,"./MaterialIssue.js":6215,"./MaterialIssueItem.js":1468,"./Notification.js":6800,"./NotificationReadStatus.js":8778,"./NotificationRole.js":7460,"./Payment.js":2477,"./PrimaryCategory.js":2709,"./Procurement.js":5213,"./ProcurementItem.js":7090,"./QuotationComparison.js":3452,"./QuotationComparisonItem.js":2319,"./QuotationComparisonRate.js":7078,"./QuotationComparisonVendor.js":7710,"./QuotationComparisonVersion.js":4690,"./Requisition.js":4299,"./RequisitionItem.js":3992,"./RequisitionSiteRejection.js":6989,"./Role.js":6003,"./Site.js":8516,"./SiteInventory.js":8362,"./StockLog.js":3999,"./Unit.js":6109,"./User.js":5596,"./Vendor.js":4197,"./index.js":9239};function n(e){var t=r(e);return a(t)}function r(e){if(!a.o(i,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return i[e]}n.keys=function(){return Object.keys(i)},n.resolve=r,e.exports=n,n.id=2979},5298:e=>{e.exports={prod:{username:process.env.DB_USERNAME,password:process.env.DB_PASSWORD,database:process.env.DB_NAME,host:process.env.DB_HOST,dialect:process.env.DB_DIALECT,logging:!1},dev:{username:process.env.DB_USERNAME,password:process.env.DB_PASSWORD,database:process.env.DB_NAME,host:process.env.DB_HOST,port:process.env.DB_PORT,dialect:"postgres",logging:!1,dialectOptions:{ssl:{require:!0,rejectUnauthorized:!1}}}}},7434:e=>{e.exports=function(e){return async(t,a,i)=>{try{await e(t,a,i)}catch(e){i(e)}}}},5965:(e,t,a)=>{const i=a(8461),n=a(5056),r=i({storage:a(8640)({cloudinary:n,params:{folder:"hekopay_logos",allowedFormats:["jpg","jpeg","png","webp"],public_id:(e,t)=>`user_${e.params.id}_logo`}})});e.exports=r},4946:(e,t,a)=>{a(3568),e.exports=async function(e,t,a,i){let n=e.statusCode||500;a.sendError(e,n)}},7799:(e,t,a)=>{const i=a(8461),n=a(1416).v2,{Readable:r}=a(2203);n.config({cloud_name:process.env.CLOUDINARY_CLOUD_NAME,api_key:process.env.CLOUDINARY_API_KEY,api_secret:process.env.CLOUDINARY_API_SECRET});const s=i({storage:i.memoryStorage()});async function o(e,t,a,i=null){if(!e)return null;if(i){const e=i.split("/").pop().split(".")[0];await n.uploader.destroy(e)}return new Promise(((i,s)=>{const o=n.uploader.upload_stream({folder:t},((e,t)=>{if(e)return s(e);i({field:a,url:t.secure_url})}));r.from(e.buffer).pipe(o)}))}e.exports={upload:s,fileUploadMiddleware:function(e,t="uploads",a,i){return async(n,r,s)=>{try{if(!n.files)return s();n.fileData={};const r=a?`${t}/${a}`:t;let d;if("function"==typeof i)try{d=await i(n)}catch(e){d=void 0}const c=e=>e?Array.isArray(e)?e:[e]:[],l=[];for(const t of e){const e=c(n.files[t]);if(0===e.length)continue;const a=d?.[t];e.forEach(((e,i)=>{const n=Array.isArray(a)?a[i]??null:0===i&&"string"==typeof a?a:null;l.push(o(e,r,t,n).then((e=>({field:t,url:e?.url}))))}))}if(0===l.length)return s();const u=await Promise.all(l),m={};for(const{field:e,url:t}of u)t&&(m[e]||(m[e]=[]),m[e].push(t));for(const e of Object.keys(m)){const t=m[e];n.fileData[e]=1===t.length?t[0]:t}s()}catch(e){r.status(500).send({message:"Error uploading files to Cloudinary",error:e})}}}}},7242:e=>{e.exports=function(e){return(t,a,i)=>{if(!t.user||!e.includes(t.user.roleId))return a.sendError({message:"Forbidden: Insufficient permissions",name:"PermissionDeniedError"},403);i()}}},6661:(e,t,a)=>{const i=a(3106);function n(e,t,a,n){const r=e.headers["accept-encoding"]||"",s=JSON.stringify(a);r.includes("gzip")?i.gzip(s,((e,a)=>{e?t.status(500).send("Internal Server Error"):(t.setHeader("Content-Encoding","gzip"),t.setHeader("Content-Type","application/json"),t.status(n).send(a))})):(t.setHeader("Content-Type","application/json"),t.status(n).send(s))}e.exports=function(e,t,a){t.sendResponse=(a,i="Success",r=200)=>{const s={status:!0,message:i,data:a,timestamp:(new Date).toISOString()};n(e,t,s,r)},t.sendError=(a,i=500)=>{const r={status:!1,message:a.message||"An error occurred",error:{name:a.name||"Error",stack:void 0,details:a.details||null},timestamp:(new Date).toISOString()};n(e,t,r,i)},a()}},9117:(e,t,a)=>{const i=a(829),n=a(9239);e.exports=async function(e,t,a){try{const r=e.cookies.token;if(!r)return t.sendError({message:"Access denied. No token provided.",name:"TokenNotFoundError"},401);const s=i.verify(r,process.env.JWT_SECRET);if(e.user=s,!await n.User.findByPk(e.user.id))return t.clearCookie("token",{httpOnly:!1,secure:!0,sameSite:"None"}),t.sendError({message:"Access denied. User not found.",name:"UserNotFoundErro"},401);a()}catch(e){return e.statusCode=401,e.data={tokenProvided:!0},t.sendError(e,401)}}},4081:e=>{e.exports=(e,t="body")=>(a,i,n)=>{const r=a[t],{error:s}=e.validate(r,{convert:!0,abortEarly:!1});if(s){const e=new Error;throw e.name="Validation Error",e.message=s.details?.map((e=>e.message)).join("\n"),e}n()}},5:e=>{e.exports=(e,t)=>{const a=e.define("Department",{id:{type:t.INTEGER,primaryKey:!0,autoIncrement:!0},name:{type:t.STRING,allowNull:!1}},{tableName:"departments",timestamps:!0,paranoid:!0});return a.associate=e=>{a.belongsTo(e.User,{foreignKey:"id"}),a.hasMany(e.Site,{foreignKey:"id"})},a}},8809:e=>{e.exports=(e,t)=>{const a=e.define("Dispatch",{vehicleNo:{type:t.STRING,allowNull:!0},driverName:{type:t.STRING,allowNull:!0},remarks:{type:t.STRING,allowNull:!0},procurementId:{type:t.INTEGER,allowNull:!1},fromSiteId:{type:t.INTEGER,allowNull:!1},toSiteId:{type:t.INTEGER,allowNull:!1},status:{type:t.ENUM("dispatched","received"),defaultValue:"dispatched"}},{tableName:"dispatches",timestamps:!0});return a.associate=e=>{a.belongsTo(e.Procurement,{foreignKey:"procurementId"}),a.belongsTo(e.Site,{as:"fromSite",foreignKey:"fromSiteId"}),a.belongsTo(e.Site,{as:"toSite",foreignKey:"toSiteId"}),a.hasMany(e.DispatchItem,{foreignKey:"dispatchId",as:"items"})},a}},3686:e=>{e.exports=(e,t)=>{const a=e.define("DispatchItem",{dispatchId:{type:t.INTEGER,allowNull:!1},itemId:{type:t.INTEGER,allowNull:!1},quantity:{type:t.INTEGER,allowNull:!1}},{tableName:"dispatch_items",timestamps:!0});return a.associate=e=>{a.belongsTo(e.Dispatch,{foreignKey:"dispatchId"}),a.belongsTo(e.Item,{foreignKey:"itemId"})},a}},812:e=>{e.exports=(e,t)=>{const a=e.define("Invoice",{invoiceNumber:{type:t.STRING,allowNull:!1,unique:!0},invoiceDate:{type:t.DATE,allowNull:!1},amount:{type:t.DECIMAL(12,2),allowNull:!1},status:{type:t.ENUM("DRAFT","SENT","PAID","PARTIALLY_PAID","CANCELLED"),defaultValue:"DRAFT"},files:{type:t.JSONB,allowNull:!0},notes:t.TEXT,isInventoryUpdated:{type:t.BOOLEAN,defaultValue:!1}},{tableName:"invoices",timestamps:!0});return a.associate=e=>{a.belongsTo(e.Procurement,{foreignKey:"procurementId",as:"procurement"}),a.hasMany(e.Payment,{foreignKey:"invoiceId",as:"payments"}),a.hasMany(e.InvoiceItem,{foreignKey:"invoiceId",as:"items"})},a}},9167:e=>{e.exports=(e,t)=>{const a=e.define("InvoiceItem",{invoiceId:{type:t.INTEGER,allowNull:!1},procurementItemId:{type:t.INTEGER,allowNull:!1},quantity:{type:t.INTEGER,allowNull:!1},rate:{type:t.DECIMAL(10,2)},amount:{type:t.DECIMAL(10,2)}},{tableName:"invoice_items",timestamps:!0});return a.associate=e=>{a.belongsTo(e.Invoice,{foreignKey:"invoiceId"}),a.belongsTo(e.ProcurementItem,{foreignKey:"procurementItemId"})},a}},6064:e=>{e.exports=(e,t)=>{const a=e.define("Item",{id:{type:t.INTEGER,autoIncrement:!0,allowNull:!1,primaryKey:!0},name:{type:t.STRING,allowNull:!1},shortName:{type:t.STRING,allowNull:!0},partNumber:{type:t.STRING,allowNull:!0},hsnCode:{type:t.STRING,allowNull:!0},itemGroupId:{type:t.INTEGER,allowNull:!1},unitId:{type:t.INTEGER,allowNull:!1}},{tableName:"items",timestamps:!1});return a.associate=e=>{a.belongsTo(e.ItemGroup,{foreignKey:"itemGroupId"}),a.belongsTo(e.Unit,{foreignKey:"unitId"}),a.hasMany(e.SiteInventory,{foreignKey:"itemId"})},a}},9637:e=>{e.exports=(e,t)=>{const a=e.define("ItemGroup",{id:{type:t.INTEGER,autoIncrement:!0,primaryKey:!0},name:{type:t.STRING,allowNull:!1},shortName:{type:t.STRING,allowNull:!0},itemType:{type:t.STRING,allowNull:!0}},{tableName:"item_groups",timestamps:!1});return a.associate=e=>{a.hasMany(e.Item,{foreignKey:"itemGroupId"})},a}},3262:e=>{e.exports=(e,t)=>{const a=e.define("LogbookEntry",{id:{type:t.INTEGER,autoIncrement:!0,primaryKey:!0},date:{type:t.DATE,allowNull:!1},machineId:{type:t.INTEGER,allowNull:!1},siteId:{type:t.INTEGER,allowNull:!1},location:{type:t.STRING,allowNull:!0},name:{type:t.STRING,allowNull:!0,unique:!0},dieselOpeningBalance:{type:t.FLOAT,defaultValue:0},dieselIssue:{type:t.FLOAT,defaultValue:0},dieselClosingBalance:{type:t.FLOAT,defaultValue:0},openingKmReading:{type:t.FLOAT,defaultValue:0},closingKmReading:{type:t.FLOAT,defaultValue:0},openingHrsMeter:{type:t.FLOAT,defaultValue:0},closingHrsMeter:{type:t.FLOAT,defaultValue:0},workingDetails:{type:t.TEXT,allowNull:!0},createdBy:{type:t.INTEGER,allowNull:!1},totalRunKM:{type:t.FLOAT,allowNull:!0},dieselAvgKM:{type:t.FLOAT,allowNull:!0},totalRunHrsMeter:{type:t.FLOAT,allowNull:!0},dieselAvgHrsMeter:{type:t.FLOAT,allowNull:!0},status:{type:t.ENUM("Pending","Approved","Rejected"),defaultValue:"Pending"},approvedById:{type:t.INTEGER,allowNull:!0},approvedAt:{type:t.DATE,allowNull:!0},rejectedById:{type:t.INTEGER,allowNull:!0},rejectedAt:{type:t.DATE,allowNull:!0},rejectionRemarks:{type:t.TEXT,allowNull:!0}},{tableName:"logbook_entries",timestamps:!0,hooks:{afterCreate:async(e,t)=>{const a=`LOG-${String(e.id).padStart(3,"0")}`;await e.update({name:a},{transaction:t.transaction})}}});return a.associate=e=>{a.belongsTo(e.Site,{foreignKey:"siteId",as:"site"}),a.belongsTo(e.Machinery,{foreignKey:"machineId",as:"machine"}),a.belongsTo(e.User,{foreignKey:"createdBy",as:"creater"}),a.belongsTo(e.User,{foreignKey:"approvedById",as:"approvedBy"}),a.belongsTo(e.User,{foreignKey:"rejectedById",as:"rejectedBy"})},a}},9422:e=>{e.exports=(e,t)=>{const a=e.define("MachineCategory",{id:{type:t.INTEGER,primaryKey:!0,autoIncrement:!0},name:{type:t.STRING,allowNull:!1,unique:!0},primaryCategoryId:{type:t.INTEGER,allowNull:!0},averageBase:{type:t.ENUM("Distance","Time","Both","None"),allowNull:!0},standardKmRun:{type:t.FLOAT,allowNull:!0},standardMileage:{type:t.FLOAT,allowNull:!0},standardHrsRun:{type:t.FLOAT,allowNull:!0},ltrPerHour:{type:t.FLOAT,allowNull:!0},remarks:{type:t.TEXT,allowNull:!0},useFor:{type:t.STRING,allowNull:!0},machineType:{type:t.ENUM("Vehicle","Machine","Drilling"),allowNull:!0},unitPerHour:{type:t.FLOAT,allowNull:!0},isApplicable:{type:t.JSON,allowNull:!0},other:{type:t.STRING,allowNull:!0}},{tableName:"machine_categories",timestamps:!0});return a.associate=e=>{a.belongsTo(e.PrimaryCategory,{foreignKey:"primaryCategoryId",as:"primaryCategory"}),a.hasMany(e.Machinery,{foreignKey:"machineCategoryId",as:"machineries",onDelete:"CASCADE"})},a}},3866:e=>{e.exports=(e,t)=>{const a=e.define("MachineServiceInterval",{id:{type:t.INTEGER,primaryKey:!0,autoIncrement:!0},machineId:{type:t.INTEGER,allowNull:!1,references:{model:"machineries",key:"id"},onDelete:"CASCADE",onUpdate:"CASCADE"},serviceType:{type:t.STRING,allowNull:!1},intervalHours:{type:t.INTEGER,allowNull:!1},intervalKm:{type:t.INTEGER,allowNull:!1},intervalCalendarDays:{type:t.INTEGER,allowNull:!1},isActive:{type:t.BOOLEAN,defaultValue:!0},notes:{type:t.TEXT,allowNull:!0}},{tableName:"machine_service_intervals",timestamps:!0});return a.associate=e=>{a.belongsTo(e.Machinery,{foreignKey:"machineId",as:"machine"})},a}},7509:e=>{e.exports=(e,t)=>{const a=e.define("MachineTransfer",{id:{type:t.INTEGER,primaryKey:!0,autoIncrement:!0},name:{type:t.STRING,allowNull:!0,unique:!0},machineId:{type:t.INTEGER,allowNull:!1},currentSiteId:{type:t.INTEGER,allowNull:!1},destinationSiteId:{type:t.INTEGER,allowNull:!0},requestType:{type:t.ENUM("Site Transfer","Sell Machine","Scrap Machine"),defaultValue:"Site Transfer"},status:{type:t.ENUM("Pending","Approved","Dispatched","Received","Rejected"),defaultValue:"Pending"},vehicleType:{type:t.ENUM("self_carrying","other_carrying"),allowNull:!0,defaultValue:"other_carrying"},selfCarryingVehicle:{type:t.BOOLEAN,defaultValue:!1},reason:t.STRING,requestedBy:t.INTEGER,approvedBy:t.INTEGER,rejectedBy:t.INTEGER,dispatchedBy:t.INTEGER,receivedBy:t.INTEGER,requestedAt:t.DATE,approvedAt:t.DATE,dispatchedAt:t.DATE,receivedAt:t.DATE,rejectedAt:t.DATE,transportDetails:t.JSON,scrapDetails:t.JSON,buyerDetails:t.JSON,itemsIncluded:t.JSON,itemsReceived:t.JSON,odometerReading:t.STRING,fuelGaugeReading:t.STRING,hrsMeter:t.STRING,dispatchRemarks:t.STRING,approveRemarks:t.STRING,rejectionRemarks:{type:t.STRING},finalRemarks:{type:t.STRING},files:{type:t.JSON}},{tableName:"machine_transfers",timestamps:!0,paranoid:!0,hooks:{afterCreate:async(e,t)=>{let a="MT";switch(e.requestType){case"Sell Machine":a="MT-SL";break;case"Scrap Machine":a="MT-SCR";break;default:a="MT-TR"}const i=`${a}-${String(e.id).padStart(4,"0")}`;await e.update({name:i},{transaction:t.transaction})}}});return a.associate=e=>{a.belongsTo(e.Site,{foreignKey:"currentSiteId",as:"currentSite"}),a.belongsTo(e.Site,{foreignKey:"destinationSiteId",as:"destinationSite"}),a.belongsTo(e.Machinery,{foreignKey:"machineId",as:"machine"}),a.belongsTo(e.User,{foreignKey:"requestedBy",as:"requester"}),a.belongsTo(e.User,{foreignKey:"approvedBy",as:"approver"}),a.belongsTo(e.User,{foreignKey:"dispatchedBy",as:"dispatcher"}),a.belongsTo(e.User,{foreignKey:"receivedBy",as:"receiver"}),a.belongsTo(e.User,{foreignKey:"rejectedBy",as:"rejecter"})},a}},1103:e=>{e.exports=(e,t)=>{const a=e.define("Machinery",{id:{type:t.INTEGER,primaryKey:!0,autoIncrement:!0},primaryCategoryId:{type:t.INTEGER,allowNull:!0},machineCategoryId:{type:t.INTEGER,allowNull:!0},erpCode:{type:t.STRING,allowNull:!0,unique:!0},registrationNumber:{type:t.STRING,allowNull:!0,unique:!0},machineNumber:{type:t.STRING,allowNull:!0,unique:!0},machineCode:{type:t.STRING,allowNull:!0,unique:!0},chassisNumber:{type:t.STRING,allowNull:!0,unique:!0},engineNumber:{type:t.STRING,allowNull:!0,unique:!0},serialNumber:{type:t.STRING,allowNull:!0,unique:!0},model:{type:t.STRING,allowNull:!0},make:{type:t.STRING,allowNull:!0},yom:{type:t.INTEGER,allowNull:!0},purchaseDate:{type:t.DATE,allowNull:!0},capacity:{type:t.STRING,allowNull:!0},ownerName:{type:t.STRING,allowNull:!0},ownerType:{type:t.STRING,allowNull:!0},siteId:{type:t.INTEGER,allowNull:!0},isActive:{type:t.BOOLEAN,defaultValue:!0},machineName:{type:t.STRING,allowNull:!0},fitnessCertificateExpiry:{type:t.DATE,allowNull:!0},motorVehicleTaxDue:{type:t.DATE,allowNull:!0},permitExpiryDate:{type:t.DATE,allowNull:!0},nationalPermitExpiry:{type:t.DATE,allowNull:!0},insuranceExpiry:{type:t.DATE,allowNull:!0},pollutionCertificateExpiry:{type:t.DATE,allowNull:!0},fitnessCertificateFile:{type:t.STRING,allowNull:!0},pollutionCertificateFile:{type:t.STRING,allowNull:!0},insuranceFile:{type:t.STRING,allowNull:!0},permitFile:{type:t.STRING,allowNull:!0},nationalPermitFile:{type:t.STRING,allowNull:!0},motorVehicleTaxFile:{type:t.STRING,allowNull:!0},machineImageFile:{type:t.STRING,allowNull:!0},status:{type:t.ENUM("Idle","In Use","In Transfer","Sold","Scrap"),allowNull:!0,defaultValue:"Idle"},totalHoursRun:{type:t.FLOAT,allowNull:!0},totalKmRun:{type:t.FLOAT,allowNull:!0},lastServiceDate:{type:t.DATE,allowNull:!0},lastServiceAtkm:{type:t.FLOAT,allowNull:!0},lastServiceAtHours:{type:t.FLOAT,allowNull:!0}},{tableName:"machineries",timestamps:!0,paranoid:!0,hooks:{afterCreate:async(e,t)=>{const a=`ERP-${String(e.id).padStart(4,"0")}`;await e.update({erpCode:a},{transaction:t.transaction})}}});return a.associate=e=>{a.belongsTo(e.PrimaryCategory,{foreignKey:"primaryCategoryId",as:"primaryCategory"}),a.belongsTo(e.MachineCategory,{foreignKey:"machineCategoryId",as:"machineCategory"}),a.belongsTo(e.Site,{foreignKey:"siteId",as:"site"}),a.hasMany(e.LogbookEntry,{foreignKey:"machineId",as:"logbookEntries"})},a}},4441:e=>{e.exports=(e,t)=>e.define("MachineryItemCode",{id:{type:t.INTEGER,primaryKey:!0,autoIncrement:!0},code:{type:t.STRING,allowNull:!1},name:{type:t.STRING,allowNull:!1},remarks:{type:t.TEXT,allowNull:!0}},{tableName:"machinery_item_codes",timestamps:!0,paranoid:!0})},5832:e=>{e.exports=(e,t)=>{const a=e.define("MaintenanceLog",{id:{type:t.INTEGER,autoIncrement:!0,primaryKey:!0},machineId:{type:t.INTEGER,allowNull:!1},type:{type:t.STRING,allowNull:!0},date:{type:t.DATE,allowNull:!0},title:{type:t.STRING,allowNull:!0},description:{type:t.TEXT,allowNull:!0},parts:{type:t.TEXT,allowNull:!0},cost:{type:t.DECIMAL(10,2),allowNull:!0},technician:{type:t.STRING,allowNull:!0},status:{type:t.ENUM("completed","in_progress","scheduled","overdue","due_today"),allowNull:!1},hoursAtService:{type:t.INTEGER,allowNull:!0},kilometersAtService:{type:t.INTEGER,allowNull:!0},vendorAndPartsDetails:{type:t.JSONB,allowNull:!0},dueDate:{type:t.DATE,allowNull:!0},estimatedHours:{type:t.FLOAT,allowNull:!0},estimatedCost:{type:t.DECIMAL(10,2),allowNull:!0},priority:{type:t.ENUM("low","medium","high"),allowNull:!0,defaultValue:"medium"},assignedTo:{type:t.STRING,allowNull:!0},lastAlertDate:{type:t.DATE,allowNull:!0}},{tableName:"maintenance_logs",timestamps:!0});return a.associate=e=>{a.belongsTo(e.Machinery,{foreignKey:"machineId",as:"machine"})},a}},6215:e=>{e.exports=(e,t)=>{const a=e.define("MaterialIssue",{id:{type:t.INTEGER,primaryKey:!0,autoIncrement:!0},issueNumber:{type:t.STRING,unique:!0},issueDate:{type:t.DATE,defaultValue:t.NOW},issueType:{type:t.ENUM("Consumption","Site Transfer"),allowNull:!1},status:{type:t.STRING,defaultValue:"Pending"},siteId:{type:t.INTEGER,allowNull:!0},otherSiteId:{type:t.INTEGER,allowNull:!0},requisitionId:{type:t.INTEGER,allowNull:!0},approvedById:{type:t.INTEGER,allowNull:!0},approvedAt:{type:t.DATE,allowNull:!0},issuedById:{type:t.INTEGER,allowNull:!0},issuedAt:{type:t.DATE,allowNull:!0},consumedById:{type:t.INTEGER,allowNull:!0},consumedAt:{type:t.DATE,allowNull:!0},dispatchedById:{type:t.INTEGER,allowNull:!0},dispatchedAt:{type:t.DATE,allowNull:!0},receivedById:{type:t.INTEGER,allowNull:!0},receivedAt:{type:t.DATE,allowNull:!0},rejectedById:{type:t.INTEGER,allowNull:!0},rejectedAt:{type:t.DATE,allowNull:!0},rejectionReason:{type:t.STRING,allowNull:!0}},{tableName:"material_issues",timestamps:!0,hooks:{afterCreate:async(e,t)=>{const a=`ISS-${String(e.id).padStart(3,"0")}`;await e.update({issueNumber:a},{transaction:t.transaction})}}});return a.associate=e=>{a.hasMany(e.MaterialIssueItem,{foreignKey:"materialIssueId",as:"items"}),a.belongsTo(e.Site,{foreignKey:"siteId",as:"fromSite"}),a.belongsTo(e.Site,{foreignKey:"otherSiteId",as:"toSite"}),a.belongsTo(e.Requisition,{foreignKey:"requisitionId",as:"requisition"}),a.belongsTo(e.User,{foreignKey:"issuedById",as:"issuedBy"}),a.belongsTo(e.User,{foreignKey:"approvedById",as:"approvedBy"}),a.belongsTo(e.User,{foreignKey:"dispatchedById",as:"dispatchedBy"}),a.belongsTo(e.User,{foreignKey:"receivedById",as:"receivedBy"}),a.belongsTo(e.User,{foreignKey:"rejectedById",as:"rejectedBy"}),a.belongsTo(e.User,{foreignKey:"consumedById",as:"consumedBy"})},a}},1468:e=>{e.exports=(e,t)=>{const a=e.define("MaterialIssueItem",{id:{type:t.INTEGER,primaryKey:!0,autoIncrement:!0},materialIssueId:{type:t.INTEGER,allowNull:!1},itemId:{type:t.INTEGER,allowNull:!1},quantity:{type:t.FLOAT,allowNull:!1},issueTo:{type:t.STRING,allowNull:!0},siteId:{type:t.INTEGER,allowNull:!1},otherSiteId:{type:t.INTEGER,allowNull:!0},machineId:{type:t.INTEGER,allowNull:!0}},{tableName:"material_issue_items",timestamps:!1});return a.associate=e=>{a.belongsTo(e.Item,{foreignKey:"itemId"}),a.belongsTo(e.MaterialIssue,{foreignKey:"materialIssueId"}),a.belongsTo(e.Site,{foreignKey:"siteId",as:"fromSite"}),a.belongsTo(e.Site,{foreignKey:"otherSiteId",as:"toSite"}),a.belongsTo(e.Machinery,{foreignKey:"machineId",as:"machine"})},a}},6800:e=>{e.exports=(e,t)=>{const a=e.define("Notification",{id:{type:t.INTEGER,primaryKey:!0,autoIncrement:!0},eventType:{type:t.ENUM("MachineTransfer","MachineScrap","MachineSold","MaterialRequisition","MaterialIssue","LowStock","DocumentExpiry","MaintenanceAlert","MachineMaintenanceAlert","LogbookEntry"),allowNull:!1},eventAction:{type:t.STRING,allowNull:!1},referenceId:{type:t.INTEGER,allowNull:!1},siteId:{type:t.INTEGER,allowNull:!0},title:{type:t.STRING,allowNull:!0},description:{type:t.TEXT},isRead:{type:t.BOOLEAN,defaultValue:!1},createdBy:{type:t.INTEGER,allowNull:!0}},{tableName:"notifications",timestamps:!0,paranoid:!0});return a.associate=e=>{a.belongsTo(e.User,{foreignKey:"createdBy",as:"creator"}),a.belongsTo(e.Site,{foreignKey:"siteId",as:"site"}),a.belongsToMany(e.Role,{through:e.NotificationRole,foreignKey:"notificationId"}),a.belongsToMany(e.User,{through:e.NotificationReadStatus,foreignKey:"notificationId"}),a.hasMany(e.NotificationReadStatus,{foreignKey:"notificationId",as:"readStatuses"})},a}},8778:e=>{e.exports=(e,t)=>{const a=e.define("NotificationReadStatus",{id:{type:t.INTEGER,autoIncrement:!0,primaryKey:!0},userId:{type:t.INTEGER,allowNull:!1},notificationId:{type:t.INTEGER,allowNull:!1},isRead:{type:t.BOOLEAN,defaultValue:!1},readAt:{type:t.DATE,allowNull:!0}},{tableName:"notification_read_status",timestamps:!0});return a.associate=e=>{a.belongsTo(e.Notification,{foreignKey:"notificationId",as:"notification"}),a.belongsTo(e.User,{foreignKey:"userId",as:"user"})},a}},7460:e=>{e.exports=(e,t)=>e.define("NotificationRole",{},{tableName:"notification_roles",timestamps:!1})},2477:e=>{e.exports=(e,t)=>{const a=e.define("Payment",{paymentDate:{type:t.DATE,allowNull:!1},amount:{type:t.DECIMAL(12,2),allowNull:!1},paymentMethod:{type:t.ENUM("CASH","CHEQUE","BANK_TRANSFER","ONLINE_PAYMENT","OTHER"),allowNull:!1},referenceNumber:t.STRING,slipUrl:t.STRING,status:{type:t.ENUM("PENDING","COMPLETED","FAILED"),defaultValue:"PENDING"},remarks:t.TEXT});return a.associate=e=>{a.belongsTo(e.Invoice,{foreignKey:"invoiceId",as:"invoice"})},a}},2709:e=>{e.exports=(e,t)=>{const a=e.define("PrimaryCategory",{id:{type:t.INTEGER,primaryKey:!0,autoIncrement:!0},name:{type:t.STRING,allowNull:!1,unique:!0}},{tableName:"primary_categories",timestamps:!0});return a.associate=e=>{a.hasMany(e.MachineCategory,{foreignKey:"primaryCategoryId",as:"machineCategories",onDelete:"CASCADE"}),a.hasMany(e.Machinery,{foreignKey:"primaryCategoryId",as:"machineries",onDelete:"CASCADE"})},a}},5213:e=>{e.exports=(e,t)=>{const a=e.define("Procurement",{procurementNo:{type:t.STRING},requisitionId:{type:t.INTEGER,allowNull:!1},vendorId:{type:t.INTEGER,allowNull:!1},expectedDelivery:{type:t.DATE},notes:{type:t.TEXT},status:{type:t.ENUM("pending","ordered","accepted_at_virtual_site","in_transit_to_requested_site","delivered","paid"),defaultValue:"pending"},totalAmount:{type:t.DECIMAL(10,2)},quotationComparisonId:{type:t.INTEGER,allowNull:!0}},{tableName:"procurements",timestamps:!0});return a.associate=e=>{a.belongsTo(e.Requisition,{foreignKey:"requisitionId"}),a.belongsTo(e.Vendor,{foreignKey:"vendorId"}),a.belongsTo(e.QuotationComparison,{foreignKey:"quotationComparisonId",as:"quotationComparison"}),a.hasMany(e.ProcurementItem,{foreignKey:"procurementId"}),a.hasMany(e.Invoice,{foreignKey:"procurementId",as:"invoices"}),a.hasMany(e.Dispatch,{foreignKey:"procurementId"})},a}},7090:e=>{e.exports=(e,t)=>{const a=e.define("ProcurementItem",{procurementId:{type:t.INTEGER},requisitionItemId:{type:t.INTEGER},itemId:{type:t.INTEGER},quantity:{type:t.INTEGER},rate:{type:t.DECIMAL(10,2)},amount:{type:t.DECIMAL(10,2)},receivedQuantity:{type:t.INTEGER,defaultValue:0}},{tableName:"procurement_items",timestamps:!0});return a.associate=e=>{a.belongsTo(e.Procurement,{foreignKey:"procurementId"}),a.belongsTo(e.RequisitionItem,{foreignKey:"requisitionItemId"}),a.belongsTo(e.Item,{foreignKey:"itemId"}),a.hasMany(e.InvoiceItem,{foreignKey:"procurementItemId"})},a}},3452:e=>{e.exports=(e,t)=>{const a=e.define("QuotationComparison",{id:{type:t.INTEGER,primaryKey:!0,autoIncrement:!0},requisitionId:{type:t.INTEGER,allowNull:!1,references:{model:"requisitions",key:"id"}},comparisonNo:{type:t.STRING,unique:!0},status:{type:t.STRING,defaultValue:"draft"},submittedById:{type:t.INTEGER,allowNull:!0},submittedAt:{type:t.DATE,allowNull:!0},approvedById:{type:t.INTEGER,allowNull:!0},approvedAt:{type:t.DATE,allowNull:!0},remarks:{type:t.TEXT,allowNull:!0},submissionRemarks:{type:t.TEXT,allowNull:!0},approvalRemarks:{type:t.TEXT,allowNull:!0},lockRemarks:{type:t.TEXT,allowNull:!0},totalAmount:{type:t.DECIMAL(15,2),defaultValue:0}},{tableName:"quotation_comparisons",timestamps:!0,hooks:{afterCreate:async(e,t)=>{const a=`QC-${String(e.id).padStart(4,"0")}`;await e.update({comparisonNo:a},{transaction:t.transaction})}}});return a.associate=e=>{a.belongsTo(e.Requisition,{foreignKey:"requisitionId",as:"requisition"}),a.belongsTo(e.User,{foreignKey:"submittedById",as:"submittedBy"}),a.belongsTo(e.User,{foreignKey:"approvedById",as:"approvedBy"}),a.hasMany(e.QuotationComparisonItem,{foreignKey:"comparisonId",as:"items"}),a.hasMany(e.QuotationComparisonVendor,{foreignKey:"comparisonId",as:"vendors"}),a.hasMany(e.QuotationComparisonVersion,{foreignKey:"comparisonId",as:"versions"})},a}},2319:e=>{e.exports=(e,t)=>{const a=e.define("QuotationComparisonItem",{id:{type:t.INTEGER,primaryKey:!0,autoIncrement:!0},comparisonId:{type:t.INTEGER,allowNull:!1,references:{model:"quotation_comparisons",key:"id"}},requisitionItemId:{type:t.INTEGER,allowNull:!1,references:{model:"requisition_items",key:"id"}},itemId:{type:t.INTEGER,allowNull:!1,references:{model:"items",key:"id"}},description:{type:t.STRING,allowNull:!1},unit:{type:t.STRING,allowNull:!1},quantity:{type:t.INTEGER,allowNull:!1},selectedVendorId:{type:t.INTEGER,allowNull:!0},selected:{type:t.BOOLEAN,defaultValue:!1}},{tableName:"quotation_comparison_items",timestamps:!0});return a.associate=e=>{a.belongsTo(e.QuotationComparison,{foreignKey:"comparisonId",as:"comparison"}),a.belongsTo(e.RequisitionItem,{foreignKey:"requisitionItemId",as:"requisitionItem"}),a.belongsTo(e.Item,{foreignKey:"itemId",as:"item"}),a.belongsTo(e.Vendor,{foreignKey:"selectedVendorId",as:"selectedVendor"}),a.hasMany(e.QuotationComparisonRate,{foreignKey:"comparisonItemId",as:"rates"})},a}},7078:e=>{e.exports=(e,t)=>{const a=e.define("QuotationComparisonRate",{id:{type:t.INTEGER,primaryKey:!0,autoIncrement:!0},comparisonItemId:{type:t.INTEGER,allowNull:!1,references:{model:"quotation_comparison_items",key:"id"}},vendorId:{type:t.INTEGER,allowNull:!1,references:{model:"vendors",key:"id"}},rate:{type:t.DECIMAL(10,2),allowNull:!1,defaultValue:0},amount:{type:t.DECIMAL(15,2),allowNull:!1,defaultValue:0},remarks:{type:t.TEXT,allowNull:!0},isLowest:{type:t.BOOLEAN,defaultValue:!1}},{tableName:"quotation_comparison_rates",timestamps:!0});return a.associate=e=>{a.belongsTo(e.QuotationComparisonItem,{foreignKey:"comparisonItemId",as:"comparisonItem"}),a.belongsTo(e.Vendor,{foreignKey:"vendorId",as:"vendor"})},a}},7710:e=>{e.exports=(e,t)=>{const a=e.define("QuotationComparisonVendor",{id:{type:t.INTEGER,primaryKey:!0,autoIncrement:!0},comparisonId:{type:t.INTEGER,allowNull:!1,references:{model:"quotation_comparisons",key:"id"}},vendorId:{type:t.INTEGER,allowNull:!1,references:{model:"vendors",key:"id"}},vendorName:{type:t.STRING,allowNull:!1},totalAmount:{type:t.DECIMAL(15,2),defaultValue:0},status:{type:t.STRING,defaultValue:"active"},attachmentFilePath:{type:t.STRING,allowNull:!0},attachmentUploadedAt:{type:t.DATE,allowNull:!0},attachmentUploadedById:{type:t.INTEGER,allowNull:!0,references:{model:"users",key:"id"}}},{tableName:"quotation_comparison_vendors",timestamps:!0});return a.associate=e=>{a.belongsTo(e.QuotationComparison,{foreignKey:"comparisonId",as:"comparison"}),a.belongsTo(e.Vendor,{foreignKey:"vendorId",as:"vendor"}),a.hasMany(e.QuotationComparisonRate,{foreignKey:"vendorId",as:"rates"}),a.belongsTo(e.User,{foreignKey:"attachmentUploadedById",as:"attachmentUploadedBy"})},a}},4690:e=>{e.exports=(e,t)=>{const a=e.define("QuotationComparisonVersion",{id:{type:t.INTEGER,primaryKey:!0,autoIncrement:!0},comparisonId:{type:t.INTEGER,allowNull:!1,references:{model:"quotation_comparisons",key:"id"}},versionNumber:{type:t.INTEGER,allowNull:!1},changes:{type:t.TEXT,allowNull:!0},changedById:{type:t.INTEGER,allowNull:!0},changedAt:{type:t.DATE,defaultValue:t.NOW},status:{type:t.STRING,defaultValue:"active"}},{tableName:"quotation_comparison_versions",timestamps:!1});return a.associate=e=>{a.belongsTo(e.QuotationComparison,{foreignKey:"comparisonId",as:"comparison"}),a.belongsTo(e.User,{foreignKey:"changedById",as:"changedBy"})},a}},4299:e=>{e.exports=(e,t)=>{const a=e.define("Requisition",{id:{type:t.INTEGER,primaryKey:!0,autoIncrement:!0},requisitionNo:{type:t.STRING,unique:!0},requestedAt:{type:t.DATE,defaultValue:t.NOW},requestingSiteId:{type:t.INTEGER,allowNull:!1},requestedFor:{type:t.STRING},chargeType:{type:t.STRING},requestPriority:{type:t.STRING},dueDate:{type:t.DATE},preparedById:{type:t.INTEGER,allowNull:!0},status:{type:t.STRING,defaultValue:"pending"},approvedById:{type:t.INTEGER,allowNull:!0},approvedAt:{type:t.DATE,allowNull:!0},completedById:{type:t.INTEGER,allowNull:!0},completedAt:{type:t.DATE,allowNull:!0},rejectedById:{type:t.INTEGER,allowNull:!0},rejectedAt:{type:t.DATE,allowNull:!0},rejectionReason:{type:t.TEXT,allowNull:!0},approvedByPM:{type:t.INTEGER,allowNull:!0},approvedAtPM:{type:t.DATE,allowNull:!0},approvedByHO:{type:t.INTEGER,allowNull:!0},approvedAtHO:{type:t.DATE,allowNull:!0}},{tableName:"requisitions",timestamps:!0,hooks:{afterCreate:async(e,t)=>{const a=`REQ-${String(e.id).padStart(4,"0")}`;await e.update({requisitionNo:a},{transaction:t.transaction})}}});return a.associate=e=>{a.hasMany(e.RequisitionItem,{foreignKey:"requisitionId",as:"items"}),a.belongsTo(e.User,{foreignKey:"preparedById",as:"preparedBy"}),a.belongsTo(e.User,{foreignKey:"approvedById",as:"approvedBy"}),a.belongsTo(e.User,{foreignKey:"completedById",as:"completedBy"}),a.belongsTo(e.User,{foreignKey:"rejectedById",as:"rejectedBy"}),a.belongsTo(e.User,{foreignKey:"approvedByPM",as:"approvedByPMUser"}),a.belongsTo(e.User,{foreignKey:"approvedByHO",as:"approvedByHOUser"}),a.belongsTo(e.Site,{foreignKey:"requestingSiteId",as:"requestingSite"}),a.hasMany(e.MaterialIssue,{foreignKey:"requisitionId",as:"materialIssues"}),a.hasMany(e.Procurement,{foreignKey:"requisitionId",as:"procurements"}),a.hasMany(e.RequisitionSiteRejection,{foreignKey:"requisitionId",as:"siteRejections"})},a}},3992:e=>{e.exports=(e,t)=>{const a=e.define("RequisitionItem",{id:{type:t.INTEGER,primaryKey:!0,autoIncrement:!0},requisitionId:{type:t.INTEGER,allowNull:!1},itemId:{type:t.INTEGER,allowNull:!1},quantity:{type:t.INTEGER,allowNull:!1}},{tableName:"requisition_items"});return a.associate=e=>{a.belongsTo(e.Requisition,{foreignKey:"requisitionId"}),a.belongsTo(e.Item,{foreignKey:"itemId"})},a}},6989:e=>{e.exports=(e,t)=>{const a=e.define("RequisitionSiteRejection",{id:{type:t.INTEGER,primaryKey:!0,autoIncrement:!0},requisitionId:{type:t.INTEGER,allowNull:!1},siteId:{type:t.INTEGER,allowNull:!1},rejectedById:{type:t.INTEGER,allowNull:!1},rejectionReason:{type:t.TEXT,allowNull:!1},rejectedAt:{type:t.DATE,defaultValue:t.NOW}},{tableName:"requisition_site_rejections",timestamps:!0,underscored:!0});return a.associate=e=>{a.belongsTo(e.Requisition,{foreignKey:"requisitionId",as:"requisition"}),a.belongsTo(e.Site,{foreignKey:"siteId",as:"site"}),a.belongsTo(e.User,{foreignKey:"rejectedById",as:"rejectedBy"})},a}},6003:e=>{e.exports=(e,t)=>{const a=e.define("Role",{id:{type:t.INTEGER,primaryKey:!0,autoIncrement:!0},name:{type:t.STRING,allowNull:!1}},{tableName:"roles",timestamps:!0,paranoid:!0});return a.associate=e=>{a.belongsTo(e.Department,{foreignKey:"departmentId"}),a.hasMany(e.User,{foreignKey:"id"}),a.belongsToMany(e.Notification,{through:e.NotificationRole,foreignKey:"roleId"})},a}},8516:e=>{e.exports=(e,t)=>{const a=e.define("Site",{id:{type:t.INTEGER,primaryKey:!0,autoIncrement:!0},name:{type:t.STRING,allowNull:!1},type:{type:t.ENUM("virtual","physical"),defaultValue:"physical",allowNull:!1},code:{type:t.STRING,allowNull:!0,unique:!0},address:{type:t.STRING,allowNull:!1},pincode:{type:t.STRING,allowNull:!0},mobileNumber:{type:t.STRING,allowNull:!0},departmentId:{type:t.INTEGER,allowNull:!1},status:{type:t.ENUM("active","closed","paused"),allowNull:!1,defaultValue:"active"}},{tableName:"sites",timestamps:!0,paranoid:!0,hooks:{afterCreate:async(e,t)=>{const a=`SITE-${String(e.id).padStart(3,"0")}`;await e.update({code:a},{transaction:t.transaction})}}});return a.associate=e=>{a.belongsTo(e.Department,{foreignKey:"departmentId"}),a.hasMany(e.User,{foreignKey:"siteId"}),a.hasMany(e.Machinery,{foreignKey:"siteId"})},a}},8362:e=>{e.exports=(e,t)=>{const a=e.define("SiteInventory",{siteId:{type:t.INTEGER,allowNull:!1},itemId:{type:t.INTEGER,allowNull:!1},quantity:{type:t.FLOAT,allowNull:!1,defaultValue:0},minimumLevel:{type:t.FLOAT,allowNull:!1,defaultValue:0},status:{type:t.ENUM("In Stock","Out of Stock","Low Stock"),allowNull:!1,defaultValue:"In Stock"},lockedQuantity:{type:t.FLOAT,allowNull:!1,defaultValue:0}},{tableName:"site_inventories",timestamps:!0});return a.associate=e=>{a.belongsTo(e.Site,{foreignKey:"siteId"}),a.belongsTo(e.Item,{foreignKey:"itemId"})},a}},3999:e=>{e.exports=(e,t)=>{const a=e.define("StockLog",{siteId:{type:t.INTEGER,allowNull:!1},itemId:{type:t.INTEGER,allowNull:!1},change:{type:t.FLOAT,allowNull:!1},type:{type:t.ENUM("IN","OUT"),allowNull:!1},sourceType:{type:t.STRING},sourceId:{type:t.INTEGER},userId:{type:t.INTEGER,allowNull:!0}},{tableName:"stock_logs",timestamps:!0});return a.associate=e=>{a.belongsTo(e.Site,{foreignKey:"siteId"}),a.belongsTo(e.Item,{foreignKey:"itemId"}),a.belongsTo(e.User,{foreignKey:"userId"})},a}},6109:e=>{e.exports=(e,t)=>{const a=e.define("Unit",{id:{type:t.INTEGER,autoIncrement:!0,allowNull:!1,primaryKey:!0},name:{type:t.STRING,allowNull:!1},shortName:{type:t.STRING,allowNull:!1},decimalPlaces:{type:t.INTEGER,allowNull:!0}},{tableName:"units",timestamps:!1});return a.associate=e=>{a.hasMany(e.Item,{foreignKey:"unitId"})},a}},5596:(e,t,a)=>{const i=a(4729);e.exports=(e,t)=>{const a=e.define("User",{id:{type:t.INTEGER,primaryKey:!0,autoIncrement:!0},name:{type:t.STRING,allowNull:!1},code:{type:t.STRING,allowNull:!0},email:{type:t.STRING,allowNull:!1,unique:!0},phone:{type:t.STRING,allowNull:!1},imageUrl:{type:t.STRING,allowNull:!0},password:{type:t.STRING,allowNull:!1,set(e){this.setDataValue("password",i.hashSync(e,i.genSaltSync(10)))}},roleId:{type:t.INTEGER,allowNull:!0},departmentId:{type:t.INTEGER,allowNull:!0},siteId:{type:t.INTEGER,allowNull:!0},status:{type:t.ENUM("active","inactive","archived"),allowNull:!1,defaultValue:"active"}},{tableName:"users",timestamps:!0,paranoid:!0,hooks:{afterCreate:async(e,t)=>{const a=`EMP-${String(e.id).padStart(3,"0")}`;await e.update({code:a},{transaction:t.transaction})}}});return a.prototype.validPassword=async function(e){try{return await i.compare(e,this.password)}catch(e){return!1}},a.hashPassword=function(e){return i.hashSync(e,i.genSaltSync(10))},a.associate=e=>{a.belongsTo(e.Role,{foreignKey:"roleId"}),a.belongsTo(e.Department,{foreignKey:"departmentId"}),a.belongsTo(e.Site,{foreignKey:"siteId"}),a.belongsToMany(e.Notification,{through:e.NotificationReadStatus,foreignKey:"userId"})},a}},4197:e=>{e.exports=(e,t)=>{const a=e.define("Vendor",{id:{type:t.INTEGER,primaryKey:!0,autoIncrement:!0},name:{type:t.STRING},email:{type:t.STRING},contactPerson:{type:t.STRING},phone:{type:t.STRING},address:{type:t.TEXT}},{tableName:"vendors",timestamps:!0});return a.associate=e=>{a.hasMany(e.Procurement,{foreignKey:"vendorId"})},a}},9239:(e,t,a)=>{"use strict";const i=a(9896),n=a(6928),r=a(9031),{sequelizeJoi:s,Joi:o}=a(7660),d=a(932),c=n.basename(__filename),l=d.env.NODE_ENV||"dev";a(818).config();const u=a(5298)[l],m={};let p;if(p=u?.use_env_variable?new r(d.env[u.use_env_variable],u):new r({database:d.env.DB_NAME,username:d.env.DB_USERNAME,password:d.env.DB_PASSWORD,host:d.env.DB_HOST,port:d.env.DB_PORT,dialect:d.env.DB_DIALECT,dialectOptions:{ssl:{require:!0,rejectUnauthorized:!1}},logging:!1}),s(p),"dev"===l)i.readdirSync(__dirname).filter((e=>0!==e.indexOf(".")&&e!==c&&".js"===e.slice(-3)&&-1===e.indexOf(".test.js"))).forEach((e=>{const t=a(1537)(n.join(__dirname,e))(p,r.DataTypes,o);m[t.name]=t}));else{const e=a(2979);e.keys().forEach((t=>{if("./index.js"!==t&&".test.js"!==t.slice(-8)){const a=e(t)(p,r.DataTypes,o);m[a.name]=a}}))}Object.keys(m).forEach((e=>{m[e].associate&&m[e].associate(m)})),m.sequelize=p,m.Sequelize=r,e.exports=m},5410:(e,t,a)=>{const i=a(7179);e.exports={getAllItems:async(e,t)=>{const a=await i.getAllItems();t.sendResponse(a,"All items fetched successfully")},getItemById:async(e,t)=>{const a=await i.getItemById(e.params.id);t.sendResponse(a,"Item fetched successfully")},createItem:async(e,t)=>{const a=await i.createItem(e.body);t.sendResponse(a,"Item created successfully")},updateItem:async(e,t)=>{const a=await i.updateItem(e.params.id,e.body);t.sendResponse(a,"Item updated successfully")},deleteItem:async(e,t)=>{await i.deleteItem(e.params.id),t.sendResponse(null,"Item deleted successfully")}}},9796:(e,t,a)=>{const i=a(7252).Router(),n=a(7434),r=a(5410),s=a(4081),{createItemSchema:o,updateItemSchema:d}=a(8282);i.get("/items",n(r.getAllItems)),i.get("/items/:id",n(r.getItemById)),i.post("/items",s(o),n(r.createItem)),i.put("/items/:id",s(d),n(r.updateItem)),i.delete("/items/:id",n(r.deleteItem)),e.exports=i},7179:(e,t,a)=>{const{Op:i}=a(9031),n=a(9239);e.exports={getAllItems:async()=>await n.Item.findAll({include:[{model:n.ItemGroup},{model:n.Unit}]}),getItemById:async e=>await n.Item.findByPk(e,{include:[{model:n.ItemGroup},{model:n.Unit}]}),createItem:async e=>await n.Item.create(e),updateItem:async(e,t)=>{const a=await n.Item.findByPk(e);if(!a)throw new Error("Item not found");return await a.update(t)},deleteItem:async e=>{const t=await n.Item.findByPk(e);if(!t)throw new Error("Item not found");await t.destroy()},getAllItemsV2:async({page:e=1,limit:t=10,orderBy:a="name",orderDirection:r="ASC",search:s="",filters:o={}})=>{const d=(e-1)*t,c={...o,...s&&{[i.or]:[{name:{[i.iLike]:`%${s}%`}},{shortName:{[i.iLike]:`%${s}%`}},{partNumber:{[i.iLike]:`%${s}%`}},{hsnCode:{[i.iLike]:`%${s}%`}}]}},{count:l,rows:u}=await n.Item.findAndCountAll({where:c,include:[{model:n.ItemGroup},{model:n.Unit}],order:[[a,r]],limit:t,offset:d});return{data:u,currentPage:e,totalPages:Math.ceil(l/t),totalCount:l}}}},8282:(e,t,a)=>{const i=a(2446),n=i.object({name:i.string().min(2).max(100).required(),shortName:i.string().allow(null,"").max(50),partNumber:i.string().allow(null,"").max(50),hsnCode:i.string().allow(null,"").max(50),itemGroupId:i.number().integer().positive().required(),unitId:i.number().integer().positive().required()}),r=n;e.exports={createItemSchema:n,updateItemSchema:r}},6298:(e,t,a)=>{const i=a(4195);e.exports={getAllItemGroups:async(e,t)=>{const a=await i.getAllItemGroups();t.sendResponse(a,"All item groups fetched successfully")},getItemGroupById:async(e,t)=>{const a=await i.getItemGroupById(e.params.id);t.sendResponse(a,"Item group fetched successfully")},createItemGroup:async(e,t)=>{const a=await i.createItemGroup(e.body);t.sendResponse(a,"Item group created successfully")},updateItemGroup:async(e,t)=>{const a=await i.updateItemGroup(e.params.id,e.body);t.sendResponse(a,"Item group updated successfully")},deleteItemGroup:async(e,t)=>{await i.deleteItemGroup(e.params.id),t.sendResponse(null,"Item group deleted successfully")}}},6860:(e,t,a)=>{const i=a(7252).Router(),n=a(7434),r=a(6298),s=a(4081),{createItemGroupSchema:o,updateItemGroupSchema:d}=a(4482);i.get("/item-groups",n(r.getAllItemGroups)),i.get("/item-groups/:id",n(r.getItemGroupById)),i.post("/item-groups",s(o),n(r.createItemGroup)),i.put("/item-groups/:id",s(d),n(r.updateItemGroup)),i.delete("/item-groups/:id",n(r.deleteItemGroup)),e.exports=i},4195:(e,t,a)=>{const{Op:i}=a(9031),n=a(9239);e.exports={getAllItemGroups:async()=>await n.ItemGroup.findAll({include:[{model:n.Item}]}),getItemGroupById:async e=>await n.ItemGroup.findByPk(e,{include:[{model:n.Item}]}),createItemGroup:async e=>await n.ItemGroup.create(e),updateItemGroup:async(e,t)=>{const a=await n.ItemGroup.findByPk(e);if(!a)throw new Error("Item group not found");return await a.update(t)},deleteItemGroup:async e=>{const t=await n.ItemGroup.findByPk(e);if(!t)throw new Error("Item group not found");await t.destroy()},getAllItemGroupsV2:async({page:e=1,limit:t=10,orderBy:a="name",orderDirection:r="ASC",search:s="",filters:o={}})=>{const d=(e-1)*t,c={...o,...s&&{[i.or]:[{name:{[i.iLike]:`%${s}%`}},{shortName:{[i.iLike]:`%${s}%`}},{itemType:{[i.iLike]:`%${s}%`}}]}},{count:l,rows:u}=await n.ItemGroup.findAndCountAll({where:c,include:[{model:n.Item}],order:[[a,r]],limit:t,offset:d});return{data:u,currentPage:e,totalPages:Math.ceil(l/t),totalCount:l}}}},4482:(e,t,a)=>{const i=a(2446),n=i.object({name:i.string().min(2).max(100).required(),shortName:i.string().allow(null,"").max(50),itemType:i.string().allow(null,"").max(50)}),r=n;e.exports={createItemGroupSchema:n,updateItemGroupSchema:r}},7888:(e,t,a)=>{const i=a(837);e.exports={getAllUnits:async(e,t)=>{const a=await i.getAllUnits();t.sendResponse(a,"All units fetched successfully")},getUnitById:async(e,t)=>{const a=await i.getUnitById(e.params.id);t.sendResponse(a,"Unit fetched successfully")},createUnit:async(e,t)=>{const a=await i.createUnit(e.body);t.sendResponse(a,"Unit created successfully")},updateUnit:async(e,t)=>{const a=await i.updateUnit(e.params.id,e.body);t.sendResponse(a,"Unit updated successfully")},deleteUnit:async(e,t)=>{await i.deleteUnit(e.params.id),t.sendResponse(null,"Unit deleted successfully")}}},4310:(e,t,a)=>{const i=a(7252).Router(),n=a(7434),r=a(7888),s=a(4081),{createUnitSchema:o,updateUnitSchema:d}=a(2760);i.get("/units",n(r.getAllUnits)),i.get("/units/:id",n(r.getUnitById)),i.post("/units",s(o),n(r.createUnit)),i.put("/units/:id",s(d),n(r.updateUnit)),i.delete("/units/:id",n(r.deleteUnit)),e.exports=i},837:(e,t,a)=>{const{Op:i}=a(9031),n=a(9239);e.exports={getAllUnits:async()=>await n.Unit.findAll({include:[{model:n.Item}]}),getUnitById:async e=>await n.Unit.findByPk(e,{include:[{model:n.Item}]}),createUnit:async e=>await n.Unit.create(e),updateUnit:async(e,t)=>{const a=await n.Unit.findByPk(e);if(!a)throw new Error("Unit not found");return await a.update(t)},deleteUnit:async e=>{const t=await n.Unit.findByPk(e);if(!t)throw new Error("Unit not found");await t.destroy()},getAllUnitsV2:async({page:e=1,limit:t=10,orderBy:a="name",orderDirection:r="ASC",search:s="",filters:o={}})=>{const d=(e-1)*t,c={...o,...s&&{[i.or]:[{name:{[i.iLike]:`%${s}%`}},{shortName:{[i.iLike]:`%${s}%`}}]}},{count:l,rows:u}=await n.Unit.findAndCountAll({where:c,include:[{model:n.Item}],order:[[a,r]],limit:t,offset:d});return{data:u,currentPage:e,totalPages:Math.ceil(l/t),totalCount:l}}}},2760:(e,t,a)=>{const i=a(2446),n=i.object({name:i.string().min(1).max(50).required(),shortName:i.string().min(1).max(10).required(),decimalPlaces:i.number().integer().min(0).max(5).allow(null)}),r=n;e.exports={createUnitSchema:n,updateUnitSchema:r}},7796:(e,t,a)=>{const i=a(829),n=a(9239);function r(e){const t={id:e.id,roleId:e.roleId,departmentId:e.departmentId,siteId:e.siteId};return i.sign(t,process.env.JWT_SECRET,{expiresIn:"180d"})}e.exports={login:async function(e,t,a){try{const{email:a,password:i}=e.body,s=await n.User.findOne({where:{email:a},include:[{model:n.Role,attributes:["name","id"]},{model:n.Site,attributes:["name","id","address"]},{model:n.Department,attributes:["name","id"]}]});if(!s||!await s.validPassword(i)){const e=new Error;throw e.message="Invalid email or password",e.statusCode=401,e}const o=r(s);t.cookie("token",o,{httpOnly:!1,secure:!0,sameSite:"None",maxAge:15552e6,path:"/"}),t.sendResponse({id:s.id,name:s.name,email:s.email,roleId:s.roleId,role:s.Role,image:s.image,site:s.Site,department:s.Department},"Login successful")}catch(e){a(e)}},logout:async function(e,t){e.cookies.token,t.clearCookie("token",{httpOnly:!1,secure:!0,sameSite:"None"}),t.sendResponse([],"Logout successful")},refreshToken:async function(e,t){const a=e.cookies.token;if(!a)return t.status(401).json({message:"Unauthorized: No refresh token provided"});try{const e=i.verify(a,"process.env.JWT_SECRET"),n=r({id:e.userid,email:e.email,role:e.role});t.cookie("token",n,{httpOnly:!0,secure:!0,sameSite:"None",maxAge:36e5}),t.sendResponse({},"Token refreshed successfully")}catch(e){return t.status(403).json({message:"Forbidden: Invalid refresh token"})}},checkToken:async function(e,t){try{const a=e.cookies.token;if(!a)return t.json({isAuthenticated:!1,token:!1});if(await n.JwtTokenBlacklist.findOne({where:{token:a}}))return t.json({isAuthenticated:!1});i.verify(a,"process.env.JWT_SECRET",((e,a)=>e?t.json({isAuthenticated:!1}):t.json({isAuthenticated:!0})))}catch(e){return t.status(500).json({isAuthenticated:!1})}}}},2402:(e,t,a)=>{const i=a(7252).Router(),n=a(7796),{loginSchema:r}=a(2004),s=a(4081);i.post("/login",s(r),n.login),i.post("/logout",n.logout),e.exports=i},2004:(e,t,a)=>{const i=a(2446),n=i.object({email:i.string().email().required().messages({"string.email":"Please enter a valid email address","any.required":"Email is required"}),password:i.string().min(8).pattern(new RegExp("^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)")).required().messages({"string.empty":"Password cannot be empty","any.required":"Password is required","string.min":"Password must be at least 8 characters long","string.pattern.base":"Password must include at least one uppercase letter, one lowercase letter, one number, and one special character"})});e.exports={loginSchema:n}},4536:(e,t,a)=>{const i=a(5405);e.exports={createPrimaryCategory:async(e,t)=>{const a=await i.createPrimaryCategory(e.body);t.sendResponse(a,"Primary Category created successfully")},getAllPrimaryCategories:async(e,t)=>{const a=await i.getAllPrimaryCategories();t.sendResponse(a,"All Primary Categories fetched successfully")},getPrimaryCategoryById:async(e,t)=>{const a=await i.getPrimaryCategoryById(e.params.id);t.sendResponse(a,"Primary Category fetched successfully")},updatePrimaryCategory:async(e,t)=>{const a=await i.updatePrimaryCategory(e.params.id,e.body);t.sendResponse(a,"Primary Category updated successfully")},deletePrimaryCategory:async(e,t)=>{const a=await i.deletePrimaryCategory(e.params.id);t.sendResponse(null,a.message)},createMachineCategory:async(e,t)=>{const a=await i.createMachineCategory(e.body);t.sendResponse(a,"Machine Category created successfully")},getAllMachineCategories:async(e,t)=>{const a=await i.getAllMachineCategories();t.sendResponse(a,"All Machine Categories fetched successfully")},getMachineCategoryById:async(e,t)=>{const a=await i.getMachineCategoryById(e.params.id);t.sendResponse(a,"Machine Category fetched successfully")},updateMachineCategory:async(e,t)=>{const a=await i.updateMachineCategory(e.params.id,e.body);t.sendResponse(a,"Machine Category updated successfully")},deleteMachineCategory:async(e,t)=>{const a=await i.deleteMachineCategory(e.params.id);t.sendResponse(null,a.message)}}},6878:(e,t,a)=>{const i=a(7252),n=a(4536),r=a(9280),s=a(4081),o=a(7434),d=a(7242),c=i.Router();c.post("/primary",d([1,2,3]),s(r.createPrimaryCategorySchema),o(n.createPrimaryCategory)),c.get("/primary",o(n.getAllPrimaryCategories)),c.get("/primary/:id",o(n.getPrimaryCategoryById)),c.put("/primary/:id",d([1,2,3]),s(r.updatePrimaryCategorySchema),o(n.updatePrimaryCategory)),c.delete("/primary/:id",d([1,2,3]),o(n.deletePrimaryCategory)),c.post("/machine",d([1,2,3]),s(r.createMachineCategorySchema),o(n.createMachineCategory)),c.get("/machine",o(n.getAllMachineCategories)),c.get("/machine/:id",o(n.getMachineCategoryById)),c.put("/machine/:id",d([1,2,3]),s(r.updateMachineCategorySchema),o(n.updateMachineCategory)),c.delete("/machine/:id",d([1,2,3]),o(n.deleteMachineCategory)),e.exports=c},5405:(e,t,a)=>{const{Op:i}=a(9031),n=a(9239);e.exports={createPrimaryCategory:async e=>await n.PrimaryCategory.create(e),getAllPrimaryCategories:async()=>await n.PrimaryCategory.findAll({include:[{model:n.MachineCategory,as:"machineCategories"}]}),getPrimaryCategoryById:async e=>{const t=await n.PrimaryCategory.findByPk(e,{include:[{model:n.MachineCategory,as:"machineCategories"}]});if(!t)throw new Error("Primary Category not found.");return t},updatePrimaryCategory:async(e,t)=>{const a=await n.PrimaryCategory.findByPk(e);if(!a)throw new Error("Primary Category not found.");return await a.update(t),a},deletePrimaryCategory:async e=>{const t=await n.PrimaryCategory.findByPk(e);if(!t)throw new Error("Primary Category not found.");return await t.destroy(),{message:"Primary Category deleted successfully."}},createMachineCategory:async e=>await n.MachineCategory.create(e),getAllMachineCategories:async()=>await n.MachineCategory.findAll({include:[{model:n.PrimaryCategory,as:"primaryCategory"}]}),getMachineCategoryById:async e=>{const t=await n.MachineCategory.findByPk(e,{include:[{model:n.PrimaryCategory,as:"primaryCategory"}]});if(!t)throw new Error("Machine Category not found.");return t},updateMachineCategory:async(e,t)=>{const a=await n.MachineCategory.findByPk(e);if(!a)throw new Error("Machine Category not found.");return await a.update(t),a},deleteMachineCategory:async e=>{const t=await n.MachineCategory.findByPk(e);if(!t)throw new Error("Machine Category not found.");return await t.destroy(),{message:"Machine Category deleted successfully."}},getAllMachineCategoriesV2:async(e,t)=>{const{page:a=1,limit:r=20,search:s="",sortBy:o="name",sortOrder:d="ASC",machineType:c,averageBase:l,primaryCategoryId:u}=e.query,m=(a-1)*r,p={};s&&(p[i.or]=[{name:{[i.iLike]:`%${s}%`}},{remarks:{[i.iLike]:`%${s}%`}}]),c&&(p.machineType=c),l&&(p.averageBase=l),u&&(p.primaryCategoryId=u);const{count:y,rows:I}=await n.MachineCategory.findAndCountAll({where:p,include:[{model:n.PrimaryCategory,as:"primaryCategory",attributes:["id","name"]}],order:[[o,d]],offset:m,limit:r});t.sendResponse({data:I,totalCount:y,totalPages:Math.ceil(y/r),currentPage:Number(a)})}}},9280:(e,t,a)=>{const i=a(2446),n=i.object({name:i.string().trim().min(2).max(50).required()}),r=i.object({name:i.string().trim().min(2).max(50).required()}),s=i.object({name:i.string().trim().min(2).max(50).required(),primaryCategoryId:i.number().integer().positive().allow(null),averageBase:i.string().valid("Distance","Time","Both","None").allow(null),standardKmRun:i.number().positive().allow(null),standardMileage:i.number().positive().allow(null),standardHrsRun:i.number().positive().allow(null),ltrPerHour:i.number().positive().allow(null),remarks:i.string().trim().allow(null,""),useFor:i.string().trim().allow(null,""),machineType:i.string().valid("Vehicle","Machine","Drilling").allow(null),unitPerHour:i.number().positive().allow(null),isApplicable:i.array().allow(null),other:i.string().trim().allow(null,"")}),o=i.object({name:i.string().trim().min(2).max(50).required(),primaryCategoryId:i.number().integer().positive().allow(null),averageBase:i.string().valid("Distance","Time","Both","None").allow(null),standardKmRun:i.number().positive().allow(null),standardMileage:i.number().positive().allow(null),standardHrsRun:i.number().positive().allow(null),ltrPerHour:i.number().positive().allow(null),remarks:i.string().trim().allow(null,""),useFor:i.string().trim().allow(null,""),machineType:i.string().valid("Vehicle","Machine","Drilling").allow(null),unitPerHour:i.number().positive().allow(null),isApplicable:i.array().allow(null),other:i.string().trim().allow(null,"")});e.exports={createPrimaryCategorySchema:n,updatePrimaryCategorySchema:r,createMachineCategorySchema:s,updateMachineCategorySchema:o}},9138:(e,t,a)=>{const i=a(2703),{checkMachineryDocumentExpiry:n,checkLowAndOutOfStock:r,checkScheduledMaintenanceAlerts:s,checkMachineMaintenanceAlerts:o}=a(2175);e.exports=function(){i.schedule("0 7 * * *",(async()=>{console.log("Running Low Stock and Document Expiry Checks...");try{await n(),await r()}catch(e){console.log(e)}})),i.schedule("0 8 * * *",(async()=>{console.log("Running Scheduled Maintenance Alert Checks...");try{await o()}catch(e){console.log(e)}}))}},6337:(e,t,a)=>{const{Op:i}=a(9031),n=a(9239),r=a(4716),s=a(5771),o=[{field:"fitnessCertificateExpiry",label:"Fitness Certificate"},{field:"motorVehicleTaxDue",label:"Motor Vehicle Tax"},{field:"permitExpiryDate",label:"Permit"},{field:"nationalPermitExpiry",label:"National Permit"},{field:"insuranceExpiry",label:"Insurance"},{field:"pollutionCertificateExpiry",label:"Pollution Certificate"}],d=async(e,t)=>{const a=r().startOf("day").toDate();return!!await n.Notification.findOne({where:{eventType:"DocumentExpiry",referenceId:e,eventAction:t,createdAt:{[i.gte]:a}}})};e.exports={checkMachineryDocumentExpiries:async()=>{const e=r().add(15,"days").toDate(),t=await n.Machinery.findAll({where:{[i.or]:o.map((({field:t})=>({[t]:{[i.lte]:e}})))},include:[{model:n.Site,as:"site"}]});for(const a of t)for(const{field:t,label:i}of o){const o=a[t];if(o&&r(o).isSameOrBefore(e)){const e=`${i} is expiring on ${r(o).format("YYYY-MM-DD")} for Machine: ${a.machineName} at ${a.site?.name}`;await d(a.id,"Expired")||await n.Notification.create({eventType:"DocumentExpiry",eventAction:"Expired",title:i,referenceId:a.id,siteId:a.siteId,description:e,roles:[s.STORE_MANAGER,s.PROJECT_MANAGER,s.MECHANICAL_MANAGER]})}}}}},8715:(e,t,a)=>{const i=a(5771),n=a(9239);e.exports={checkLowAndOutOfStock:async()=>{const e=await n.SiteInventory.findAll({include:[{model:n.Item},{model:n.Site,where:{type:"physical"},required:!0}]});for(const t of e){let e=null;0===t.quantity?e="Out of Stock":t.quantity<t.minimumLevel&&(e="Low Stock"),e&&await n.Notification.create({eventType:"LowStock",eventAction:e,referenceId:t.itemId,siteId:t.siteId,title:`${t.Item.name} ${e}`,description:`${t.Item.name} is ${e} at ${t.Site?.name}`,roles:[i.STORE_MANAGER,i.PROJECT_MANAGER,i.MECHANICAL_MANAGER]})}}}},8552:(e,t,a)=>{const{Op:i}=a(9031),n=a(9239),r=a(5771),s=async(e,t,a="MaintenanceAlert")=>{const r=new Date;return r.setHours(0,0,0,0),!!await n.Notification.findOne({where:{eventType:a,referenceId:e,eventAction:t,createdAt:{[i.gte]:r}}})},o=async e=>await n.LogbookEntry.findOne({where:{machineId:e},order:[["date","DESC"]],attributes:["id","date","machineId","closingKmReading","closingHrsMeter"]}),d=async e=>await n.MaintenanceLog.findOne({where:{machineId:e},order:[["date","DESC"]],attributes:["id","date","machineId","hoursAtService","kilometersAtService"]});e.exports={checkMachineMaintenanceAlerts:async()=>{console.log("Running Machine Maintenance Alert Checks...");try{const e=await n.MachineServiceInterval.findAll({where:{isActive:!0},include:[{model:n.Machinery,as:"machine"}]});for(const t of e){const e=t.machineId,a=await o(e),i=await d(e);let c=!1,l="",u="",m="";if(a&&i){if(t.intervalHours>0){const e=a.closingHrsMeter||0,n=(i.hoursAtService||0)+t.intervalHours;e>=n&&(c=!0,l="Hours",u=`SERVICE DUE: ${t.serviceType} for Machine: ${t.machine?.machineName} (Current Hours: ${e}, Due at: ${n})`,m=`Service Due: ${t.serviceType} - Hours Based`)}if(t.intervalKm>0&&!c){const e=a.closingKmReading||0,n=(i.kilometersAtService||0)+t.intervalKm;e>=n&&(c=!0,l="Kilometers",u=`SERVICE DUE: ${t.serviceType} for Machine: ${t.machine?.machineName} (Current KM: ${e}, Due at: ${n})`,m=`Service Due: ${t.serviceType} - KM Based`)}}if(t.intervalCalendarDays>0&&!c)if(i){const e=new Date(i.date),a=new Date(e);if(a.setDate(a.getDate()+t.intervalCalendarDays),new Date>=a){c=!0,l="Calendar";const e=a.toISOString().split("T")[0];u=`SERVICE DUE: ${t.serviceType} for Machine: ${t.machine?.machineName} (Due Date: ${e})`,m=`Service Due: ${t.serviceType} - Calendar Based`}}else{const e=new Date(t.createdAt),a=new Date(e);if(a.setDate(a.getDate()+t.intervalCalendarDays),new Date>=a){c=!0,l="Calendar";const e=a.toISOString().split("T")[0];u=`SERVICE DUE: ${t.serviceType} for Machine: ${t.machine?.machineName} (Due Date: ${e})`,m=`Service Due: ${t.serviceType} - Calendar Based`}}c&&(await s(t.id,`Service Due - ${l}`,"MachineMaintenanceAlert")||(await n.Notification.create({eventType:"MachineMaintenanceAlert",eventAction:`Service Due - ${l}`,title:m,referenceId:e,description:u,roles:[r.ADMIN,r.STORE_MANAGER,r.PROJECT_MANAGER,r.MECHANICAL_MANAGER]}),console.log(`Created notification for machine ${t.machine?.machineName}, service type: ${t.serviceType}`)))}console.log("Machine Maintenance Alert Checks completed.")}catch(e){throw console.error("Error in checkMachineMaintenanceAlerts:",e),e}},getLatestLogEntry:o,getLatestMaintenanceLog:d}},7305:(e,t,a)=>{const{Op:i}=a(9031),n=a(9239),r=a(5771),s=async(e,t,a="MaintenanceAlert")=>{const r=new Date;return r.setHours(0,0,0,0),!!await n.Notification.findOne({where:{eventType:a,referenceId:e,eventAction:t,createdAt:{[i.gte]:r}}})};e.exports={checkScheduledMaintenanceAlerts:async()=>{const e=new Date,t=new Date;t.setDate(t.getDate()+1),t.setHours(0,0,0,0);const a=new Date;a.setDate(a.getDate()+7),a.setHours(23,59,59,999);const o=await n.MaintenanceLog.findAll({where:{status:"scheduled",dueDate:{[i.lte]:a,[i.gte]:e}},include:[{model:n.Machinery,as:"machine"}]});for(const i of o){const o=new Date(i.dueDate);let d=null,c="";const l=new Date(o);l.setHours(0,0,0,0);const u=new Date(e);u.setHours(0,0,0,0);const m=new Date(t);if(m.setHours(0,0,0,0),l.getTime()===u.getTime()?(d="Due Today",c="Due Today"):l.getTime()===m.getTime()?(d="Due Tomorrow",c="Due Tomorrow"):o>=e&&o<=a&&(d="Due Soon",c="Due Soon"),d){const e=`${c}: ${i.title} for Machine: ${i.machine?.machineName}`,t=`${c}: ${i.title}`;await s(i.id,d,"MaintenanceAlert")||await n.Notification.create({eventType:"MaintenanceAlert",eventAction:d,title:t,referenceId:i.id,description:e,roles:[r.STORE_MANAGER,r.PROJECT_MANAGER,r.MECHANICAL_MANAGER]})}}},checkMachineServiceIntervalAlerts:async()=>{const e=new Date,t=new Date;t.setDate(t.getDate()+7);const a=await n.MachineServiceInterval.findAll({where:{isActive:!0,[i.or]:[{intervalType:"hours",nextServiceValue:{[i.lte]:n.sequelize.literal('(SELECT COALESCE(MAX("closingHrsMeter"), 0) FROM logbook_entries WHERE machineId = MachineServiceInterval.machineId)')}},{intervalType:"kilometers",nextServiceValue:{[i.lte]:n.sequelize.literal('(SELECT COALESCE(MAX("closingKmReading"), 0) FROM logbook_entries WHERE machineId = MachineServiceInterval.machineId)')}},{intervalType:"calendar",nextServiceDate:{[i.lte]:e}}]},include:[{model:n.Machinery,as:"machine"}]});for(const e of a){const t=`SERVICE DUE: ${e.serviceType} for Machine: ${e.machine?.machineName} (Interval: ${e.intervalValue} ${e.intervalType})`,a=`Service Due: ${e.serviceType}`;await s(e.id,"Service Due","MachineServiceIntervalAlert")||await n.Notification.create({eventType:"MachineServiceIntervalAlert",eventAction:"Service Due",title:a,referenceId:e.id,description:t,roles:[r.STORE_MANAGER,r.PROJECT_MANAGER,r.MECHANICAL_MANAGER]})}}}},2175:(e,t,a)=>{const{checkMachineryDocumentExpiries:i}=a(6337),{checkLowAndOutOfStock:n}=a(8715),{checkScheduledMaintenanceAlerts:r,checkMachineServiceIntervalAlerts:s}=a(7305),{checkMachineMaintenanceAlerts:o}=a(8552);e.exports={checkMachineryDocumentExpiry:i,checkLowAndOutOfStock:n,checkScheduledMaintenanceAlerts:r,checkMachineServiceIntervalAlerts:s,checkMachineMaintenanceAlerts:o}},2698:(e,t,a)=>{const i=a(4355),n=e=>e.user&&e.user.siteId?e.user.siteId:e.query.siteId;e.exports={getOverview:async(e,t)=>{const a=await i.getOverview(e.query);t.sendResponse(a,"Overview data retrieved successfully")},getAlerts:async(e,t)=>{const a=await i.getAlerts(e.query);t.sendResponse(a,"Alerts retrieved successfully")},getRecentActivities:async(e,t)=>{const a=await i.getRecentActivities(e.query);t.sendResponse(a,"Recent activities retrieved successfully")},getMachineStatus:async(e,t)=>{const a=await i.getMachineStatus(e.query);t.sendResponse(a,"Machine status data retrieved successfully")},getSitesSummary:async(e,t)=>{const a=await i.getSitesSummary(e.query);t.sendResponse(a,"Sites summary retrieved successfully")},getInventoryAlerts:async(e,t)=>{const a=await i.getInventoryAlerts(e.query);t.sendResponse(a,"Inventory alerts retrieved successfully")},getMaintenanceDue:async(e,t)=>{const a=await i.getMaintenanceDue(e.query);t.sendResponse(a,"Maintenance due data retrieved successfully")},getProcurementPending:async(e,t)=>{const a=await i.getProcurementPending(e.query);t.sendResponse(a,"Pending procurements retrieved successfully")},getPaymentsOutstanding:async(e,t)=>{const a=await i.getPaymentsOutstanding(e.query);t.sendResponse(a,"Outstanding payments retrieved successfully")},getExpensesMonthly:async(e,t)=>{const a=await i.getExpensesMonthly(e.query);t.sendResponse(a,"Monthly expenses retrieved successfully")},getSiteOverview:async(e,t)=>{const a=n(e);if(!a)return t.status(400).send({message:"Site ID is required."});const r=await i.getSiteOverview(a,e.query);t.sendResponse(r,"Site overview retrieved successfully")},getSiteRequisitions:async(e,t)=>{const a=n(e);if(!a)return t.status(400).send({message:"Site ID is required."});const r=await i.getSiteRequisitions(a,e.query);t.sendResponse(r,"Site requisitions retrieved successfully")},getSiteMaterialIssues:async(e,t)=>{const a=n(e);if(!a)return t.status(400).send({message:"Site ID is required."});const r=await i.getSiteMaterialIssues(a,e.query);t.sendResponse(r,"Site material issues retrieved successfully")},getSiteTransfers:async(e,t)=>{const a=n(e);if(!a)return t.status(400).send({message:"Site ID is required."});const r=await i.getSiteTransfers(a,e.query);t.sendResponse(r,"Site transfers retrieved successfully")},getSiteInventoryAlerts:async(e,t)=>{const a=n(e);if(!a)return t.status(400).send({message:"Site ID is required."});const r=await i.getSiteInventoryAlerts(a,e.query);t.sendResponse(r,"Site inventory alerts retrieved successfully")},getSiteMachineAlerts:async(e,t)=>{const a=n(e);if(!a)return t.status(400).send({message:"Site ID is required."});const r=await i.getSiteMachineAlerts(a,e.query);t.sendResponse(r,"Site machine alerts retrieved successfully")},getSiteMachineStatus:async(e,t)=>{const a=n(e);if(!a)return t.status(400).send({message:"Site ID is required."});const r=await i.getSiteMachineStatus(a,e.query);t.sendResponse(r,"Site machine status retrieved successfully")},getSiteInventoryStatus:async(e,t)=>{const a=n(e);if(!a)return t.status(400).send({message:"Site ID is required."});const r=await i.getSiteInventoryStatus(a,e.query);t.sendResponse(r,"Site inventory status retrieved successfully")},getSiteMaintenanceDue:async(e,t)=>{const a=n(e);if(!a)return t.status(400).send({message:"Site ID is required."});const r=await i.getSiteMaintenanceDue(a,e.query);t.sendResponse(r,"Site maintenance due retrieved successfully")},getSiteExpenses:async(e,t)=>{const a=n(e);if(!a)return t.status(400).send({message:"Site ID is required."});const r=await i.getSiteExpenses(a,e.query);t.sendResponse(r,"Site expenses retrieved successfully")},getSiteInfo:async(e,t)=>{const a=n(e);if(!a)return t.status(400).send({message:"Site ID is required."});const r=await i.getSiteInfo(a);t.sendResponse(r,"Site information retrieved successfully")}}},9087:(e,t,a)=>{const i=a(7252).Router(),n=a(7434),r=a(2698),s=a(4081),{dashboardFiltersSchema:o}=a(9858);i.get("/dashboard/overview",s(o,"query"),n(r.getOverview)),i.get("/dashboard/alerts",s(o,"query"),n(r.getAlerts)),i.get("/dashboard/recent-activities",s(o,"query"),n(r.getRecentActivities)),i.get("/dashboard/machines/status",s(o,"query"),n(r.getMachineStatus)),i.get("/dashboard/sites/summary",s(o,"query"),n(r.getSitesSummary)),i.get("/dashboard/inventory/alerts",s(o,"query"),n(r.getInventoryAlerts)),i.get("/dashboard/maintenance/due",s(o,"query"),n(r.getMaintenanceDue)),i.get("/dashboard/procurement/pending",s(o,"query"),n(r.getProcurementPending)),i.get("/dashboard/payments/outstanding",s(o,"query"),n(r.getPaymentsOutstanding)),i.get("/dashboard/expenses/monthly",s(o,"query"),n(r.getExpensesMonthly)),i.get("/dashboard/site/overview",s(o,"query"),n(r.getSiteOverview)),i.get("/dashboard/site/info",n(r.getSiteInfo)),i.get("/dashboard/site/requisitions",s(o,"query"),n(r.getSiteRequisitions)),i.get("/dashboard/site/material-issues",s(o,"query"),n(r.getSiteMaterialIssues)),i.get("/dashboard/site/transfers",s(o,"query"),n(r.getSiteTransfers)),i.get("/dashboard/site/machines/status",s(o,"query"),n(r.getSiteMachineStatus)),i.get("/dashboard/site/inventory/status",s(o,"query"),n(r.getSiteInventoryStatus)),i.get("/dashboard/site/inventory/alerts",s(o,"query"),n(r.getSiteInventoryAlerts)),i.get("/dashboard/site/machine/alerts",s(o,"query"),n(r.getSiteMachineAlerts)),i.get("/dashboard/site/maintenance/due",s(o,"query"),n(r.getSiteMaintenanceDue)),i.get("/dashboard/site/expenses",s(o,"query"),n(r.getSiteExpenses)),e.exports=i},4355:(e,t,a)=>{const{Op:i,Sequelize:n}=a(9031),r=a(9239);e.exports={getOverview:async(e={})=>{const{siteId:t,dateRange:a}=e,s={},o={};a?.startDate&&a?.endDate&&(o.createdAt={[i.between]:[a.startDate,a.endDate]});const[d,c,l,u,m,p,y,I]=await Promise.all([r.Machinery.count({where:s}),r.Machinery.count({where:{...s,status:"In Use"}}),r.Site.count({where:s}),r.Site.count({where:{...s,status:"active"}}),r.Requisition.count({where:{...s,status:"pending",...o}}),r.MachineTransfer.count({where:{...s,status:"Pending",...o}}),r.SiteInventory.count({where:{...s,status:"Low Stock"}}),r.Invoice.count({where:{status:{[i.in]:["SENT","PARTIALLY_PAID"]},...o}})]);return{totalMachines:d,activeMachines:c,totalSites:l,activeSites:u,pendingRequisitions:m,pendingTransfers:p,lowStockItems:y,outstandingInvoices:I,machineStatusBreakdown:await r.Machinery.findAll({attributes:["status",[n.fn("COUNT",n.col("id")),"count"]],where:s,group:["status"]})}},getAlerts:async(e={})=>{const{siteId:t,limit:a=10}=e,n={},s=new Date;s.setDate(s.getDate()+30);const[o,d,c,l]=await Promise.all([r.Machinery.findAll({where:{...n,[i.or]:[{fitnessCertificateExpiry:{[i.lte]:s}},{insuranceExpiry:{[i.lte]:s}},{pollutionCertificateExpiry:{[i.lte]:s}},{permitExpiryDate:{[i.lte]:s}}]},attributes:["id","machineName","registrationNumber","erpCode","siteId","status","model","make","pollutionCertificateExpiry","fitnessCertificateExpiry","insuranceExpiry","permitExpiryDate","motorVehicleTaxDue"],include:[{model:r.Site,as:"site",attributes:["name"]}],limit:a}),r.SiteInventory.findAll({where:{...n,status:{[i.in]:["Low Stock","Out of Stock"]}},include:[{model:r.Site,attributes:["name"]},{model:r.Item,attributes:["name","shortName"],include:[{model:r.Unit,attributes:["name","shortName"]}]}],limit:a}),r.Requisition.count({where:{...n,status:"pending"}}),r.MaintenanceLog.count({where:{status:"scheduled",date:{[i.lt]:new Date}}})]);return{certificateExpiries:o,lowStockAlerts:d,pendingApprovals:c,maintenanceOverdue:l}},getRecentActivities:async(e={})=>{const{siteId:t,limit:a=20}=e,i={},[n,s,o,d]=await Promise.all([r.Requisition.findAll({where:i,attributes:["id","requisitionNo","requestedFor","chargeType","requestPriority","dueDate","status"],include:[{model:r.Site,as:"requestingSite",attributes:["name"]},{model:r.User,as:"preparedBy",attributes:["name"]}],order:[["createdAt","DESC"]],limit:a/4}),r.MachineTransfer.findAll({where:i,attributes:["id","name","destinationSiteId","requestType","status","dispatchedAt","transportDetails"],include:[{model:r.Site,as:"currentSite",attributes:["name"]},{model:r.Machinery,as:"machine",attributes:["machineName"]}],order:[["createdAt","DESC"]],limit:a/4}),r.MaterialIssue.findAll({where:i,attributes:["id","issueNumber","issueType","otherSiteId","issueDate","status","approvedAt"],include:[{model:r.Site,as:"fromSite",attributes:["name"]}],order:[["createdAt","DESC"]],limit:a/4}),r.MaintenanceLog.findAll({where:i,attributes:["id","type","cost","date","status","title"],include:[{model:r.Machinery,as:"machine",attributes:["machineName","id"]}],order:[["createdAt","DESC"]],limit:a/4})]);return{recentRequisitions:n,recentTransfers:s,recentIssues:o,recentMaintenance:d}},getMachineStatus:async(e={})=>{const{siteId:t,categoryId:a}=e,i={},[s,o,d]=await Promise.all([r.Machinery.findAll({attributes:["status",[n.fn("COUNT",n.col("id")),"count"]],where:i,group:["status"]}),r.Machinery.findAll({attributes:["siteId","Machinery.status",[n.fn("COUNT",n.col("Machinery.id")),"count"]],where:i,include:[{model:r.Site,as:"site",attributes:["name"]}],group:["siteId","Machinery.status","site.id","site.name"]}),r.Machinery.findAll({attributes:["machineCategoryId","Machinery.status",[n.fn("COUNT",n.col("Machinery.id")),"count"]],where:i,include:[{model:r.MachineCategory,as:"machineCategory",attributes:["name"]}],group:["machineCategoryId","Machinery.status","machineCategory.id","machineCategory.name"]})]);return{statusBreakdown:s,siteWiseBreakdown:o,categoryWiseBreakdown:d}},getSitesSummary:async(e={})=>{const{departmentId:t,limit:a,offset:i}=e,s={};return t&&(s.departmentId=t),(await r.Site.findAll({where:s,attributes:["id","name","code","status","departmentId",[n.literal('(\n          SELECT COUNT(*)\n          FROM machineries AS "machine"\n          WHERE "machine"."siteId" = "Site"."id"\n        )'),"totalMachines"],[n.literal('(\n          SELECT COUNT(*)\n          FROM machineries AS "machine"\n          WHERE "machine"."siteId" = "Site"."id"\n          AND "machine"."status" = \'In Use\'\n        )'),"activeMachines"],[n.literal('(\n          SELECT COUNT(*)\n          FROM users AS "user"\n          WHERE "user"."siteId" = "Site"."id"\n        )'),"totalUsers"]],include:[{model:r.Department,attributes:["name"]}],limit:a?parseInt(a):void 0,offset:i?parseInt(i):void 0})).map((e=>({id:e.id,name:e.name,code:e.code,status:e.status,department:e.Department?.name,totalMachines:parseInt(e.getDataValue("totalMachines")||0),activeMachines:parseInt(e.getDataValue("activeMachines")||0),totalUsers:parseInt(e.getDataValue("totalUsers")||0)})))},getInventoryAlerts:async(e={})=>{const{siteId:t,severity:a,limit:n=20}=e;return await r.SiteInventory.findAll({where:{status:{[i.in]:["Low Stock","Out of Stock"]}},include:[{model:r.Site,attributes:["name","code"]},{model:r.Item,include:[{model:r.Unit}]}],order:[["quantity","ASC"]],limit:parseInt(n)})},getMaintenanceDue:async(e={})=>{const{siteId:t,days:a=30,limit:n=20}=e,s=new Date;return s.setDate(s.getDate()+parseInt(a)),await r.MaintenanceLog.findAll({where:{status:"scheduled",date:{[i.between]:[new Date,s]}},include:[{model:r.Machinery,as:"machine",where:{},include:[{model:r.Site,as:"site"}]}],order:[["date","ASC"]],limit:parseInt(n)})},getProcurementPending:async(e={})=>{const{siteId:t,status:a="pending",limit:i=20}=e,n={status:a},s=await r.Procurement.findAll({include:[{model:r.Requisition,include:[{model:r.Site,as:"requestingSite",where:t?{id:t}:{}}]},{model:r.Vendor}],order:[["createdAt","DESC"]],limit:parseInt(i)});return{procurements:s,totalValue:await r.Procurement.sum("totalAmount",{where:n})||0,count:s.length}},getPaymentsOutstanding:async(e={})=>{const{siteId:t,limit:a=50,offset:n=0}=e,s={status:{[i.in]:["SENT","PARTIALLY_PAID"]}},o=(await r.Invoice.findAll({where:s,attributes:["id","amount"],include:[{model:r.Procurement,as:"procurement",attributes:[],required:!0,include:[{model:r.Requisition,attributes:[],required:!0,include:[{model:r.Site,as:"requestingSite",attributes:[],where:t?{id:t}:{},required:!0}]}]},{model:r.Payment,as:"payments",attributes:["amount"]}]})).reduce(((e,t)=>{const a=t.payments?.reduce(((e,t)=>e+parseFloat(t.amount)),0)||0;return e+(parseFloat(t.amount)-a)}),0),d=await r.Invoice.findAll({where:s,include:[{model:r.Procurement,as:"procurement",include:[{model:r.Requisition,include:[{model:r.Site,as:"requestingSite",where:t?{id:t}:{}}]}]},{model:r.Payment,as:"payments"}],order:[["invoiceDate","ASC"]],limit:parseInt(a),offset:parseInt(n)});return{invoices:d,totalOutstanding:o,count:d.length}},getExpensesMonthly:async(e={})=>{const{siteId:t,months:a=12}=e,s=new Date;s.setMonth(s.getMonth()-parseInt(a));const[o,d]=await Promise.all([r.Procurement.findAll({attributes:[[n.fn("DATE_TRUNC","month",n.col("createdAt")),"month"],[n.fn("SUM",n.col("totalAmount")),"totalAmount"]],where:{createdAt:{[i.gte]:s},status:{[i.in]:["delivered","paid"]}},group:[n.fn("DATE_TRUNC","month",n.col("createdAt"))],order:[[n.fn("DATE_TRUNC","month",n.col("createdAt")),"ASC"]]}),r.MaintenanceLog.findAll({attributes:[[n.fn("DATE_TRUNC","month",n.col("date")),"month"],[n.fn("SUM",n.col("cost")),"totalCost"]],where:{date:{[i.gte]:s},status:"completed"},include:[{model:r.Machinery,as:"machine",where:{},attributes:[]}],group:[n.fn("DATE_TRUNC","month",n.col("date"))],order:[[n.fn("DATE_TRUNC","month",n.col("date")),"ASC"]]})]);return{procurementExpenses:o,maintenanceExpenses:d}},getSiteOverview:async(e,t={})=>{if(!e)throw new Error("Site ID is required for site users");const{dateRange:a}=t;a?.startDate&&a?.endDate&&(i.between,a.startDate,a.endDate);const[s,o,d,c,l,u,m,p]=await Promise.all([r.SiteInventory.count({where:{siteId:e}}),r.SiteInventory.count({where:{siteId:e,status:"Low Stock"}}),r.SiteInventory.count({where:{siteId:e,status:"Out of Stock"}}),r.Machinery.count({where:{siteId:e}}),r.Machinery.count({where:{siteId:e,status:"In Use"}}),r.Machinery.findAll({attributes:["status",[n.fn("COUNT",n.col("id")),"count"]],where:{siteId:e},group:["status"]}),r.User.count({where:{siteId:e}}),r.User.count({where:{siteId:e,status:"active"}})]);return{inventory:{totalItems:s,lowStockItems:o,outOfStockItems:d,totalValue:0},machines:{totalMachines:c,activeMachines:l,statusBreakdown:u},personnel:{totalUsers:m,activeUsers:p}}},getSiteRequisitions:async(e,t={})=>{if(!e)throw new Error("Site ID is required for site users");const{limit:a=20,status:i}=t,s={requestingSiteId:e};i&&(s.status=i);const[o,d,c]=await Promise.all([r.Requisition.count({where:{requestingSiteId:e,status:"pending"}}),r.Requisition.findAll({where:s,attributes:["id","requisitionNo","requestedFor","chargeType","requestPriority","dueDate","status","createdAt"],include:[{model:r.User,as:"preparedBy",attributes:["name"]},{model:r.RequisitionItem,as:"items",include:[{model:r.Item,attributes:["name","shortName"]}]}],order:[["createdAt","DESC"]],limit:a}),r.Requisition.findAll({attributes:["status",[n.fn("COUNT",n.col("id")),"count"]],where:{requestingSiteId:e},group:["status"]})]);return{pendingCount:o,recentRequisitions:d,statusBreakdown:c}},getSiteMaterialIssues:async(e,t={})=>{if(!e)throw new Error("Site ID is required for site users");const{limit:a=20,status:i}=t,n={siteId:e};i&&(n.status=i);const[s,o]=await Promise.all([r.MaterialIssue.count({where:{siteId:e,status:"pending"}}),r.MaterialIssue.findAll({where:n,attributes:["id","issueNumber","issueType","otherSiteId","issueDate","status","approvedAt"],include:[{model:r.Site,as:"toSite",attributes:["name"]},{model:r.MaterialIssueItem,as:"items",include:[{model:r.Item,attributes:["name","shortName"]}]}],limit:a})]);return{pendingCount:s,recentIssues:o}},getSiteTransfers:async(e,t={})=>{if(!e)throw new Error("Site ID is required for site users");const{limit:a=20,status:i}=t,s={currentSiteId:e};i&&(s.status=i);const[o,d,c]=await Promise.all([r.MachineTransfer.count({where:{currentSiteId:e,status:"Pending"}}),r.MachineTransfer.findAll({where:s,attributes:["id","name","destinationSiteId","requestType","status","dispatchedAt","transportDetails","createdAt"],include:[{model:r.Site,as:"destinationSite",attributes:["name"]},{model:r.Machinery,as:"machine",attributes:["machineName","registrationNumber"]}],order:[["createdAt","DESC"]],limit:a}),r.MachineTransfer.findAll({attributes:["status",[n.fn("COUNT",n.col("id")),"count"]],where:{currentSiteId:e},group:["status"]})]);return{pendingCount:o,recentTransfers:d,statusBreakdown:c}},getSiteInventoryAlerts:async(e,t={})=>{if(!e)throw new Error("Site ID is required for site users");const{limit:a=20}=t,[i,n,s]=await Promise.all([r.SiteInventory.findAll({where:{siteId:e,status:"Low Stock"},include:[{model:r.Item,attributes:["name","shortName"],include:[{model:r.Unit,attributes:["name","shortName"]}]}],order:[["quantity","ASC"]],limit:a}),r.SiteInventory.findAll({where:{siteId:e,status:"Out of Stock"},include:[{model:r.Item,attributes:["name","shortName"],include:[{model:r.Unit,attributes:["name","shortName"]}]}],limit:a}),r.SiteInventory.findAll({where:{siteId:e,status:"In Stock"},include:[{model:r.Item,attributes:["name","shortName"],include:[{model:r.Unit,attributes:["name","shortName"]}]}],limit:a})]);return{lowStock:i,outOfStock:n,approachingMinimum:s}},getSiteMachineAlerts:async(e,t={})=>{if(!e)throw new Error("Site ID is required for site users");const{days:a=30,limit:n=20}=t,s=new Date;s.setDate(s.getDate()+parseInt(a));const[o,d,c,l]=await Promise.all([r.Machinery.findAll({where:{siteId:e,[i.or]:[{fitnessCertificateExpiry:{[i.lte]:s}},{pollutionCertificateExpiry:{[i.lte]:s}}]},attributes:["id","machineName","registrationNumber","erpCode","status","fitnessCertificateExpiry","pollutionCertificateExpiry"],order:[["fitnessCertificateExpiry","ASC"]],limit:n}),r.Machinery.findAll({where:{siteId:e,insuranceExpiry:{[i.lte]:s}},attributes:["id","machineName","registrationNumber","erpCode","status","insuranceExpiry"],order:[["insuranceExpiry","ASC"]],limit:n}),r.Machinery.findAll({where:{siteId:e,permitExpiryDate:{[i.lte]:s}},attributes:["id","machineName","registrationNumber","erpCode","status","permitExpiryDate"],order:[["permitExpiryDate","ASC"]],limit:n}),r.MaintenanceLog.findAll({where:{status:"scheduled",date:{[i.lt]:new Date}},include:[{model:r.Machinery,as:"machine",where:{siteId:e},attributes:["id","machineName","registrationNumber","erpCode"]}],order:[["date","ASC"]],limit:n})]);return{certificateExpiries:o,insuranceExpiries:d,permitExpiries:c,maintenanceOverdue:l}},getSiteMachineStatus:async(e,t={})=>{if(!e)throw new Error("Site ID is required for site users");const{categoryId:a}=t,i={siteId:e};a&&(i.machineCategoryId=a);const[s,o]=await Promise.all([r.Machinery.findAll({attributes:["status",[n.fn("COUNT",n.col("id")),"count"]],where:i,group:["status"]}),r.Machinery.findAll({attributes:["machineCategoryId","Machinery.status",[n.fn("COUNT",n.col("Machinery.id")),"count"]],where:i,include:[{model:r.MachineCategory,as:"machineCategory",attributes:["name"]}],group:["machineCategoryId","Machinery.status","machineCategory.id","machineCategory.name"]})]);return{statusBreakdown:s,categoryWiseBreakdown:o}},getSiteInventoryStatus:async(e,t={})=>{if(!e)throw new Error("Site ID is required for site users");const{categoryId:a,limit:i=50,offset:s=0}=t,o={siteId:e};return{inventoryOverview:await r.SiteInventory.findAll({where:o,include:[{model:r.Item,attributes:["name","shortName","itemGroupId"],where:a?{itemGroupId:a}:{},include:[{model:r.Unit,attributes:["name","shortName"]},{model:r.ItemGroup,attributes:["name"]}]}],order:[["quantity","ASC"]],limit:parseInt(i),offset:parseInt(s)}),statusBreakdown:await r.SiteInventory.findAll({attributes:["status",[n.fn("COUNT",n.col("id")),"count"],[n.fn("SUM",n.col("quantity")),"totalQuantity"]],where:o,group:["status"]})}},getSiteMaintenanceDue:async(e,t={})=>{if(!e)throw new Error("Site ID is required for site users");const{days:a=30,limit:n=20}=t,s=new Date;return s.setDate(s.getDate()+parseInt(a)),await r.MaintenanceLog.findAll({where:{status:"scheduled",date:{[i.between]:[new Date,s]}},include:[{model:r.Machinery,as:"machine",where:{siteId:e},attributes:["id","machineName","registrationNumber","erpCode"]}],order:[["date","ASC"]],limit:parseInt(n)})},getSiteExpenses:async(e,t={})=>{if(!e)throw new Error("Site ID is required for site users");const{months:a=12}=t,s=new Date;s.setMonth(s.getMonth()-parseInt(a));const[o,d]=await Promise.all([r.Procurement.findAll({attributes:[[n.fn("DATE_TRUNC","month",n.col("Procurement.createdAt")),"month"],[n.fn("SUM",n.col("totalAmount")),"totalAmount"]],where:{createdAt:{[i.gte]:s},status:{[i.in]:["delivered","paid"]}},include:[{model:r.Requisition,where:{requestingSiteId:e},attributes:[]}],group:[n.fn("DATE_TRUNC","month",n.col("Procurement.createdAt"))],order:[[n.fn("DATE_TRUNC","month",n.col("Procurement.createdAt")),"ASC"]]}),r.MaintenanceLog.findAll({attributes:[[n.fn("DATE_TRUNC","month",n.col("date")),"month"],[n.fn("SUM",n.col("cost")),"totalCost"]],where:{date:{[i.gte]:s},status:"completed"},include:[{model:r.Machinery,as:"machine",where:{siteId:e},attributes:[]}],group:[n.fn("DATE_TRUNC","month",n.col("date"))],order:[[n.fn("DATE_TRUNC","month",n.col("date")),"ASC"]]})]);return{procurementExpenses:o,maintenanceExpenses:d}},getSiteInfo:async e=>{if(!e)throw new Error("Site ID is required for site users");const t=await r.Site.findByPk(e,{include:[{model:r.Department,attributes:["name"]}],attributes:["id","name","code","address","pincode","mobileNumber","status","type"]});if(!t)throw new Error("Site not found");return t}}},9858:(e,t,a)=>{const i=a(2446),n=i.object({siteId:i.number().integer().positive().optional(),departmentId:i.number().integer().positive().optional(),categoryId:i.number().integer().positive().optional(),dateRange:i.object({startDate:i.date().optional(),endDate:i.date().optional()}).optional(),limit:i.number().integer().min(1).max(100).optional(),days:i.number().integer().min(1).max(365).optional(),months:i.number().integer().min(1).max(24).optional(),status:i.string().optional(),severity:i.string().valid("Low Stock","Out of Stock").optional()});e.exports={dashboardFiltersSchema:n}},7715:(e,t,a)=>{const{Notification:i}=a(9239);e.exports=async({eventType:e,eventAction:t,referenceId:a,siteId:n,createdBy:r,roles:s,title:o,description:d})=>{const c=await i.create({eventType:e,eventAction:t,referenceId:a,siteId:n,title:o,description:d,createdBy:r});s?.length&&await c.setRoles(s)}},7628:(e,t,a)=>{const i=a(5705);t.uploadFile=async(e,t)=>{const{folder:a,fileName:n}=e.body,r=await i.uploadFile(e.file,a,n);t.sendResponse(r,"File uploaded successfully")},t.deleteFile=async(e,t)=>{await i.deleteFile(e.params.publicId),t.sendResponse(null,"File deleted successfully")}},7386:(e,t,a)=>{const i=a(7252).Router(),n=a(7628),r=a(5965),s=a(7434);i.post("/upload",r.single("file"),s(n.uploadFile)),i.delete("/delete/:publicId",s(n.deleteFile)),e.exports=i},5705:(e,t,a)=>{const i=a(5056);t.uploadFile=async(e,t,a)=>{if(!e)throw new Error("No file uploaded");const n=t?t+"/"+a:"uploads",r=await i.uploader.upload(e.path,{folder:n,use_filename:!0,unique_filename:!1,resource_type:"auto"});return{fileUrl:r.secure_url,publicId:r.public_id}},t.deleteFile=async e=>{await i.uploader.destroy(e)}},6238:(e,t,a)=>{const i=a(3663);e.exports={createInventory:async(e,t)=>{const a=await i.createInventory(e.body);t.sendResponse(a,"Inventory created successfully")},updateInventory:async(e,t)=>{const a=await i.updateInventory(e.params.id,e.body);t.sendResponse(a,"Inventory updated successfully")},deleteInventory:async(e,t)=>{await i.deleteInventory(e.params.id),t.sendResponse(null,"Inventory deleted successfully")},getInventoryById:async(e,t)=>{const a=await i.getInventoryById(e.params.id);t.sendResponse(a,"Inventory fetched successfully")},getAllInventories:async(e,t)=>{const a=await i.getAggregatedInventoryForAdmin(e.user.siteId);return t.sendResponse(a,"Aggregated inventory for admin")},getInventoryDetailsByItemId:async(e,t)=>{const{itemId:a}=e.params,{siteId:n}=e.user,r=await i.inventoryDetailsByItemId({itemId:a,siteId:n});t.sendResponse(r,"Inventory details fetched successfully")},getInventoryBySiteId:async(e,t)=>{const a=await i.getInventoryBySiteId(e.params.siteId);t.sendResponse(a,"Inventory fetched successfully")},getItemGroupsAndItemsBySiteId:async(e,t)=>{const a=await i.getItemGroupsAndItemsBySiteId(e.params.siteId);t.sendResponse(a,"Inventory fetched successfully")},getStockLogsByItem:async(e,t)=>{const{itemId:a}=e.params,{siteId:n}=e.user,r=await i.getStockLogsByItem(a,n);t.sendResponse(r,"Stock logs fetched successfully")},getStockStatusBulk:async(e,t)=>{const a=e.query.siteId||e.user.siteId,{itemIds:n}=e.query,r=await i.getStockStatusBulk(a,n.split(","));t.sendResponse(r,"Stock status fetched successfully")},getStockLogReference:async(e,t)=>{const{sourceId:a,sourceType:n,itemId:r}=e.query,s=await i.getStockLogReference(a,n,r);t.sendResponse(s,"Stock logs fetched successfully")}}},344:(e,t,a)=>{const i=a(7252).Router(),n=a(6238),r=a(7434),{createInventorySchema:s,updateInventorySchema:o}=a(8222),d=a(4081);i.post("/",d(s),r(n.createInventory)),i.put("/:id",d(o),r(n.updateInventory)),i.delete("/:id",r(n.deleteInventory)),i.get("/:id",r(n.getInventoryById)),i.get("/",r(n.getAllInventories)),i.get("/item/:itemId",r(n.getInventoryDetailsByItemId)),i.get("/items/sites/:siteId",r(n.getItemGroupsAndItemsBySiteId)),i.get("/sites/:siteId",r(n.getInventoryBySiteId)),i.get("/stock-log/:itemId",r(n.getStockLogsByItem)),i.get("/reference/stock-log",r(n.getStockLogReference)),i.get("/stock-status/bulk",r(n.getStockStatusBulk)),e.exports=i},3663:(e,t,a)=>{const i=a(9239),{Sequelize:n}=a(9031);e.exports={createInventory:async e=>{const{siteId:t,itemId:a}=e,n=await i.SiteInventory.findOne({where:{siteId:t,itemId:a}});return n?(n.quantity+=e.quantity,await n.save(),n):await i.SiteInventory.create(e)},updateInventory:async(e,t)=>{const a=await i.SiteInventory.findByPk(e);if(!a)throw new Error("Inventory not found");return await a.update(t)},deleteInventory:async e=>{const t=await i.SiteInventory.findByPk(e);if(!t)throw new Error("Inventory not found");return await t.destroy()},getInventoryById:async e=>await i.SiteInventory.findByPk(e,{include:[{model:i.Site},{model:i.Item,include:[i.Unit,i.ItemGroup]}]}),getAllInventories:async()=>await i.SiteInventory.findAll({include:[{model:i.Site},{model:i.Item,include:[i.Unit,i.ItemGroup]}]}),getAggregatedInventoryForAdmin:async e=>{const t={};return e&&(t.siteId=e),await i.SiteInventory.findAll({where:t,attributes:["itemId",[n.fn("SUM",n.col("quantity")),"totalQuantity"],[n.fn("SUM",n.col("lockedQuantity")),"totalLockedQuantity"]],include:[{model:i.Item,attributes:["name","partNumber","hsnCode"],include:[{model:i.Unit,attributes:["name"]},{model:i.ItemGroup,attributes:["name"]}]}],group:["itemId","Item.id","Item->Unit.id","Item->ItemGroup.id"]})},inventoryDetailsByItemId:async function(e){const{itemId:t}=e,a={itemId:t};return e.siteId&&(a.siteId=e.siteId),await i.SiteInventory.findAll({where:a,include:[{model:i.Site},{model:i.Item,include:[i.Unit,i.ItemGroup]}]})},getInventoryBySiteId:async function(e){return await i.SiteInventory.findAll({where:{siteId:e},include:[{model:i.Item,include:[i.Unit,i.ItemGroup]}]})},getItemGroupsAndItemsBySiteId:async function(e){return await i.ItemGroup.findAll({include:[{model:i.Item,required:!0,include:[{model:i.Unit},{model:i.SiteInventory,required:!0,where:{siteId:e},attributes:["quantity"]}]}]})},getStockLogsByItem:async(e,t)=>{const a={itemId:e};t&&(a.siteId=t);const n=await i.StockLog.findAll({where:a,include:[{model:i.Site,attributes:["id","name"]},{model:i.User,attributes:["id","name"]}],order:[["createdAt","DESC"]]});return await Promise.all(n.map((async e=>{let t="";switch(e.sourceType){case"Issue":const a=await i.MaterialIssue.findByPk(e.sourceId);if(a)if("Site Transfer"===a.issueType){const e=await i.Site.findByPk(a.otherSiteId);t=`Transfer to ${e?.name||"another site"}`}else t=`by ${a.issueNumber}`;break;case"Requisition":const n=await i.Requisition.findByPk(e.sourceId);n&&(t=`by ${n.requisitionNo}`);break;case"Procurement":const r=await i.Procurement.findByPk(e.sourceId);r&&(t=`By ${r.procurementNo}`);break;default:t=e.sourceType||"-"}return{dateTime:e.createdAt,type:e.type,quantity:e.change,site:e.Site?.name||"-",reference:t,sourceType:e.sourceType,itemId:e.itemId,sourceId:e.sourceId,user:e.User?.name||"-"}})))},getStockStatusBulk:async(e,t)=>(await i.SiteInventory.findAll({where:{siteId:e,itemId:t.map((e=>parseInt(e)))}})).map((e=>{const t=e.quantity-(e.lockedQuantity||0);return{itemId:e.itemId,quantity:e.quantity,lockedQuantity:e.lockedQuantity||0,availableQuantity:t,status:t>0?"In Stock":"Out of Stock"}})),getStockLogReference:async(e,t,a)=>{switch(t){case"Issue":const n=await i.MaterialIssueItem.findOne({where:{materialIssueId:e,itemId:a},include:[{model:i.MaterialIssue,attributes:["issueNumber","issueType","otherSiteId"]},{model:i.Machinery,as:"machine",attributes:["machineName","registrationNumber"]},{model:i.Site,attributes:["name"],as:"fromSite"},{model:i.Site,attributes:["name"],as:"toSite"}]});if(n)return{issueItem:n,machinery:n.Machinery};break;case"Requisition":const r=await i.RequisitionItem.findOne({where:{requisitionId:e,itemId:a}});if(r)return{reqItem:r};break;case"Procurement":const s=await i.ProcurementItem.findOne({where:{procurementId:e,itemId:a},include:[{model:i.Procurement,attributes:["procurementNo"]}],raw:!0,nest:!0});if(s)return{poItem:s};break;default:return t||"-"}}}},8222:(e,t,a)=>{const i=a(2446),n=i.object({siteId:i.number().integer().positive().required(),itemId:i.number().integer().positive().required(),quantity:i.number().precision(2).required()}),r=i.object({siteId:i.number().integer().positive(),itemId:i.number().integer().positive(),quantity:i.number().precision(2)});e.exports={createInventorySchema:n,updateInventorySchema:r}},6338:(e,t,a)=>{const i=a(5483);e.exports={createInvoice:async(e,t)=>{const a={...e.body};if(a.items&&"string"==typeof a.items)try{a.items=JSON.parse(a.items)}catch(e){console.error("Failed to parse items:",e)}const n=await i.createInvoice(a,e.fileData);t.sendResponse(n,"Invoice created successfully")},createPayment:async(e,t)=>{const a=await i.createPayment(e.body);t.sendResponse(a,"Payment created successfully")},acceptInvoice:async(e,t)=>{const a=await i.acceptInvoice(e.params.id,e.user);t.sendResponse(a,"Invoice accepted and inventory updated")}}},228:(e,t,a)=>{const i=a(7252).Router(),n=a(7434),r=a(4081),s=a(6338),{fileUploadMiddleware:o,upload:d}=a(7799),c=["files"],{createInvoiceSchema:l,updateInvoiceSchema:u,createPaymentSchema:m}=a(8458);i.post("/invoices",d.fields(c.map((e=>({name:e,maxCount:1})))),o(c,"mani","invoices"),((e,t,a)=>{if(e.body.items&&"string"==typeof e.body.items)try{e.body.items=JSON.parse(e.body.items)}catch(e){console.error("Failed to parse items JSON:",e)}a()}),r(l),n(s.createInvoice)),i.post("/invoices/:id/payments",r(m),n(s.createPayment)),i.post("/invoices/:id/accept",n(s.acceptInvoice)),e.exports=i},5483:(e,t,a)=>{const{Op:i}=a(9031),n=a(9239),r=async(e,t)=>{const[a]=await n.SiteInventory.findOrCreate({where:{siteId:e.siteId,itemId:e.itemId},defaults:{quantity:0},transaction:t}),i="IN"===e.type?a.quantity+e.change:a.quantity-e.change,r=i<=0?"Out of Stock":"In Stock";await a.update({quantity:i,status:r},{transaction:t}),await n.StockLog.create(e,{transaction:t})};e.exports={createInvoice:async(e,t)=>{const a=await n.sequelize.transaction();try{const i=await n.Invoice.create({...e,files:t},{transaction:a});if(e.items&&Array.isArray(e.items))for(const t of e.items){await n.InvoiceItem.create({invoiceId:i.id,procurementItemId:t.procurementItemId,quantity:t.quantity,rate:t.rate,amount:t.amount},{transaction:a});const e=await n.ProcurementItem.findByPk(t.procurementItemId,{transaction:a});e&&await e.increment("receivedQuantity",{by:t.quantity,transaction:a})}return(await n.ProcurementItem.findAll({where:{procurementId:e.procurementId},transaction:a})).every((e=>e.receivedQuantity>=e.quantity))&&await n.Procurement.update({status:"delivered"},{where:{id:e.procurementId},transaction:a}),await a.commit(),i}catch(e){throw await a.rollback(),e}},createPayment:async e=>{const t=await n.sequelize.transaction();try{const a=await n.Invoice.findByPk(e.invoiceId,{include:[{model:n.Procurement,as:"procurement"}]});if(!a)throw new Error("Invoice not found");const i=await n.Payment.create({invoiceId:e.invoiceId,paymentDate:e.paymentDate,amount:e.amount,paymentMethod:e.paymentMethod,referenceNumber:e.referenceNumber,remarks:e.remarks,status:"COMPLETED"},{transaction:t});await i.update({slipUrl:""},{transaction:t});const r=await n.Payment.sum("amount",{where:{invoiceId:a.id,status:"COMPLETED"}});return r>=a.totalAmount?await a.update({status:"PAID"},{transaction:t}):r>0&&await a.update({status:"PARTIALLY_PAID"},{transaction:t}),await t.commit(),await n.Payment.findByPk(i.id,{include:[{model:n.Invoice,as:"invoice"}]})}catch(e){throw await t.rollback(),e}},acceptInvoice:async(e,t)=>{const a=await n.sequelize.transaction();try{const i=await n.Invoice.findByPk(e,{include:[{model:n.InvoiceItem,as:"items",include:[{model:n.ProcurementItem,include:[n.RequisitionItem]}]}],transaction:a});if(!i)throw new Error("Invoice not found");if(i.isInventoryUpdated)throw new Error("Inventory already updated for this invoice");let s=await n.Site.findOne({where:{type:"virtual"},attributes:["id"],transaction:a});if(!s?.id){const e=await n.Department.findOne({where:{name:"Mechanical"},transaction:a});s=await n.Site.create({name:"Virtual",type:"virtual",departmentId:e.id,address:"NA"},{transaction:a})}for(const e of i.items)await r({siteId:s.id,itemId:e.ProcurementItem.RequisitionItem.itemId,change:e.quantity,type:"IN",sourceType:"Procurement",sourceId:i.procurementId,userId:t.id},a);return await i.update({isInventoryUpdated:!0},{transaction:a}),await a.commit(),i}catch(e){throw await a.rollback(),e}}}},8458:(e,t,a)=>{const i=a(2446),n=i.object({procurementId:i.number().integer().positive().required(),invoiceNumber:i.string().required(),invoiceDate:i.date().required(),amount:i.number().precision(2).positive().required(),files:i.array().items(i.string().uri()).optional(),notes:i.string(),items:i.array().items(i.object({procurementItemId:i.number().integer().positive().required(),quantity:i.number().integer().positive().required(),rate:i.number().positive().required(),amount:i.number().positive().required()})).optional()}),r=n.keys({status:i.string().valid("DRAFT","SENT","PAID","PARTIALLY_PAID","CANCELLED")}),s=i.object({invoiceId:i.number().integer().positive().required(),paymentDate:i.date().required(),amount:i.number().positive().required(),paymentMethod:i.string().valid("CASH","CHEQUE","BANK_TRANSFER","ONLINE_PAYMENT","OTHER").required(),referenceNumber:i.string(),remarks:i.string()});e.exports={createInvoiceSchema:n,updateInvoiceSchema:r,createPaymentSchema:s}},8234:(e,t,a)=>{const{Op:i,or:n}=a(9031),r=a(9239),s=a(5771),o=a(7715);e.exports={createEntry:async(e,t)=>{const a=await r.LogbookEntry.create({...e.body,createdBy:e.user.id,status:"Pending"}),i=await r.LogbookEntry.findByPk(a.id,{include:[{model:r.Machinery,as:"machine",attributes:["id","machineName","machineNumber","registrationNumber","erpCode"]},{model:r.User,as:"creater",attributes:["id","name"]},{model:r.Site,as:"site",attributes:["id","name"]}]});await o({eventType:"LogbookEntry",eventAction:"Created",referenceId:i.id,siteId:i.siteId,createdBy:e.user.id,roles:[s.PROJECT_MANAGER],title:"New Logbook Entry Created",description:`A new logbook entry (${i.name}) has been created for machine ${i.machine?.machineName} at site ${i.site?.name}. Needs approval.`}),t.sendResponse(i,"Logbook entry created. Pending approval.")},allEntry:async(e,t)=>{const{machineId:a,date:i}=e.query,{siteId:n}=e.user,s={};n&&(s.siteId=n),a&&(s.machineId=a),i&&(s.date=i);const o=await r.LogbookEntry.findAll({where:s,attributes:["id","name","date","totalRunKM","dieselAvgKM","dieselIssue","totalRunHrsMeter","dieselAvgHrsMeter","dieselOpeningBalance","dieselClosingBalance","openingKmReading","closingKmReading","openingHrsMeter","closingHrsMeter","machineId","siteId","workingDetails","status"],include:[{model:r.Machinery,as:"machine",attributes:["id","machineName","erpCode"]},{model:r.Site,as:"site",attributes:["id","name"]}],order:[["createdAt","DESC"]]});t.sendResponse(o)},entryDetails:async(e,t)=>{const{siteId:a}=e.user,i=await r.LogbookEntry.findByPk(e.params.id,{include:[{model:r.Machinery,as:"machine",attributes:["id","machineName","machineNumber","registrationNumber","erpCode"]},{model:r.User,as:"creater",attributes:["id","name"]},{model:r.User,as:"approvedBy",attributes:["id","name"]},{model:r.User,as:"rejectedBy",attributes:["id","name"]},{model:r.Site,as:"site",attributes:["id","name","address"]}],where:{}});if(!i)return t.sendError({message:"Entry not found",name:"NotFoundError"},404);t.sendResponse(i)},updateEntry:async(e,t)=>{const a=await r.LogbookEntry.update(e.body,{where:{id:e.params.id}});t.sendResponse(a,"Logbook entry updated")},deleteEntry:async(e,t)=>{await r.LogbookEntry.destroy({where:{id:e.params.id}}),t.sendResponse({},"Logbook entry deleted")},allEntryV2:async(e,t)=>{const{machineId:a,date:n,page:s=1,limit:o=20,orderBy:d="date",orderDirection:c="DESC",search:l=""}=e.query,{siteId:u}=e.user,m=e.user,p=(s-1)*o,y={};u&&!m.siteId?y.siteId=u:!u&&m.siteId&&(y.siteId=m.siteId),a&&(y.machineId=a),n&&(y.date=n);const{rows:I,count:h}=await r.LogbookEntry.findAndCountAll({where:y,include:[{model:r.Machinery,as:"machine",attributes:["id","machineName","machineNumber","registrationNumber","erpCode"],where:l?{[i.or]:[{machineName:{[i.iLike]:`%${l}%`}},{machineNumber:{[i.iLike]:`%${l}%`}},{registrationNumber:{[i.iLike]:`%${l}%`}}]}:void 0},{model:r.User,as:"creater",attributes:["id","name"]},{model:r.Site,as:"site",attributes:["id","name"]}],order:[[d,c]],offset:p,limit:o});t.sendResponse({data:I,currentPage:Number(s),totalPages:Math.ceil(h/o),totalCount:h})},allMachines:async(e,t)=>{const a=e.query.siteId||e.user.siteId,{fn:i,col:n}=r.Sequelize,s={};a&&(s.siteId=a);const o=await r.Machinery.findAll({attributes:["id","machineName","machineNumber","registrationNumber","erpCode",[i("COALESCE",i("SUM",n("logbookEntries.dieselIssue")),0),"sumDieselIssue"],[i("COALESCE",i("SUM",n("logbookEntries.totalRunKM")),0),"sumTotalRunKM"],[i("COALESCE",i("SUM",n("logbookEntries.totalRunHrsMeter")),0),"sumTotalRunHrsMeter"],[n("site.name"),"siteName"],[n("site.address"),"siteLocation"],[n("site.id"),"siteId"]],where:s,include:[{model:r.LogbookEntry,as:"logbookEntries",attributes:[],required:!1},{model:r.Site,as:"site",attributes:[]}],group:["Machinery.id","Machinery.machineName","Machinery.machineNumber","Machinery.registrationNumber","Machinery.erpCode","site.name","site.address","site.id"],order:[["machineName","ASC"]],subQuery:!1});t.sendResponse(o)},approveEntry:async(e,t)=>{const{id:a}=e.params,i=await r.LogbookEntry.findByPk(a,{include:[{model:r.Machinery,as:"machine"}]});return i?"Pending"!==i.status?t.sendError({message:"Entry already processed"},400):(await r.sequelize.transaction((async t=>{i.status="Approved",i.approvedById=e.user.id,i.approvedAt=new Date,await i.save({transaction:t}),await r.Machinery.update({totalKmRun:i.totalRunKM||0,totalHoursRun:i.closingHrsMeter||0},{where:{id:i.machineId},transaction:t})})),await o({eventType:"LogbookEntry",eventAction:"Approved",referenceId:i.id,siteId:i.siteId,createdBy:e.user.id,roles:[s.STORE_MANAGER,s.SITE_INCHARGE],title:"Logbook Entry Approved",description:`Logbook entry ${i.name} has been approved by Project Manager.`}),void t.sendResponse(i,"Logbook entry approved")):t.sendError({message:"Entry not found"},404)},rejectEntry:async(e,t)=>{const{id:a}=e.params,{rejectionRemarks:i}=e.body,n=await r.LogbookEntry.findByPk(a);return n?"Pending"!==n.status?t.sendError({message:"Entry already processed"},400):(n.status="Rejected",n.rejectedById=e.user.id,n.rejectedAt=new Date,n.rejectionRemarks=i,await n.save(),await o({eventType:"LogbookEntry",eventAction:"Rejected",referenceId:n.id,siteId:n.siteId,createdBy:e.user.id,roles:[s.STORE_MANAGER,s.SITE_INCHARGE],title:"Logbook Entry Rejected",description:`Logbook entry ${n.name} has been rejected. Remarks: ${i||"None"}`}),void t.sendResponse(n,"Logbook entry rejected")):t.sendError({message:"Entry not found"},404)}}},5308:(e,t,a)=>{const i=a(7252),n=a(8234),r=(a(4081),a(7434)),s=a(7242),o=a(5771),d=i.Router();d.post("/logbook",s([o.SITE_INCHARGE,o.STORE_MANAGER,o.PROJECT_MANAGER]),r(n.createEntry)),d.get("/logbook",r(n.allEntry)),d.get("/logbook/site/machines",r(n.allMachines)),d.get("/logbook/:id",r(n.entryDetails)),d.post("/logbook/:id/approve",s([o.PROJECT_MANAGER]),r(n.approveEntry)),d.post("/logbook/:id/reject",s([o.PROJECT_MANAGER]),r(n.rejectEntry)),d.put("/logbook/:id",s([o.SITE_INCHARGE,o.STORE_MANAGER,o.PROJECT_MANAGER]),r(n.updateEntry)),d.delete("/logbook/:id",s([o.SITE_INCHARGE,o.STORE_MANAGER,o.PROJECT_MANAGER]),r(n.deleteEntry)),e.exports=d},6303:(e,t,a)=>{const i=a(6584);e.exports={requestTransfer:async(e,t)=>{const a=e.user,{machineId:n,currentSiteId:r,destinationSiteId:s,reason:o,requestType:d,buyerDetails:c,scrapDetails:l,vehicleType:u,transportDetails:m}=e.body;if(a.siteId!=r)return t.sendError({message:"You are not allowed to request transfer from this site",name:"AuthorizationError"},403);const p=await i.requestTransfer(n,r,s,o,a.id,d,c,l,m,u);t.sendResponse(p,"Transfer request created",201)},approveTranfer:async(e,t)=>{const{id:a}=e.params,n=e.user.id,{remarks:r}=e.body,s=await i.approveTranfer(a,n,r);t.sendResponse(s,"Transfer approved")},dispatchMachine:async(e,t)=>{const a=e.user,{id:n}=e.params,{vehicleNumber:r,driverName:s,mobileNumber:o,remarks:d,fuelGaugeReading:c,odometerReading:l,itemsIncluded:u,hrsMeter:m}=e.body,p={transportDetails:{vehicleNumber:r,driverName:s,mobileNumber:o},remarks:d,fuelGaugeReading:c,odometerReading:l,itemsIncluded:JSON.parse(u),hrsMeter:m,files:e.fileData?.files},y=await i.dispatchMachine(n,a.id,a.siteId,p);t.sendResponse(y,"Machine dispatched")},receiveMachine:async(e,t)=>{const a=e.user,{id:n}=e.params,{remarks:r,itemsReceived:s}=e.body,o=await i.receiveMachine(n,a.id,r,a.siteId,s);t.sendResponse(o,"Machine received")},transferHistory:async(e,t)=>{const a=e.user,{status:n}=e.query,r=await i.transferHistory(n,a.siteId);t.sendResponse(r)},transferHistoryOfMachine:async(e,t)=>{const{machineId:a}=e.params,n=await i.transferHistoryOfMachine(a);t.sendResponse(n)},rejectTransfer:async(e,t)=>{const{id:a}=e.params,n=e.user.id,{remarks:r}=e.body,s=await i.rejectTransfer(a,r,n);t.sendResponse(s,"Transfer rejected")},dispachtedList:async(e,t)=>{const a=e.user,n=await i.dispachtedList(a.siteId);t.sendResponse(n)},approvedList:async(e,t)=>{const a=e.user,n=await i.approvedList(a.siteId);t.sendResponse(n)},getTransferById:async(e,t)=>{const{id:a}=e.params,n=await i.getTransferById(a);t.sendResponse(n)}}},4509:(e,t,a)=>{const i=a(7252),n=a(6303),r=(a(4081),a(7434)),s=a(7242),{fileUploadMiddleware:o,upload:d}=a(7799),c=i.Router(),l=["files"];c.post("/transfer",s([4,5,6]),r(n.requestTransfer)),c.get("/transfer/:id",r(n.getTransferById)),c.put("/transfer/:id/approve",s([1,2,3]),r(n.approveTranfer)),c.put("/transfer/:id/reject",s([1,2,3]),r(n.rejectTransfer)),c.put("/transfer/:id/dispatch",s([4,5,6]),d.fields(l.map((e=>({name:e,maxCount:5})))),o(l,"mani","transfer"),r(n.dispatchMachine)),c.put("/transfer/:id/receive",s([4,5,6]),r(n.receiveMachine)),c.get("/transfers",r(n.transferHistory)),c.get("/transfers/machine/:machineId",r(n.transferHistoryOfMachine)),c.get("/transfers/dispatched",s([4,5,6]),r(n.dispachtedList)),c.get("/transfers/approved",s([4,5,6]),r(n.approvedList)),c.post("/file/upload",d.fields(l.map((e=>({name:e,maxCount:5})))),o(l,"mani","transfer"),(async(e,t)=>{t.status(200).json({files:e.fileData,message:"Files uploaded successfully"})})),e.exports=c},6584:(e,t,a)=>{const{Op:i}=a(9031),n=a(9239),r=a(7715),s=a(5771),o=async e=>n.Site.findByPk(e);e.exports={requestTransfer:async(e,t,a,i,d,c,l,u,m,p)=>{const y=await n.MachineTransfer.create({machineId:e,currentSiteId:t,destinationSiteId:a,reason:i,requestedBy:d,requestType:c,buyerDetails:l,scrapDetails:u,transportDetails:m,vehicleType:p});"Site Transfer"==c&&await n.Machinery.update({status:"In Transfer"},{where:{id:e}});const I=await o(t),h=await o(a||0);let g="",w="";return"Site Transfer"===c?(g="Machine Transfer Requested",w=`Machine transfer requested from Site ${I.name} to Site ${h.name}.`):"Sell Machine"===c?(g="Machine Sell Requested",w=`Request to sell machine from Site ${I.name}.`):"Scrap Machine"===c&&(g="Machine Scrap Requested",w=`Request to scrap machine from Site ${I.name}.`),await r({eventType:"MachineTransfer",eventAction:"Requested",referenceId:y.id,siteId:t,createdBy:d,roles:[s.ADMIN,s.MECHANICAL_HEAD,s.MECHANICAL_MANAGER,s.SITE_INCHARGE,s.STORE_MANAGER,s.PROJECT_MANAGER],title:g,description:w}),y},approveTranfer:async(e,t,a)=>{const i=await n.MachineTransfer.findByPk(e);if(!i)throw new Error("Transfer not found");if("Pending"!==i.status)throw new Error("Transfer not pending");if(i.status="Approved",i.approvedBy=t,i.approveRemarks=a,i.approvedAt=new Date,await i.save(),"Sell Machine"===i.requestType||"Scrap Machine"===i.requestType){const e=await n.Machinery.findByPk(i.machineId);"Sell Machine"===i.requestType&&(e.status="Sold"),"Scrap Machine"===i.requestType&&(e.status="Scrap"),e.siteId=null,await e.save()}let d="",c="";const l=await o(i.currentSiteId);return"Site Transfer"===i.requestType?(d="Machine Transfer Approved",c=`Transfer #${i.name} approved from Site ${l.name}.`):"Sell Machine"===i.requestType?(d="Machine Sell Approved",c=`Machine sell request approved for machine #${i.name}.`):"Scrap Machine"===i.requestType&&(d="Machine Scrap Approved",c=`Scrap request approved for machine #${i.name}.`),await r({eventType:"MachineTransfer",eventAction:"Approved",referenceId:i.id,siteId:i.currentSiteId,createdBy:t,roles:[s.SITE_INCHARGE,s.STORE_MANAGER,s.PROJECT_MANAGER,s.ADMIN,s.MECHANICAL_HEAD,s.MECHANICAL_MANAGER],title:d,description:c}),i},dispatchMachine:async(e,t,a,i)=>{const d=await n.MachineTransfer.findByPk(e);if(!d)throw new Error("Transfer not found");if("Approved"!==d.status)throw new Error("Transfer not approved yet");if(d.currentSiteId!==a)throw new Error("You are not allowed to dispatch this transfer");Object.assign(d,{status:"Dispatched",fuelGaugeReading:i.fuelGaugeReading,odometerReading:i.odometerReading,itemsIncluded:i.itemsIncluded,dispatchRemarks:i.remarks,dispatchedBy:t,transportDetails:i.transportDetails,dispatchedAt:new Date,files:i.files,hrsMeter:i.hrsMeter}),await d.save();const c=await o(d.currentSiteId);return"Site Transfer"===d.requestType&&await r({eventType:"MachineTransfer",eventAction:"Dispatched",referenceId:d.id,siteId:d.currentSiteId,createdBy:t,roles:[s.STORE_MANAGER,s.SITE_INCHARGE,s.PROJECT_MANAGER,s.ADMIN,s.MECHANICAL_HEAD,s.MECHANICAL_MANAGER],title:"Machine Dispatched",description:`Machine dispatched from Site ${c.name} for transfer #${d.name}.`}),d},receiveMachine:async(e,t,a,i,d)=>{const c=await n.MachineTransfer.findByPk(e);if(!c)throw new Error("Transfer not found");if("Dispatched"!==c.status)throw new Error("Transfer not dispatched yet");if(c.destinationSiteId!==i)throw new Error("You are not allowed to dispatch this transfer");c.status="Received",c.receivedBy=t,c.finalRemarks=a,c.receivedAt=new Date,c.itemsReceived=d,await c.save(),await n.Machinery.update({siteId:c.destinationSiteId,status:"In Use"},{where:{id:c.machineId}});const l=await o(c.destinationSiteId);return"Site Transfer"===c.requestType&&await r({eventType:"MachineTransfer",eventAction:"Received",referenceId:c.id,siteId:c.destinationSiteId,createdBy:t,roles:[s.STORE_MANAGER,s.SITE_INCHARGE,s.PROJECT_MANAGER,s.ADMIN,s.MECHANICAL_HEAD,s.MECHANICAL_MANAGER],title:"Machine Received",description:`Machine received at Site ${l.name} for transfer #${c.name}.`}),c},transferHistory:async(e,t)=>{const a={};return e&&(a.status=e),t&&(a[i.or]=[{currentSiteId:t},{destinationSiteId:t}]),await n.MachineTransfer.findAll({where:a,include:[{model:n.Machinery,as:"machine",attributes:["machineName"]},{model:n.Site,as:"currentSite",attributes:["id","name"]},{model:n.Site,as:"destinationSite",attributes:["id","name"]}],order:[["createdAt","DESC"]]})},transferHistoryOfMachine:async e=>await n.MachineTransfer.findAll({where:{machineId:e},order:[["createdAt","DESC"]]}),rejectTransfer:async(e,t,a)=>{const i=await n.MachineTransfer.findByPk(e);if(!i)throw new Error("Transfer not found");if("Pending"!==i.status)throw new Error("Transfer not pending");i.status="Rejected",i.rejectionRemarks=t,i.rejectedBy=a,i.rejectedAt=new Date,await i.save(),await n.Machinery.update({status:"In Use"},{where:{id:i.machineId}});let d="",c="";const l=await o(i.currentSiteId);return"Site Transfer"===i.requestType?(d="Machine Transfer Rejected",c=`Transfer #${i.name} from Site ${l.name} rejected.`):"Sell Machine"===i.requestType?(d="Machine Sell Rejected",c=`Sell request for machine #${i.machineId} was rejected.`):"Scrap Machine"===i.requestType&&(d="Machine Scrap Rejected",c=`Scrap request for machine #${i.machineId} was rejected.`),await r({eventType:"MachineTransfer",eventAction:"Rejected",referenceId:i.id,siteId:i.currentSiteId,createdBy:a,roles:[s.SITE_INCHARGE,s.STORE_MANAGER,s.PROJECT_MANAGER,s.ADMIN,s.MECHANICAL_HEAD,s.MECHANICAL_MANAGER],title:d,description:c}),i},dispachtedList:async e=>await n.MachineTransfer.findAll({where:{status:"Dispatched",destinationSiteId:e},include:[{model:n.Machinery,as:"machine",attributes:["machineName"]},{model:n.Site,as:"currentSite",attributes:["id","name"]},{model:n.Site,as:"destinationSite",attributes:["id","name"]},{model:n.User,as:"requester",attributes:["id","name"]},{model:n.User,as:"approver",attributes:["id","name"]},{model:n.User,as:"dispatcher",attributes:["id","name"]},{model:n.User,as:"receiver",attributes:["id","name"]}]}),approvedList:async e=>await n.MachineTransfer.findAll({where:{status:"Approved",currentSiteId:e},include:[{model:n.Machinery,as:"machine",attributes:["machineName"]},{model:n.Site,as:"currentSite",attributes:["id","name"]},{model:n.Site,as:"destinationSite",attributes:["id","name"]},{model:n.User,as:"requester",attributes:["id","name"]},{model:n.User,as:"approver",attributes:["id","name"]},{model:n.User,as:"dispatcher",attributes:["id","name"]},{model:n.User,as:"receiver",attributes:["id","name"]}]}),getTransferById:async e=>await n.MachineTransfer.findByPk(e,{include:[{model:n.Machinery,as:"machine",attributes:["machineName","registrationNumber","erpCode","machineNumber","machineCode","serialNumber","model","chassisNumber","engineNumber"]},{model:n.Site,as:"currentSite",attributes:["id","name","code"]},{model:n.Site,as:"destinationSite",attributes:["id","name","code"]},{model:n.User,as:"requester",attributes:["id","name"]},{model:n.User,as:"approver",attributes:["id","name"]},{model:n.User,as:"dispatcher",attributes:["id","name"]},{model:n.User,as:"receiver",attributes:["id","name"]}]})}},3118:(e,t,a)=>{const i=a(4815);e.exports={createMachinery:async function(e,t){const a={...e.body,...e.fileData},n=await i.createMachinery(a);t.sendResponse(n,"Machinery created successfully",201)},getAllMachinery:async function(e,t){const a=await i.getAllMachinery(e.user.siteId??e.query.siteId,e.query.searchQuery,e.query.activity);t.sendResponse(a,"Machinery list retrieved successfully")},getMachineryById:async function(e,t){const a=await i.getMachineryById(e.params.id);if(!a){const e=new Error;throw e.message="Machinery not found",e.name="ResourceNotFoundError",e.statusCode=404,e}t.sendResponse(a,"Machinery retrieved successfully")},updateMachinery:async function(e,t){const a={...e.body,...e.fileData},n=await i.updateMachinery(e.params.id,a);t.sendResponse(n,"Machinery updated successfully")},deleteMachinery:async function(e,t){await i.deleteMachinery(e.params.id),t.sendResponse(null,"Machinery deleted successfully")},restoreMachinery:async function(e,t){const a=await i.restoreMachinery(e.params.id);t.sendResponse(a,"Machinery restored successfully")},getMachineryLogEntries:async function(e,t){const a=await i.getMachineryLogEntries(e.params.id);if(!a){const e=new Error;throw e.message="Machinery not found",e.name="ResourceNotFoundError",e.statusCode=404,e}t.sendResponse(a,"Machinery retrieved successfully")}}},4456:(e,t,a)=>{const i=a(7252),n=a(3118),r=a(4081),s=a(7434),{createMachinerySchema:o,updateMachinerySchema:d}=a(2398),{upload:c,fileUploadMiddleware:l}=a(7799),{getExistingFiles:u}=a(4815),m=a(7242),p=i.Router(),y=["fitnessCertificateFile","pollutionCertificateFile","insuranceFile","permitFile","nationalPermitFile","motorVehicleTaxFile","machineImageFile"];p.post("/",m([1,2,3]),c.fields(y.map((e=>({name:e,maxCount:1})))),l(y,"mani","machinery"),r(o),s(n.createMachinery)),p.put("/:id",m([1,2,3]),c.fields(y.map((e=>({name:e,maxCount:1})))),l(y,"mani","machinery",u),r(d),s(n.updateMachinery)),p.get("/",s(n.getAllMachinery)),p.get("/:id",s(n.getMachineryById)),p.get("/:id/log-entries",s(n.getMachineryLogEntries)),p.delete("/:id",m([1,2,3]),s(n.deleteMachinery)),e.exports=p},4815:(e,t,a)=>{const{fn:i,col:n}=a(9031),r=a(9239);class s extends Error{constructor(e,t){super(e),this.statusCode=t}}e.exports={async createMachinery(e){const t=await r.sequelize.transaction();try{const a=await r.Machinery.create(e,{transaction:t});return await t.commit(),a}catch(e){throw await t.rollback(),new s(e.original.sqlMessage||"Failed to create machinery",500)}},async getAllMachinery(e,t){const a={};if(e&&(a.siteId=e),t){const e={[r.Sequelize.Op.like]:`%${t}%`};a[r.Sequelize.Op.or]=[{machineName:e},{erpCode:e},{machineCode:e},{serialNumber:e},{registrationNumber:e}]}const i=[{model:r.PrimaryCategory,as:"primaryCategory",attributes:["name","id"]},{model:r.MachineCategory,as:"machineCategory",attributes:["name","id"]},{model:r.Site,as:"site",attributes:["name","id","code","address"]}];return await r.Machinery.findAll({where:a,include:i,attributes:["id","erpCode","machineName","status","siteId","machineCode","machineNumber","registrationNumber","chassisNumber","engineNumber","serialNumber","model","isActive"]})},async getAllMachineryV2(e,t,a=1,i=10){const{Op:n}=r.Sequelize,s=(a-1)*i,o={...t&&{[n.or]:[{machineName:{[n.like]:`%${t}%`}},{erpCode:{[n.like]:`%${t}%`}},{machineCode:{[n.like]:`%${t}%`}},{serialNumber:{[n.like]:`%${t}%`}},{registrationNumber:{[n.like]:`%${t}%`}}]},...e&&{siteId:e}},{count:d,rows:c}=await r.Machinery.findAndCountAll({where:o,include:[{model:r.PrimaryCategory,as:"primaryCategory",attributes:["id","name"]},{model:r.MachineCategory,as:"machineCategory",attributes:["id","name"]},{model:r.Site,as:"site",attributes:["id","name","code","address"]}],limit:i,offset:s,order:[["createdAt","DESC"]]});return{data:c,totalCount:d,totalPages:Math.ceil(d/i),currentPage:Number(a)}},async getMachineryById(e){const t=await r.Machinery.findByPk(e,{include:[{model:r.PrimaryCategory,as:"primaryCategory"},{model:r.MachineCategory,as:"machineCategory"},{model:r.Site,as:"site"}]});if(!t){const e=new Error;throw e.message="Machinery not found",e.name="ResourceNotFoundError",e.statusCode=404,e}const a=await r.LogbookEntry.findOne({attributes:[[i("COALESCE",i("SUM",n("dieselIssue")),0),"sumDieselIssue"],[i("COALESCE",i("SUM",n("totalRunKM")),0),"sumTotalRunKM"],[i("COALESCE",i("SUM",n("totalRunHrsMeter")),0),"sumTotalRunHrsMeter"]],where:{machineId:e},raw:!0});return{...t?.dataValues,...a}},getMachineryLogEntries:async e=>await r.LogbookEntry.findAll({where:{machineId:e},order:[["createdAt","DESC"]]}),async updateMachinery(e,t){const a=await r.Machinery.findByPk(e);return a?await a.update(t):null},async deleteMachinery(e){const t=await r.Machinery.findByPk(e);return t?(await t.destroy(),!0):null},async getExistingFiles(e){const t=await r.Machinery.findByPk(e,{attributes:["fitnessCertificateFile","pollutionCertificateFile","insuranceFile","permitFile","nationalPermitFile"]});return t?t.toJSON():{}}}},2398:(e,t,a)=>{const i=a(2446),n=i.object({primaryCategoryId:i.number().integer().positive().required(),machineCategoryId:i.number().integer().positive().required(),erpCode:i.string().trim().allow(null).optional(),registrationNumber:i.string().trim().allow(null).optional(),machineNumber:i.string().trim().allow(null).optional(),machineCode:i.string().trim().allow(null).optional(),chassisNumber:i.string().trim().allow(null).optional(),engineNumber:i.string().trim().allow(null).optional(),serialNumber:i.string().trim().allow(null).optional(),model:i.string().trim().allow(null).optional(),make:i.string().trim().allow(null).optional(),yom:i.number().integer().min(1900).max((new Date).getFullYear()).allow(null).optional(),purchaseDate:i.date().iso().allow(null).optional(),capacity:i.string().trim().allow(null).optional(),ownerName:i.string().trim().allow(null).optional(),ownerType:i.string().valid("Company","Individual").allow(null).optional(),siteId:i.number().integer().positive().allow(null).optional(),isActive:i.boolean().default(!0),machineName:i.string().trim().allow(null).optional(),fitnessCertificateExpiry:i.date().iso().allow(null).optional(),motorVehicleTaxDue:i.date().iso().allow(null).optional(),permitExpiryDate:i.date().iso().allow(null).optional(),nationalPermitExpiry:i.date().iso().allow(null).optional(),insuranceExpiry:i.date().iso().allow(null).optional(),pollutionCertificateExpiry:i.date().iso().allow(null).optional(),status:i.string().valid("Idle","In Use","In Transfer","Sold","Scrap").default("Idle"),fitnessCertificateFile:i.any(),pollutionCertificateFile:i.any(),insuranceFile:i.any(),permitFile:i.any(),nationalPermitFile:i.any(),motorVehicleTaxFile:i.any(),machineImageFile:i.any()}),r=i.object({primaryCategoryId:i.number().integer().positive(),machineCategoryId:i.number().integer().positive(),erpCode:i.string().trim(),registrationNumber:i.string().trim(),machineNumber:i.string().trim(),machineCode:i.string().trim(),chassisNumber:i.string().trim(),engineNumber:i.string().trim(),serialNumber:i.string().trim(),model:i.string().trim(),make:i.string().trim(),yom:i.number().integer().min(1900).max((new Date).getFullYear()),purchaseDate:i.date().iso(),capacity:i.string().trim(),ownerName:i.string().trim(),ownerType:i.string().valid("Company","Individual"),siteId:i.number().integer().positive(),isActive:i.boolean(),machineName:i.string().trim(),fitnessCertificateExpiry:i.date().iso(),motorVehicleTaxDue:i.date().iso(),permitExpiryDate:i.date().iso(),nationalPermitExpiry:i.date().iso(),insuranceExpiry:i.date().iso(),pollutionCertificateExpiry:i.date().iso(),status:i.string().valid("Idle","In Use","In Transfer","Sold","Scrap")});e.exports={createMachinerySchema:n,updateMachinerySchema:r}},1418:(e,t,a)=>{const i=a(4083);e.exports={createMachineryItemCode:async function(e,t){const a=await i.createMachineryItemCode(e.body);t.sendResponse(a,"Machinery Item Code created successfully",201)},getAllMachineryItemCodes:async function(e,t){const a=await i.getAllMachineryItemCodes();t.sendResponse(a,"Machinery Item Codes retrieved successfully")},getMachineryItemCodeById:async function(e,t){const a=await i.getMachineryItemCodeById(e.params.id);if(!a){const e=new Error;throw e.message="Machinery Item Code not found",e.name="ResourceNotFoundError",e.statusCode=404,e}t.sendResponse(a,"Machinery Item Code retrieved successfully")},updateMachineryItemCode:async function(e,t){const a=await i.updateMachineryItemCode(e.params.id,e.body);t.sendResponse(a,"Machinery Item Code updated successfully")},deleteMachineryItemCode:async function(e,t){await i.deleteMachineryItemCode(e.params.id),t.sendResponse(null,"Machinery Item Code deleted successfully")},restoreMachineryItemCode:async function(e,t){const a=await i.restoreMachineryItemCode(e.params.id);t.sendResponse(a,"Machinery Item Code restored successfully")}}},8892:(e,t,a)=>{const i=a(7252),n=a(1418),r=a(4081),s=a(3170),o=a(7434),d=i.Router();d.post("/",r(s.createMachineryItemCodeSchema),o(n.createMachineryItemCode)),d.get("/",o(n.getAllMachineryItemCodes)),d.get("/:id",o(n.getMachineryItemCodeById)),d.put("/:id",r(s.updateMachineryItemCodeSchema),o(n.updateMachineryItemCode)),d.delete("/:id",o(n.deleteMachineryItemCode)),d.post("/:id/restore",o(n.restoreMachineryItemCode)),e.exports=d},4083:(e,t,a)=>{const i=a(9239);async function n(e){return await i.MachineryItemCode.findByPk(e)}e.exports={createMachineryItemCode:async function(e){return await i.MachineryItemCode.create(e)},getAllMachineryItemCodes:async function(){return await i.MachineryItemCode.findAll()},getMachineryItemCodeById:n,updateMachineryItemCode:async function(e,t){const a=await n(e);if(!a)throw new Error("Machinery Item Code not found");return await a.update(t)},deleteMachineryItemCode:async function(e){return await i.MachineryItemCode.destroy({where:{id:e}})},restoreMachineryItemCode:async function(e){return await i.MachineryItemCode.restore({where:{id:e}})}}},3170:(e,t,a)=>{const i=a(2446),n=i.object({code:i.string().min(1).max(50).required().messages({"string.base":"Code must be a string","string.empty":"Code is required","string.min":"Code must be at least 1 character","string.max":"Code must not exceed 50 characters","any.required":"Code is required"}),name:i.string().min(1).max(100).required().messages({"string.base":"Name must be a string","string.empty":"Name is required","string.min":"Name must be at least 1 character","string.max":"Name must not exceed 100 characters","any.required":"Name is required"}),remarks:i.string().optional().allow("").messages({"string.base":"Remarks must be a string"})}),r=i.object({code:i.string().min(1).max(50).optional(),name:i.string().min(1).max(100).optional(),remarks:i.string().optional().allow("")});e.exports={createMachineryItemCodeSchema:n,updateMachineryItemCodeSchema:r}},2904:(e,t,a)=>{const i=a(9453);e.exports={getMachineServiceIntervals:async(e,t)=>{try{const{machineId:a}=e.params,n=await i.getMachineServiceIntervals(a);t.sendResponse(n,"Machine service intervals retrieved successfully")}catch(e){t.sendError(e.message,500)}},getMachineServiceIntervalById:async(e,t)=>{try{const{id:a}=e.params,n=await i.getMachineServiceIntervalById(a);if(!n)return t.sendError("Machine service interval not found",404);t.sendResponse(n,"Machine service interval retrieved successfully")}catch(e){t.sendError(e.message,500)}},createMachineServiceInterval:async(e,t)=>{try{const a=await i.createMachineServiceInterval(e.body);t.sendResponse(a,"Machine service interval created successfully")}catch(e){t.sendError(e.message,500)}},updateMachineServiceInterval:async(e,t)=>{try{const{id:a}=e.params,n=await i.updateMachineServiceInterval(a,e.body);t.sendResponse(n,"Machine service interval updated successfully")}catch(e){t.sendError(e.message,500)}},deleteMachineServiceInterval:async(e,t)=>{try{const{id:a}=e.params;await i.deleteMachineServiceInterval(a),t.sendResponse(null,"Machine service interval deleted successfully")}catch(e){t.sendError(e.message,500)}},getDueMachineServiceIntervals:async(e,t)=>{try{const e=await i.getDueMachineServiceIntervals();t.sendResponse(e,"Due machine service intervals retrieved successfully")}catch(e){t.sendError(e.message,500)}},calculateNextServiceForMachine:async(e,t)=>{try{const{machineId:a}=e.params,n=await i.calculateNextServiceForMachine(a);t.sendResponse(n,"Next service calculations retrieved successfully")}catch(e){t.sendError(e.message,500)}}}},4366:(e,t,a)=>{const i=a(7252).Router(),n=a(2904),r=a(4081),s=a(7434),{createMachineServiceIntervalSchema:o,updateMachineServiceIntervalSchema:d}=a(8832);i.get("/machine/:machineId",s(n.getMachineServiceIntervals)),i.get("/due",s(n.getDueMachineServiceIntervals)),i.get("/next/:machineId",s(n.calculateNextServiceForMachine)),i.get("/:id",s(n.getMachineServiceIntervalById)),i.post("/",r(o),s(n.createMachineServiceInterval)),i.put("/:id",r(d),s(n.updateMachineServiceInterval)),i.delete("/:id",s(n.deleteMachineServiceInterval)),e.exports=i},9453:(e,t,a)=>{const{Op:i}=a(9031),n=a(9239);e.exports={getMachineServiceIntervals:async e=>await n.MachineServiceInterval.findAll({where:{machineId:e,isActive:!0},order:[["serviceType","ASC"]]}),getMachineServiceIntervalById:async e=>await n.MachineServiceInterval.findByPk(e),createMachineServiceInterval:async e=>(e.lastServiceValue&&e.intervalValue&&(e.nextServiceValue=e.lastServiceValue+e.intervalValue),await n.MachineServiceInterval.create(e)),updateMachineServiceInterval:async(e,t)=>{const a=await n.MachineServiceInterval.findByPk(e);if(!a)throw new Error("Machine service interval not found");return t.lastServiceValue&&t.intervalValue?t.nextServiceValue=t.lastServiceValue+t.intervalValue:t.intervalValue&&a.lastServiceValue&&(t.nextServiceValue=a.lastServiceValue+t.intervalValue),await a.update(t)},deleteMachineServiceInterval:async e=>{const t=await n.MachineServiceInterval.findByPk(e);if(!t)throw new Error("Machine service interval not found");return await t.destroy()},getDueMachineServiceIntervals:async()=>{const e=new Date;return await n.MachineServiceInterval.findAll({where:{isActive:!0,[i.or]:[{intervalType:"hours",nextServiceValue:{[i.lte]:n.sequelize.literal("(SELECT COALESCE(MAX(closingHrsMeter), 0) FROM logbook_entries WHERE machineId = MachineServiceInterval.machineId)")}},{intervalType:"kilometers",nextServiceValue:{[i.lte]:n.sequelize.literal("(SELECT COALESCE(MAX(closingKmReading), 0) FROM logbook_entries WHERE machineId = MachineServiceInterval.machineId)")}},{intervalType:"calendar",nextServiceDate:{[i.lte]:e}}]},include:[{model:n.Machinery,as:"machine"}]})},calculateNextServiceForMachine:async e=>{const t=await n.MachineServiceInterval.findAll({where:{machineId:e,isActive:!0}}),a=[];for(const i of t){let t=!1,r=null,s=null;if("hours"===i.intervalType||"kilometers"===i.intervalType){const a=await n.LogbookEntry.findOne({where:{machineId:e},order:[["date","DESC"]]});a&&(r="hours"===i.intervalType?a.closingHrsMeter:a.closingKmReading,r&&i.nextServiceValue&&(s=i.nextServiceValue-r,t=r>=i.nextServiceValue))}else"calendar"===i.intervalType&&i.nextServiceDate&&(r=new Date,s=(new Date(i.nextServiceDate)-new Date)/864e5,t=new Date>=new Date(i.nextServiceDate));a.push({...i.toJSON(),isDue:t,currentValue:r,remaining:s})}return a}}},8832:(e,t,a)=>{const i=a(2446),n=i.object({machineId:i.number().integer().required(),serviceType:i.string().required(),intervalHours:i.number().integer().optional(),intervalKm:i.number().integer().optional(),intervalCalendarDays:i.number().integer().optional(),isActive:i.boolean().optional(),notes:i.string().optional().allow(null,"")}),r=i.object({machineId:i.number().integer().optional(),serviceType:i.string().optional(),intervalHours:i.number().integer().optional(),intervalKm:i.number().integer().optional(),intervalCalendarDays:i.number().integer().optional(),isActive:i.boolean().optional(),notes:i.string().optional().allow(null,"")}).min(1);e.exports={createMachineServiceIntervalSchema:n,updateMachineServiceIntervalSchema:r}},1010:(e,t,a)=>{const i=a(9435);e.exports={getMaintenanceLogById:async(e,t)=>{const a=await i.getMaintenanceLogById(e.params.id);t.sendResponse(a,"Maintenance log fetched successfully")},createMaintenanceLog:async(e,t)=>{const a=await i.createMaintenanceLog(e.body);t.sendResponse(a,"Maintenance log created successfully")},updateMaintenanceLog:async(e,t)=>{const a=await i.updateMaintenanceLog(e.params.id,e.body);t.sendResponse(a,"Maintenance log updated successfully")},getMaintenanceLogsByMachine:async(e,t)=>{const a=await i.getMaintenanceLogsByMachine(e.params.machineId);t.sendResponse(a,"Maintenance logs fetched successfully")},getScheduledMaintenanceById:async(e,t)=>{const a=await i.getScheduledMaintenanceById(e.params.id);t.sendResponse(a,"Scheduled maintenance fetched successfully")},createScheduledMaintenance:async(e,t)=>{const a=await i.createScheduledMaintenance(e.body);t.sendResponse(a,"Scheduled maintenance created successfully")},updateScheduledMaintenance:async(e,t)=>{const a=await i.updateScheduledMaintenance(e.params.id,e.body);t.sendResponse(a,"Scheduled maintenance updated successfully")},completeScheduledMaintenance:async(e,t)=>{const a=await i.updateScheduledMaintenance(e.params.id,{status:"completed"});t.sendResponse(a,"Scheduled maintenance marked as completed successfully")},getScheduledMaintenancesByMachine:async(e,t)=>{const a=await i.getScheduledMaintenancesByMachine(e.params.machineId);t.sendResponse(a,"Scheduled maintenance list fetched successfully")},getMaintenanceStatsByMachine:async(e,t)=>{const a=await i.getMaintenanceStatsByMachine(e.params.machineId);t.sendResponse(a,"Maintenance stats fetched successfully")},getLastMaintenanceByMachine:async(e,t)=>{const a=await i.getLastMaintenanceByMachine(e.params.machineId);t.sendResponse(a,"Last maintenance fetched successfully")},getNextMaintenanceByMachine:async(e,t)=>{const a=await i.getNextMaintenanceByMachine(e.params.machineId);t.sendResponse(a,"Next maintenance fetched successfully")},getMaintenanceAlerts:async(e,t)=>{const a=await i.getMaintenanceAlerts(e.params.machineId);t.sendResponse(a,"Maintenance alerts fetched successfully")},getMaintenanceSummaryByMachine:async(e,t)=>{const a=await i.getMaintenanceSummaryByMachine(e.params.machineId);t.sendResponse(a,"Maintenance summary fetched successfully")}}},612:(e,t,a)=>{const i=a(7252).Router(),n=a(1010),r=a(4081),{createMaintenanceLogSchema:s,updateMaintenanceLogSchema:o,createScheduledMaintenanceSchema:d,updateScheduledMaintenanceSchema:c}=a(4602),l=a(7434);i.get("/logs/:id",l(n.getMaintenanceLogById)),i.post("/logs",r(s),l(n.createMaintenanceLog)),i.put("/logs/:id",r(o),l(n.updateMaintenanceLog)),i.get("/logs/machine/:machineId",l(n.getMaintenanceLogsByMachine)),i.get("/scheduled/:id",l(n.getScheduledMaintenanceById)),i.post("/scheduled",r(d),l(n.createScheduledMaintenance)),i.put("/scheduled/:id",r(c),l(n.updateScheduledMaintenance)),i.put("/scheduled/:id/complete",l(n.completeScheduledMaintenance)),i.get("/scheduled/machine/:machineId",l(n.getScheduledMaintenancesByMachine)),i.get("/stats/:machineId",l(n.getMaintenanceStatsByMachine)),i.get("/last-maintenance/:machineId",l(n.getLastMaintenanceByMachine)),i.get("/next-maintenance/:machineId",l(n.getNextMaintenanceByMachine)),i.get("/alerts/:machineId",l(n.getMaintenanceAlerts)),i.get("/summary/:machineId",l(n.getMaintenanceSummaryByMachine));const u=a(4366);i.use("/intervals",u),e.exports=i},9435:(e,t,a)=>{const{Op:i}=a(9031),n=a(9239),{MaintenanceLog:r}=n,s=async e=>await r.findOne({where:{machineId:e},order:[["date","DESC"]],include:[{model:n.Machinery,as:"machine"}]}),o=async e=>{const t=new Date;return await r.findOne({where:{machineId:e,status:{[i.in]:["scheduled","overdue","due_today"]},dueDate:{[i.gte]:t}},order:[["dueDate","ASC"]],include:[{model:n.Machinery,as:"machine"}]})},d=async e=>{const t=new Date;(new Date).setDate(t.getDate()+1);const a=new Date;return a.setDate(t.getDate()+7),(await r.findAll({where:{machineId:e,status:{[i.in]:["scheduled","overdue","due_today"]},dueDate:{[i.gte]:t},dueDate:{[i.lte]:a}},order:[["dueDate","ASC"]],include:[{model:n.Machinery,as:"machine"}]})).map((e=>{const a=new Date(e.dueDate);let i="upcoming";return a.toDateString()===t.toDateString()?i="due_today":a<new Date(t.getFullYear(),t.getMonth(),t.getDate()+2)&&(i="due_soon"),{...e.toJSON(),alertStatus:i}}))};e.exports={getMaintenanceLogById:async e=>await r.findByPk(e),createMaintenanceLog:async e=>await r.create(e),updateMaintenanceLog:async(e,t)=>{const a=await r.findByPk(e);if(!a)throw new Error("Maintenance log not found");return await a.update(t)},getMaintenanceLogsByMachine:async e=>await r.findAll({where:{machineId:e},order:[["date","DESC"]]}),getScheduledMaintenanceById:async e=>await r.findByPk(e),createScheduledMaintenance:async e=>(e.status="scheduled",await r.create(e)),updateScheduledMaintenance:async(e,t)=>{const a=await r.findByPk(e);if(!a)throw new Error("Maintenance log not found");return"completed"===t.status&&(t.status="completed",t.lastAlertDate=new Date),await a.update(t)},getScheduledMaintenancesByMachine:async e=>await r.findAll({where:{machineId:e,status:{[i.in]:["scheduled","overdue","due_today"]}},order:[["dueDate","ASC"]]}),getLastMaintenanceByMachine:s,getNextMaintenanceByMachine:o,getMaintenanceAlerts:d,getMaintenanceSummaryByMachine:async e=>{const t=new Date,[a,n]=await Promise.all([s(e),o(e)]);return{lastMaintenance:a||null,nextMaintenance:n||null,alerts:await d(e),totalMaintenanceCount:await r.count({where:{machineId:e}}),overdueCount:await r.count({where:{machineId:e,dueDate:{[i.lt]:t},status:{[i.in]:["scheduled","due_today"]}}})}},getMaintenanceStatsByMachine:async e=>{const t=new Date,a=new Date(t.getFullYear(),0,1),n=await r.count({where:{machineId:e}}),s=await r.findOne({where:{machineId:e},order:[["date","DESC"]]}),o=await r.findOne({where:{machineId:e,status:{[i.in]:["scheduled","overdue","due_today"]},dueDate:{[i.gte]:t}},order:[["dueDate","ASC"]]}),d=(await r.findAll({where:{machineId:e,date:{[i.gte]:a}},attributes:["cost"]})).reduce(((e,t)=>e+parseFloat(t.cost||0)),0),c=await r.findAll({where:{machineId:e},attributes:["type"]}),l={repair:0,preventive:0,inspection:0,oil_change:0,parts_replacement:0};return c.forEach((e=>{void 0!==l[e.type]&&l[e.type]++})),{totalRecords:n,lastMaintenanceDate:s?s.date:null,nextScheduledDate:o?o.dueDate:null,totalCostYTD:parseFloat(d.toFixed(2)),typeCounts:l}}}},4602:(e,t,a)=>{const i=a(2446),n=i.object({machineId:i.number().integer().positive().required(),type:i.string().valid("servicing","custom","hydraulic_service","engine_service").optional().allow(null,""),date:i.date().optional().allow(null),title:i.string().required(),description:i.string().optional().allow(null,""),parts:i.string().optional().allow(null,""),cost:i.number().precision(2).optional().allow(null),technician:i.string().optional().allow(null,""),status:i.string().valid("completed","in_progress","scheduled","overdue","due_today").required(),kilometersAtService:i.number().integer().optional().allow(null),hoursAtService:i.number().integer().optional().allow(null),vendorAndPartsDetails:i.array().items(i.object()).optional().allow(null),dueDate:i.date().optional().allow(null),estimatedHours:i.number().optional().allow(null),estimatedCost:i.number().precision(2).optional().allow(null),priority:i.string().valid("low","medium","high").optional().allow(null).default("medium"),assignedTo:i.string().optional().allow(null,""),lastAlertDate:i.date().optional().allow(null)}),r=i.object({machineId:i.number().integer().positive().optional(),type:i.string().valid("servicing","custom","hydraulic_service","engine_service").optional().allow(null,""),date:i.date().optional().allow(null),title:i.string().optional().allow(null,""),description:i.string().optional().allow(null,""),parts:i.string().optional().allow(null,""),cost:i.number().precision(2).optional().allow(null),technician:i.string().optional().allow(null,""),status:i.string().valid("completed","in_progress","scheduled","overdue","due_today").optional(),kilometersAtService:i.number().integer().optional().allow(null),hoursAtService:i.number().integer().optional().allow(null),vendorAndPartsDetails:i.array().items(i.object()).optional().allow(null),dueDate:i.date().optional().allow(null),estimatedHours:i.number().optional().allow(null),estimatedCost:i.number().precision(2).optional().allow(null),priority:i.string().valid("low","medium","high").optional().allow(null),assignedTo:i.string().optional().allow(null,""),lastAlertDate:i.date().optional().allow(null)}),s=i.object({machineId:i.number().integer().positive().required(),title:i.string().required(),type:i.string().valid("servicing","custom","hydraulic_service","engine_service").optional().allow(null,""),dueDate:i.date().required(),estimatedHours:i.number().optional().allow(null),estimatedCost:i.number().precision(2).optional().allow(null),priority:i.string().valid("low","medium","high").optional().default("medium"),assignedTo:i.string().optional().allow(null,""),status:i.string().valid("scheduled","overdue","due_today").optional().default("scheduled"),description:i.string().optional().allow(null,""),parts:i.string().optional().allow(null,""),cost:i.number().precision(2).optional().allow(null),technician:i.string().optional().allow(null,""),hoursAtService:i.number().integer().optional().allow(null),vendorAndPartsDetails:i.array().items(i.object()).optional().allow(null)}),o=i.object({machineId:i.number().integer().positive().optional(),title:i.string().optional().allow(null,""),type:i.string().valid("servicing","custom","hydraulic_service","engine_service").optional().allow(null,""),dueDate:i.date().optional().allow(null),estimatedHours:i.number().optional().allow(null),estimatedCost:i.number().precision(2).optional().allow(null),priority:i.string().valid("low","medium","high").optional().allow(null),assignedTo:i.string().optional().allow(null,""),status:i.string().valid("completed","in_progress","scheduled","overdue","due_today").optional(),description:i.string().optional().allow(null,""),parts:i.string().optional().allow(null,""),cost:i.number().precision(2).optional().allow(null),technician:i.string().optional().allow(null,""),hoursAtService:i.number().integer().optional().allow(null),vendorAndPartsDetails:i.array().items(i.object()).optional().allow(null),lastAlertDate:i.date().optional().allow(null),date:i.date().optional().allow(null)});e.exports={createMaintenanceLogSchema:n,updateMaintenanceLogSchema:r,createScheduledMaintenanceSchema:s,updateScheduledMaintenanceSchema:o}},1651:(e,t,a)=>{const i=a(8756);e.exports={createMaterialIssue:async(e,t)=>{const a=e.user.id,n=await i.createMaterialIssue(e.body,a);t.sendResponse(n,"Material issue created successfully")},getMaterialIssueById:async(e,t)=>{const a=await i.getMaterialIssueById(e.params.id);t.sendResponse(a,"Material issue fetched successfully")},getAllMaterialIssues:async(e,t)=>{const a=e.user,n=await i.getAllMaterialIssues(a.siteId);t.sendResponse(n,"Material issues fetched successfully")},getMaterialIssuesBySite:async(e,t)=>{const a=await i.getMaterialIssuesBySite(e.params.siteId);t.sendResponse(a,"Material issues fetched successfully")},approveMaterialIssue:async(e,t)=>{const{issueId:a}=e.params,n=e.user.id,r=await i.approveMaterialIssue(a,n);t.sendResponse(r,"Material issue approved successfully")},dispatchMaterialIssue:async(e,t)=>{const{issueId:a}=e.params,n=e.user.id,r=await i.dispatchMaterialIssue(a,n);t.sendResponse(r,"Material issue dispatched and stock deducted")},receiveMaterialIssue:async(e,t)=>{const{issueId:a}=e.params,n=e.user.id,r=await i.receiveMaterialIssue(a,n);t.sendResponse(r,"Material issue received and stock updated")},issueForConsumption:async(e,t)=>{const{issueId:a}=e.params,n=e.user.id,r=await i.issueForConsumption(a,n);t.sendResponse(r,"Material issued and consumed successfully")},rejectMaterialIssue:async(e,t)=>{const{issueId:a}=e.params,{rejectionReason:n}=e.body,r=e.user.id,s=await i.rejectMaterialIssue(a,r,n);t.sendResponse(s,"Material issue rejected successfully")}}},9833:(e,t,a)=>{const i=a(7252).Router(),n=a(1651),r=a(4081),s=a(7434),{createMaterialIssueSchema:o}=a(7733);i.post("/",r(o),s(n.createMaterialIssue)),i.get("/:id",s(n.getMaterialIssueById)),i.get("/",s(n.getAllMaterialIssues)),i.post("/:issueId/approve",s(n.approveMaterialIssue)),i.post("/:issueId/dispatch",s(n.dispatchMaterialIssue)),i.post("/:issueId/receive",s(n.receiveMaterialIssue)),i.post("/:issueId/consume",s(n.issueForConsumption)),i.post("/:issueId/reject",s(n.rejectMaterialIssue)),e.exports=i},8756:(e,t,a)=>{const i=a(9239),n=a(5771),r=a(7715),{Op:s,col:o,fn:d}=a(9031);e.exports={createMaterialIssue:async(e,t)=>{const a=await i.sequelize.transaction((async a=>{const{items:n,...r}=e;for(const e of n){const{itemId:t,quantity:n}=e,s=r.siteId,o=await i.SiteInventory.findOne({where:{siteId:s,itemId:t},transaction:a});if(!o||o.quantity-o.lockedQuantity<n)throw new Error(`Insufficient available stock at site ${s} for item ${t}. Available: ${o?o.quantity-o.lockedQuantity:0}`);o.lockedQuantity+=n,await o.save({transaction:a})}const s=await i.MaterialIssue.create({...r,issuedById:t,issuedAt:new Date},{transaction:a}),o=n.map((e=>({...e,materialIssueId:s.id})));return await i.MaterialIssueItem.bulkCreate(o,{transaction:a}),await i.MaterialIssue.findByPk(s.id,{transaction:a})})),s=await(async e=>i.Site.findByPk(e))(a.siteId);return console.log(s),await r({eventType:"MaterialIssue",eventAction:"Requested",referenceId:a.id,siteId:a.siteId,createdBy:a.createdById,roles:[n.STORE_MANAGER,n.PROJECT_MANAGER],title:"Material Issue Requested",description:`A new material issue (#${a.issueNumber}) has been created from site ${s?.name}.`}),a},getMaterialIssueById:async e=>await i.MaterialIssue.findByPk(e,{include:[{model:i.Requisition,as:"requisition",attributes:["id","requisitionNo"]},{model:i.User,as:"issuedBy",attributes:["id","name","email"]},{model:i.User,as:"approvedBy",attributes:["id","name","email"]},{model:i.User,as:"dispatchedBy",attributes:["id","name","email"]},{model:i.User,as:"receivedBy",attributes:["id","name","email"]},{model:i.User,as:"rejectedBy",attributes:["id","name","email"]},{model:i.User,as:"consumedBy",attributes:["id","name","email"]},{model:i.Site,as:"fromSite",attributes:["id","name","code"]},{model:i.Site,as:"toSite",attributes:["id","name","code"]},{model:i.MaterialIssueItem,as:"items",include:[{model:i.Item,include:{model:i.Unit}},{model:i.Machinery,as:"machine",attributes:["id","machineName","registrationNumber","erpCode","machineNumber"]}]}]}),getAllMaterialIssues:async e=>e?await i.MaterialIssue.findAll({attributes:["id","issueNumber","issueDate","status","issueType",[d("COUNT",o("items.id")),"itemCount"],[o("fromSite.name"),"fromSiteName"],[o("fromSite.code"),"fromSiteCode"],[o("toSite.name"),"toSiteName"],[o("toSite.code"),"toSiteCode"]],include:[{model:i.MaterialIssueItem,attributes:[],as:"items"},{model:i.Site,as:"fromSite",attributes:[]},{model:i.Site,as:"toSite",attributes:[]}],group:["MaterialIssue.id","MaterialIssue.issueNumber","MaterialIssue.issueDate","MaterialIssue.status","MaterialIssue.issueType","fromSite.id","fromSite.name","fromSite.code","toSite.id","toSite.name","toSite.code"],order:[["issueDate","DESC"]],where:{[s.or]:[{otherSiteId:e},{siteId:e}]},subQuery:!1}):await i.MaterialIssue.findAll({attributes:["id","issueNumber","issueDate","status","issueType",[d("COUNT",o("items.id")),"itemCount"],[o("fromSite.name"),"fromSiteName"],[o("fromSite.code"),"fromSiteCode"],[o("toSite.name"),"toSiteName"],[o("toSite.code"),"toSiteCode"]],include:[{model:i.MaterialIssueItem,attributes:[],as:"items"},{model:i.Site,as:"fromSite",attributes:[]},{model:i.Site,as:"toSite",attributes:[]}],group:["MaterialIssue.id","MaterialIssue.issueNumber","MaterialIssue.issueDate","MaterialIssue.status","MaterialIssue.issueType","fromSite.id","fromSite.name","fromSite.code","toSite.id","toSite.name","toSite.code"],order:[["issueDate","DESC"]],subQuery:!1}),dispatchMaterialIssue:async(e,t)=>await i.sequelize.transaction((async a=>{const s=await i.MaterialIssue.findByPk(e,{include:[{model:i.MaterialIssueItem,as:"items"}],transaction:a});if(!s)throw new Error("Material Issue not found");if("Approved"!==s.status)throw new Error("Issue not approved");if("Site Transfer"!==s.issueType)throw new Error("Invalid issue type");for(const e of s.items){const{itemId:t,quantity:n,siteId:r}=e,o=await i.SiteInventory.findOne({where:{siteId:r,itemId:t},transaction:a});if(!o||o.quantity<n)throw new Error(`Insufficient stock at site ${r} for item ${t}`);o.quantity-=n,o.lockedQuantity-=n,o.lockedQuantity<0&&(o.lockedQuantity=0),await o.save({transaction:a}),await i.StockLog.create({siteId:r,itemId:t,change:-n,type:"OUT",sourceType:"Issue",sourceId:s.id},{transaction:a})}return s.status="Dispatched",s.dispatchedById=t,s.dispatchedAt=new Date,await s.save({transaction:a}),await r({eventType:"MaterialIssue",eventAction:"Dispatched",referenceId:s.id,siteId:s.siteId,createdBy:s.dispatchedById,roles:[n.STORE_MANAGER],title:"Material Issue Dispatched",description:`Material issue #${s.issueNumber} has been dispatched.`}),s})),receiveMaterialIssue:async(e,t)=>await i.sequelize.transaction((async a=>{const s=await i.MaterialIssue.findByPk(e,{include:[{model:i.MaterialIssueItem,as:"items"}],transaction:a});if(!s)throw new Error("Material Issue not found");if("Dispatched"!==s.status)throw new Error("Issue not dispatched yet");if("Site Transfer"!==s.issueType)throw new Error("Invalid issue type");for(const e of s.items){const{itemId:t,quantity:n,otherSiteId:r}=e,o=await i.SiteInventory.findOne({where:{siteId:r,itemId:t},transaction:a});o?(o.quantity+=n,await o.save({transaction:a})):await i.SiteInventory.create({siteId:r,itemId:t,quantity:n,minimumLevel:0,status:"In Stock"},{transaction:a}),await i.StockLog.create({siteId:r,itemId:t,change:n,type:"IN",sourceType:"Issue",sourceId:s.id},{transaction:a})}return s.status="Received",s.receivedById=t,s.receivedAt=new Date,await s.save({transaction:a}),await r({eventType:"MaterialIssue",eventAction:"Received",referenceId:s.id,siteId:s.siteId,createdBy:s.receivedById,roles:[n.STORE_MANAGER],title:"Material Issue Received",description:`Material issue #${s.issueNumber} has been received.`}),s})),getMaterialIssuesBySite:async e=>await i.MaterialIssue.findAll({include:[{model:i.MaterialIssueItem,as:"items",include:[{model:i.Item}]}],where:{fromSiteId:e}}),approveMaterialIssue:async(e,t)=>await i.sequelize.transaction((async a=>{const s=await i.MaterialIssue.findByPk(e,{transaction:a});if(!s)throw new Error("Material Issue not found");if("Pending"!==s.status)throw new Error("Issue already processed");return s.status="Approved",s.approvedById=t,s.approvedAt=new Date,await s.save({transaction:a}),await r({eventType:"MaterialIssue",eventAction:"Approved",referenceId:s.id,siteId:s.siteId,createdBy:s.approvedById,roles:[n.STORE_MANAGER],title:"Material Issue Approved",description:`Material issue #${s.issueNumber} has been approved.`}),s})),issueForConsumption:async(e,t)=>await i.sequelize.transaction((async a=>{const s=await i.MaterialIssue.findByPk(e,{include:[{model:i.MaterialIssueItem,as:"items"}],transaction:a});if(!s)throw new Error("Material Issue not found");if("Approved"!==s.status)throw new Error("Issue not approved");if("Consumption"!==s.issueType)throw new Error("Invalid issue type");for(const e of s.items){const{itemId:t,quantity:n,siteId:r}=e,o=await i.SiteInventory.findOne({where:{siteId:r,itemId:t},transaction:a});if(!o||o.quantity<n)throw new Error(`Insufficient stock at site ${r} for item ${t}`);o.quantity-=n,o.lockedQuantity-=n,o.lockedQuantity<0&&(o.lockedQuantity=0),await o.save({transaction:a}),await i.StockLog.create({siteId:r,itemId:t,change:-n,type:"OUT",sourceType:"Consumption",sourceId:s.id},{transaction:a})}return s.status="Consumed",s.consumedById=t,s.consumedAt=new Date,await s.save({transaction:a}),await r({eventType:"MaterialIssue",eventAction:"Consumed",referenceId:s.id,siteId:s.siteId,createdBy:s.consumedById,roles:[n.STORE_MANAGER],title:"Material Consumed",description:`Material issue #${s.issueNumber} has been consumed.`}),s})),rejectMaterialIssue:async(e,t,a)=>await i.sequelize.transaction((async s=>{const o=await i.MaterialIssue.findByPk(e,{transaction:s});if(!o)throw new Error("Material Issue not found");if(["Rejected","Approved","Dispatched","Received","Consumed"].includes(o.status))throw new Error(`Cannot reject. Issue already in '${o.status}' state`);o.status="Rejected",o.rejectedById=t,o.rejectedAt=new Date,o.rejectionReason=a,await o.save({transaction:s});const d=await i.MaterialIssueItem.findAll({where:{materialIssueId:e},transaction:s});for(const e of d){const{itemId:t,quantity:a,siteId:n}=e,r=await i.SiteInventory.findOne({where:{siteId:n,itemId:t},transaction:s});r&&(r.lockedQuantity-=a,r.lockedQuantity<0&&(r.lockedQuantity=0),await r.save({transaction:s}))}return await r({eventType:"MaterialIssue",eventAction:"Rejected",referenceId:o.id,siteId:o.siteId,createdBy:t,roles:[n.STORE_MANAGER],title:"Material Issue Rejected",description:`Material issue #${o.issueNumber} has been rejected. Reason: ${a||"Not specified"}.`}),o}))}},7733:(e,t,a)=>{const i=a(2446),n=i.object({itemId:i.number().integer().required(),quantity:i.number().positive().required(),issueTo:i.string().allow(null,""),machineId:i.number().allow(null),siteId:i.number().required(),otherSiteId:i.number().allow(null)}),r=i.object({issueDate:i.date().required(),issueType:i.string().valid("Consumption","Site Transfer").required(),status:i.string().optional(),siteId:i.number().required(),otherSiteId:i.number().allow(null),items:i.array().items(n).min(1).required(),requisitionId:i.number().allow(null)});e.exports={createMaterialIssueSchema:r}},8098:(e,t,a)=>{const i=a(5867);e.exports={getAllNotifications:async(e,t)=>{const a=e.user.id,n=e.user,r={};n.siteId&&(r.siteId=n.siteId);const s=await i.getNotificationsForUser(a,r);t.sendResponse(s,"Notifications fetched successfully")},markAsRead:async(e,t)=>{const a=e.user.id,n=e.params.id;await i.markNotificationAsRead(a,Number(n)),t.sendResponse({},"Notification marked as read")},markAllAsRead:async(e,t)=>{const a=e.user.id;await i.markAllNotificationsAsRead(a),t.sendResponse({},"All notifications marked as read")}}},9204:(e,t,a)=>{const i=a(7252).Router(),n=a(8098),r=a(7434);i.get("/notifications/",r(n.getAllNotifications)),i.post("/notifications/:id/read",r(n.markAsRead)),i.post("/notifications/read-all",r(n.markAllAsRead)),e.exports=i},5867:(e,t,a)=>{const i=a(9239);e.exports={getNotificationsForUser:async(e,t={})=>(await i.Notification.findAll({where:t,include:[{model:i.NotificationReadStatus,where:{userId:e},required:!1,as:"readStatuses"}],order:[["createdAt","DESC"]]})).map((e=>({id:e.id,title:e.title,description:e.description,eventType:e.eventType,eventAction:e.eventAction,createdAt:e.createdAt,referenceId:e.referenceId,read:e.readStatuses?.length>0}))),markNotificationAsRead:async(e,t)=>{const[a,n]=await i.NotificationReadStatus.findOrCreate({where:{userId:e,notificationId:t},defaults:{readAt:new Date}});return n||(a.readAt=new Date,await a.save()),!0},markAllNotificationsAsRead:async e=>{const t=(await i.Notification.findAll({attributes:["id"]})).map((t=>({userId:e,notificationId:t.id,readAt:new Date})));return await i.NotificationReadStatus.bulkCreate(t,{ignoreDuplicates:!0}),!0}}},7518:(e,t,a)=>{const i=a(335);e.exports={createProcurement:async(e,t)=>{const a=await i.createProcurement(e.body);t.sendResponse(a,"Procurement created successfully")},getProcurement:async(e,t)=>{const a=await i.getProcurementById(e.params.id);t.sendResponse(a)},updateStatus:async(e,t)=>{await i.updateProcurementStatus(e.params.id,e.body.status,e.user),t.sendResponse(null,"Procurement status updated")},listProcurements:async(e,t)=>{const a=await i.listProcurements(e.query);t.sendResponse(a)},updatePayment:async(e,t)=>{await i.updatePaymentStatus(e.params.id,e.body),t.sendResponse(null,"Payment status updated")},getSummary:async(e,t)=>{const a=await i.getProcurementSummary();t.sendResponse(a)},getInventoryMovement:async(e,t)=>{const a=await i.getInventoryMovement(e.params.id);t.sendResponse(a)},getRequisitionWithRemainingItems:async(e,t)=>{const a=await i.getRequisitionWithRemainingItems(e.params.id);t.sendResponse(a)},deleteProcurement:async(e,t)=>{const a=await i.deleteProcurement(e.params.id);t.sendResponse(a,"Procurement deleted successfully")},createFromComparison:async(e,t)=>{const{comparisonId:a,vendorId:n,selections:r}=e.body,s=e.user.id,o=await i.createProcurementsFromComparison(a,s,n,r);t.sendResponse(o,"Procurements created successfully from comparison")}}},1192:(e,t,a)=>{const i=a(7252).Router(),n=a(7434),r=a(7518),s=a(4081),{createProcurementSchema:o,updateStatusSchema:d,listProcurementsSchema:c,updatePaymentSchema:l}=a(5230);i.post("/procurements",s(o),n(r.createProcurement)),i.get("/procurements/:id",n(r.getProcurement)),i.put("/procurements/:id/status",s(d),n(r.updateStatus)),i.get("/procurements",s(c),n(r.listProcurements)),i.put("/procurements/:id/payment",s(l),n(r.updatePayment)),i.delete("/procurements/:id",n(r.deleteProcurement)),i.get("/procurements/summary",n(r.getSummary)),i.get("/procurements/:id/inventory-movement",n(r.getInventoryMovement)),i.get("/requisitions/:id/remaining-items",n(r.getRequisitionWithRemainingItems)),i.post("/procurements/create-from-comparison",n(r.createFromComparison)),e.exports=i},335:(e,t,a)=>{const{sequelize:i}=a(9239),{Op:n}=a(9031),r=a(9239),s=async()=>{const e=await r.Procurement.count();return`PRC-${(new Date).getTime()}-${(e+1).toString().padStart(4,"0")}`},o=async(e,t)=>{const[a]=await r.SiteInventory.findOrCreate({where:{siteId:e.siteId,itemId:e.itemId},defaults:{quantity:0},transaction:t}),i="IN"===e.type?a.quantity+e.change:a.quantity-e.change;await a.update({quantity:i,status:d(i,a.minimumLevel)},{transaction:t}),await r.StockLog.create(e,{transaction:t})},d=(e,t)=>e<=0?"Out of Stock":e<t?"Low Stock":"In Stock";e.exports={createProcurement:async e=>await i.transaction((async t=>{const a=await s(),i=await r.Procurement.create({...e,procurementNo:a,status:"ordered"},{transaction:t}),n=(await r.ProcurementItem.bulkCreate(e.items.map((e=>({...e,procurementId:i.id,amount:e.quantity*e.rate}))),{transaction:t})).reduce(((e,t)=>e+Number(t.amount)),0);return await i.update({totalAmount:n},{transaction:t}),i})),getProcurementById:async e=>await r.Procurement.findByPk(e,{include:[{model:r.Vendor},{model:r.Requisition},{model:r.ProcurementItem,include:{model:r.RequisitionItem,include:{model:r.Item,include:{model:r.Unit}}}},{model:r.Invoice,as:"invoices",include:[{model:r.Payment,as:"payments"},{model:r.InvoiceItem,as:"items",include:[{model:r.ProcurementItem,include:{model:r.RequisitionItem,include:{model:r.Item}}}]}]}]}),updateProcurementStatus:async(e,t,a)=>await i.transaction((async i=>{const n=await r.Procurement.findByPk(e,{include:[{model:r.ProcurementItem,include:[r.RequisitionItem]},{model:r.Requisition}],transaction:i});if("accepted_at_virtual_site"===t){let t=await r.Site.findOne({where:{type:"virtual"},attributes:["id"]});if(!t?.id){const e=await r.Department.findOne({where:{name:"Mechanical"}});t=await r.Site.create({name:"Virtual",type:"virtual",departmentId:e.id,address:"NA"})}for(const r of n.ProcurementItems)await o({siteId:t.id,itemId:r.RequisitionItem.itemId,change:r.quantity,type:"IN",sourceType:"Procurement",sourceId:e,userId:a.id},i)}else if("in_transit_to_requested_site"===t){let t=await r.Site.findOne({where:{type:"virtual"},attributes:["id"]});if(!t?.id){const e=await r.Department.findOne({where:{name:"Mechanical"}});t=await r.Site.create({name:"Virtual",type:"virtual",departmentId:e.id,address:"NA"})}for(const r of n.ProcurementItems)await o({siteId:t.id,itemId:r.RequisitionItem.itemId,change:r.quantity,type:"OUT",sourceType:"Procurement",sourceId:e,userId:a.id},i),await o({siteId:n.Requisition.requestingSiteId,itemId:r.RequisitionItem.itemId,change:r.quantity,type:"IN",sourceType:"Procurement",sourceId:e,userId:a.id},i)}else if("delivered"===t){let e=await r.Site.findOne({where:{type:"virtual"},attributes:["id"]});if(!e?.id){const t=await r.Department.findOne({where:{name:"Mechanical"}});e=await r.Site.create({name:"Virtual",type:"virtual",departmentId:t.id,address:"NA"})}for(const e of n.ProcurementItems)await o({siteId:n.Requisition.requestingSiteId,itemId:e.RequisitionItem.itemId,change:e.quantity,type:"IN",sourceType:"Requisition",sourceId:n.requisitionId,userId:a.id},i)}return await n.update({status:t},{transaction:i})})),listProcurements:async(e={})=>{const{status:t,startDate:a,endDate:i,vendorId:s,page:o,limit:d}=e,c={};return t&&(c.status=t),s&&(c.vendorId=s),a&&i&&(c.createdAt={[n.between]:[a,i]}),await r.Procurement.findAll({where:c,include:[{model:r.Vendor,attributes:["name"]},{model:r.Requisition,attributes:["requisitionNo"]}],order:[["createdAt","DESC"]]})},updatePaymentStatus:async(e,t)=>await r.Procurement.update({isPaid:t.paymentStatus,paymentDate:t.paymentStatus?t.paymentDate||new Date:null},{where:{id:e}}),getProcurementSummary:async()=>{const[e,t,a]=await Promise.all([r.Procurement.count({group:["status"],attributes:["status",[r.sequelize.fn("COUNT","id"),"count"]]}),r.Procurement.findAll({where:{createdAt:{[n.gte]:new Date(new Date-15552e6)}},attributes:[[r.sequelize.fn("DATE_TRUNC","month",r.sequelize.col("createdAt")),"month"],[r.sequelize.fn("SUM",r.sequelize.col("totalAmount")),"total"]],group:["month"],order:[["month","ASC"]]}),r.Procurement.findAll({attributes:[[r.sequelize.col("Vendor.name"),"vendorName"],[r.sequelize.fn("SUM",r.sequelize.col("totalAmount")),"totalSpent"]],include:[{model:r.Vendor,attributes:[]}],group:["Vendor.id"],order:[[r.sequelize.literal("totalSpent"),"DESC"]],limit:5})]);return{statusDistribution:e,monthlySpending:t,topVendors:a}},getInventoryMovement:async e=>await r.StockLog.findAll({where:{sourceId:e,sourceType:"Procurement"},include:[r.Item,r.Site]}),getRequisitionWithRemainingItems:async e=>{const t=await r.Requisition.findByPk(e,{include:[{model:r.RequisitionItem,as:"items",include:[{model:r.Item}]},{model:r.Procurement,as:"procurements",include:[{model:r.ProcurementItem,as:"items"}]},{model:r.MaterialIssue,as:"materialIssues",include:[{model:r.MaterialIssueItem,as:"items"}]},{model:r.User,as:"preparedBy",attributes:["id","name","email"]},{model:r.Site,as:"requestingSite",attributes:["id","name","code"]}]});if(!t)return null;const a=new Map,i=new Map;t.procurements.forEach((e=>{e.items&&e.items.forEach((e=>{const t=a.get(e.itemId)||0;a.set(e.itemId,t+e.quantity)}))})),t.materialIssues.forEach((e=>{e.items&&e.items.forEach((e=>{const t=i.get(e.itemId)||0;i.set(e.itemId,t+e.quantity)}))}));const n=[];return t.items.forEach((e=>{const t=e.itemId,r=e.quantity,s=a.get(t)||0,o=i.get(t)||0,d=r-s-o;d>0&&n.push({id:e.id,requisitionId:e.requisitionId,itemId:e.itemId,quantity:d,originalQuantity:r,procuredQuantity:s,issuedQuantity:o,Item:e.Item})})),{id:t.id,requisitionNo:t.requisitionNo,requestedAt:t.requestedAt,requestingSiteId:t.requestingSiteId,requestedFor:t.requestedFor,chargeType:t.chargeType,requestPriority:t.requestPriority,dueDate:t.dueDate,status:t.status,preparedBy:t.preparedBy,requestingSite:t.requestingSite,items:n,summary:{totalItems:t.items.length,remainingItems:n.length,fullyFulfilledItems:t.items.length-n.length}}},deleteProcurement:async e=>await i.transaction((async t=>{const a=await r.Procurement.findByPk(e,{include:[{model:r.ProcurementItem,include:[r.RequisitionItem]},{model:r.Requisition}],transaction:t});if(!a)throw new Error("Procurement not found");if("delivered"===a.status){let i=await r.Site.findOne({where:{type:"virtual"},attributes:["id"]});if(!i?.id){const e=await r.Department.findOne({where:{name:"Mechanical"}});i=await r.Site.create({name:"Virtual",type:"virtual",departmentId:e.id,address:"NA"})}for(const n of a.ProcurementItems)await o({siteId:a.Requisition.requestingSiteId,itemId:n.RequisitionItem.itemId,change:n.quantity,type:"OUT",sourceType:"Procurement",sourceId:e,userId:null},t),await o({siteId:i.id,itemId:n.RequisitionItem.itemId,change:n.quantity,type:"IN",sourceType:"Procurement",sourceId:e,userId:null},t),await o({siteId:i.id,itemId:n.RequisitionItem.itemId,change:n.quantity,type:"OUT",sourceType:"Procurement",sourceId:e,userId:null},t)}return await r.ProcurementItem.destroy({where:{procurementId:e},transaction:t}),await a.destroy({transaction:t}),a})),createProcurementsFromComparison:async(e,t,a=null,n=null)=>await i.transaction((async t=>{const i=await r.QuotationComparison.findByPk(e,{include:[{model:r.QuotationComparisonItem,as:"items",include:[{model:r.QuotationComparisonRate,as:"rates"}]}],transaction:t});if(!i)throw new Error("Comparison not found");if("approved"!==i.status&&"locked"!==i.status)throw new Error("Comparison must be approved or locked before creating procurement");const o={};for(const e of i.items){const t=n&&(n[e.id]||n[String(e.id)])||e.selectedVendorId;if(!t)continue;if(a&&parseInt(t)!==parseInt(a))continue;o[t]||(o[t]=[]);const i=e.rates.find((e=>e.vendorId===parseInt(t)));i&&o[t].push({requisitionItemId:e.requisitionItemId,itemId:e.itemId,quantity:e.quantity,rate:i.rate,amount:i.amount})}const d=[];for(const[e,a]of Object.entries(o)){const n=await s(),o=await r.Procurement.create({requisitionId:i.requisitionId,vendorId:parseInt(e),status:"ordered",procurementNo:n,quotationComparisonId:i.id},{transaction:t}),c=(await r.ProcurementItem.bulkCreate(a.map((e=>({...e,procurementId:o.id}))),{transaction:t})).reduce(((e,t)=>e+Number(t.amount)),0);await o.update({totalAmount:c},{transaction:t}),d.push(o)}return"locked"!==i.status&&await i.update({status:"locked"},{transaction:t}),d}))}},5230:(e,t,a)=>{const i=a(2446),n=i.object({requisitionId:i.number().integer().positive().required(),vendorId:i.number().integer().positive().required(),expectedDelivery:i.date().iso().required(),notes:i.string(),quotationComparisonId:i.number().integer().positive(),totalAmount:i.number().precision(2).positive().required(),items:i.array().items(i.object({requisitionItemId:i.number().integer().positive().required(),itemId:i.number().integer().positive().required(),quantity:i.number().integer().positive().required(),rate:i.number().precision(2).positive().required(),amount:i.number().precision(2).positive().required()})).min(1).required()}),r=i.object({status:i.string().valid("pending","ordered","delivered","paid","cancelled","accepted_at_virtual_site","in_transit_to_requested_site").required()}),s=i.object({status:i.string().valid("pending","ordered","delivered","paid","cancelled","accepted_at_virtual_site","in_transit_to_requested_site"),startDate:i.date().iso(),endDate:i.date().iso(),vendorId:i.number().integer().positive(),page:i.number().integer().positive().default(1),limit:i.number().integer().positive().default(10)}),o=i.object({paymentStatus:i.boolean().required(),paymentDate:i.date().iso()});e.exports={createProcurementSchema:n,updateStatusSchema:r,listProcurementsSchema:s,updatePaymentSchema:o}},725:(e,t,a)=>{const i=a(8203);e.exports={createComparison:async(e,t)=>{const{requisitionId:a}=e.body,n=e.user.id,r=await i.createComparison(a,n);t.sendResponse(r,"Quotation comparison created successfully")},getComparison:async(e,t)=>{const a=await i.getComparisonWithDetails(e.params.id);t.sendResponse(a)},addVendor:async(e,t)=>{const{id:a}=e.params,{vendorId:n}=e.body,r=await i.addVendorToComparison(a,n);t.sendResponse(r,"Vendor added to comparison")},updateRate:async(e,t)=>{const{id:a,itemId:n}=e.params,{vendorId:r,rate:s,remarks:o}=e.body,d=await i.updateRate(a,n,r,s,o);t.sendResponse(d,"Rate updated successfully")},selectVendorForItem:async(e,t)=>{const{id:a,itemId:n}=e.params,{vendorId:r}=e.body,s=await i.selectVendorForItem(a,n,r);t.sendResponse(s,"Vendor selected for item")},selectVendorForAllItems:async(e,t)=>{const{id:a}=e.params,{vendorId:n}=e.body,r=await i.selectVendorForAllItems(a,n);t.sendResponse(r,"Vendor selected for all items")},selectVendors:async(e,t)=>{const{id:a}=e.params,{selections:n}=e.body,r=await i.bulkSelectVendors(a,n);t.sendResponse(r,"Selections saved successfully")},submitComparison:async(e,t)=>{const{id:a}=e.params,n=e.user.id,{remarks:r}=e.body,s=await i.submitComparison(a,n,r);t.sendResponse(s,"Comparison submitted successfully")},approveComparison:async(e,t)=>{const{id:a}=e.params,n=e.user.id,{remarks:r}=e.body,s=await i.approveComparison(a,n,r);t.sendResponse(s,"Comparison approved successfully")},lockComparison:async(e,t)=>{const{id:a}=e.params,{remarks:n}=e.body,r=await i.lockComparison(a,n);t.sendResponse(r,"Comparison locked successfully")},getComparisonsForRequisition:async(e,t)=>{const a=await i.getComparisonsForRequisition(e.params.requisitionId);t.sendResponse(a)},getAllComparisons:async(e,t)=>{const a=await i.getAllComparisons();t.sendResponse(a)},removeVendor:async(e,t)=>{const{id:a,vendorId:n}=e.params,r=await i.removeVendorFromComparison(a,parseInt(n));t.sendResponse(r,"Vendor removed from comparison")},removeItem:async(e,t)=>{const{id:a,itemId:n}=e.params,r=await i.removeItem(parseInt(a),parseInt(n));t.sendResponse(r,"Item removed from comparison")},bulkUpdate:async(e,t)=>{const{id:a}=e.params,{rates:n,quantities:r}=e.body,s=await i.bulkUpdate(parseInt(a),{rates:n,quantities:r});t.sendResponse(s,"Bulk update completed successfully")},deleteComparison:async(e,t)=>{const a=await i.deleteComparison(parseInt(e.params.id));t.sendResponse(a,"Quotation comparison deleted successfully")},uploadVendorAttachment:async(e,t)=>{const{comparisonId:a,vendorId:n}=e.params,r=e.user.id;if(!e.fileData||!e.fileData.files)return t.status(400).json({success:!1,message:"No file uploaded"});const s=Array.isArray(e.fileData.files)?e.fileData.files[0]:e.fileData.files,o={comparisonId:parseInt(a),vendorId:parseInt(n),file:s,uploadedById:r},d=await i.uploadVendorAttachment(o);t.sendResponse(d,"Attachment uploaded successfully")},getVendorAttachments:async(e,t)=>{const{comparisonId:a,vendorId:n}=e.params,r=await i.getVendorAttachments(parseInt(a),parseInt(n));t.sendResponse(r)},deleteAttachment:async(e,t)=>{const{comparisonId:a,vendorId:n}=e.params,r=await i.deleteAttachment(parseInt(a),parseInt(n));t.sendResponse(r,"Attachment deleted successfully")},downloadAttachment:async(e,t)=>{const{comparisonId:a,vendorId:n}=e.params,r=await i.getAttachmentById(parseInt(a),parseInt(n));if(!r||!r.attachmentFilePath)return t.status(404).json({success:!1,message:"Attachment not found"});t.redirect(r.attachmentFilePath)}}},1764:(e,t,a)=>{const i=a(7252).Router(),n=a(7434),r=a(725),s=a(4081),o=a(9117),d=a(7242),{fileUploadMiddleware:c,upload:l}=a(7799),{createQuotationComparisonSchema:u,addVendorSchema:m,updateRateSchema:p,selectVendorForItemSchema:y,selectVendorForAllItemsSchema:I,selectVendorsSchema:h,submitComparisonSchema:g,approveComparisonSchema:w,lockComparisonSchema:f,bulkUpdateSchema:S,removeVendorSchema:v,getRequisitionComparisonsSchema:R,deleteComparisonSchema:b,getVendorAttachmentsSchema:E,deleteAttachmentSchema:M,downloadAttachmentSchema:N}=a(9994);i.post("/",o,d([2,3]),s(u),n(r.createComparison)),i.get("/:id",o,n(r.getComparison)),i.post("/:id/vendors",o,s(m),n(r.addVendor)),i.delete("/:id/vendors/:vendorId",o,n(r.removeVendor)),i.put("/:id/items/:itemId/rates",o,s(p),n(r.updateRate)),i.put("/:id/items/:itemId/vendor",o,s(y),n(r.selectVendorForItem)),i.post("/:id/select-vendor-for-all",o,s(I),n(r.selectVendorForAllItems)),i.put("/:id/bulk-select",o,s(h),n(r.selectVendors)),i.put("/:id/submit",o,d([2,3]),s(g),n(r.submitComparison)),i.put("/:id/approve",o,d([1]),s(w),n(r.approveComparison)),i.put("/:id/lock",o,d([1]),s(f),n(r.lockComparison)),i.get("/requisition/:requisitionId",o,n(r.getComparisonsForRequisition)),i.get("/",o,n(r.getAllComparisons)),i.delete("/:id/items/:itemId",o,n(r.removeItem)),i.put("/:id/bulk-update",o,s(S),n(r.bulkUpdate)),i.delete("/:id",o,n(r.deleteComparison)),i.post("/:comparisonId/vendors/:vendorId/attachments",o,l.fields([{name:"files",maxCount:5}]),c(["files"],"quotationComparison","vendor-attachments"),n(r.uploadVendorAttachment)),i.get("/:comparisonId/vendors/:vendorId/attachments",o,n(r.getVendorAttachments)),i.delete("/:comparisonId/vendors/:vendorId/attachments",o,n(r.deleteAttachment)),i.get("/:comparisonId/vendors/:vendorId/attachments/download",o,n(r.downloadAttachment)),e.exports=i},8203:(e,t,a)=>{const i=a(9239),{Op:n}=a(9031),r=a(5056);a(9896),e.exports=new class{async createComparison(e,t){try{const a=await i.Requisition.findByPk(e,{include:[{model:i.RequisitionItem,as:"items",include:[{model:i.Item,include:{model:i.Unit}}]}]});if(!a)throw new Error("Requisition not found");const n=await i.QuotationComparison.create({requisitionId:e,submittedById:t,status:"draft"});for(const e of a.items)await i.QuotationComparisonItem.create({comparisonId:n.id,requisitionItemId:e.id,itemId:e.itemId,description:e.Item.name||e.Item.description||`Item ${e.itemId}`,unit:e.Item.Unit.name||"NOS",quantity:e.quantity});return await this.getComparisonWithDetails(n.id)}catch(e){throw e}}async getComparisonWithDetails(e){try{const t=await i.QuotationComparison.findByPk(e,{include:[{model:i.Requisition,as:"requisition",include:[{model:i.Site,as:"requestingSite"}]},{model:i.User,as:"submittedBy",attributes:["id","name","email"]},{model:i.User,as:"approvedBy",attributes:["id","name","email"]},{model:i.QuotationComparisonItem,as:"items",include:[{model:i.Item,as:"item",attributes:["id","name"],include:{model:i.Unit}},{model:i.QuotationComparisonRate,as:"rates",include:[{model:i.Vendor,as:"vendor",attributes:["id","name","email","contactPerson","phone"]}]}],order:[[i.QuotationComparisonRate,"id","ASC"]]},{model:i.QuotationComparisonVendor,as:"vendors",include:[{model:i.Vendor,as:"vendor"}]}]});if(!t)throw new Error("Quotation comparison not found");return await this.calculateTotalsAndLowestRates(t.id),await i.QuotationComparison.findByPk(e,{include:[{model:i.Requisition,as:"requisition",include:[{model:i.Site,as:"requestingSite"}]},{model:i.User,as:"submittedBy",attributes:["id","name","email"]},{model:i.User,as:"approvedBy",attributes:["id","name","email"]},{model:i.QuotationComparisonItem,as:"items",include:[{model:i.Item,as:"item",attributes:["id","name"],include:{model:i.Unit}},{model:i.QuotationComparisonRate,as:"rates",include:[{model:i.Vendor,as:"vendor",attributes:["id","name","email","contactPerson","phone"]}]}],order:[[i.QuotationComparisonRate,"id","ASC"]]},{model:i.QuotationComparisonVendor,as:"vendors",include:[{model:i.Vendor,as:"vendor"}]}]})}catch(e){throw e}}async addVendorToComparison(e,t){try{const a=await i.Vendor.findByPk(t);if(!a)throw new Error("Vendor not found");if(await i.QuotationComparisonVendor.findOne({where:{comparisonId:e,vendorId:t}}))throw new Error("Vendor already added to this comparison");return await i.QuotationComparisonVendor.create({comparisonId:e,vendorId:t,vendorName:a.name})}catch(e){throw e}}async updateRate(e,t,a,n,r=null){try{const s=await i.QuotationComparisonItem.findByPk(t);if(!s||s.comparisonId!=e)throw new Error("Invalid comparison item");if(!await i.QuotationComparisonVendor.findOne({where:{comparisonId:e,vendorId:a}}))throw new Error("Vendor not associated with this comparison");const o=parseFloat(n)*s.quantity;let d=await i.QuotationComparisonRate.findOne({where:{comparisonItemId:t,vendorId:a}});return d?await d.update({rate:parseFloat(n),amount:parseFloat(o),remarks:r}):d=await i.QuotationComparisonRate.create({comparisonItemId:t,vendorId:a,rate:parseFloat(n),amount:parseFloat(o),remarks:r}),await this.calculateTotalsAndLowestRates(e),d}catch(e){throw e}}async calculateTotalsAndLowestRates(e){try{const t=await i.QuotationComparisonItem.findAll({where:{comparisonId:e},include:[{model:i.QuotationComparisonRate,as:"rates",include:[{model:i.Vendor,as:"vendor"}]}]});await i.QuotationComparisonRate.update({isLowest:!1},{where:{comparisonItemId:{[n.in]:t.map((e=>e.id))}}});const a={};for(const e of t)if(e.rates&&e.rates.length>0){const t=[...e.rates].sort(((e,t)=>e.amount-t.amount))[0];await i.QuotationComparisonRate.update({isLowest:!0},{where:{id:t.id}});for(const t of e.rates)a[t.vendorId]||(a[t.vendorId]=0),a[t.vendorId]+=parseFloat(t.amount)}for(const[t,n]of Object.entries(a))await i.QuotationComparisonVendor.update({totalAmount:n},{where:{comparisonId:e,vendorId:t}});let r=0;for(const e of t)if(e.rates&&e.rates.length>0){const t=e.rates.reduce(((e,t)=>t.amount<e.amount?t:e),e.rates[0]);r+=parseFloat(t.amount)}await i.QuotationComparison.update({totalAmount:r},{where:{id:e}})}catch(e){throw e}}async selectVendorForItem(e,t,a){try{const n=await i.QuotationComparisonItem.findByPk(t);if(!n||n.comparisonId!=e)throw new Error("Invalid comparison item");if(!await i.QuotationComparisonVendor.findOne({where:{comparisonId:e,vendorId:a}}))throw new Error("Vendor not associated with this comparison");return await n.update({selectedVendorId:a,selected:!0}),n}catch(e){throw e}}async bulkSelectVendors(e,t){try{const a=[],i=Object.keys(t);for(const n of i){const i=t[n],r=await this.selectVendorForItem(parseInt(e),parseInt(n),parseInt(i));a.push(r)}return a}catch(e){throw e}}async selectVendorForAllItems(e,t){try{if(!await i.QuotationComparisonVendor.findOne({where:{comparisonId:e,vendorId:t}}))throw new Error("Vendor not associated with this comparison");const a=await i.QuotationComparisonItem.findAll({where:{comparisonId:e}});if(0===a.length)throw new Error("No items found in this comparison");for(const e of a)await e.update({selectedVendorId:t,selected:!0});return a}catch(e){throw e}}async submitComparison(e,t,a=null){try{const n=await i.QuotationComparison.findByPk(e);if(!n)throw new Error("Comparison not found");if("draft"!==n.status)throw new Error("Comparison can only be submitted from draft status");return await n.update({status:"submitted",submittedById:t,submittedAt:new Date,submissionRemarks:a||n.submissionRemarks,remarks:a||n.remarks}),n}catch(e){throw e}}async approveComparison(e,t,a=null){try{const n=await i.QuotationComparison.findByPk(e);if(!n)throw new Error("Comparison not found");if("submitted"!==n.status)throw new Error("Comparison must be submitted before approval");return await n.update({status:"approved",approvedById:t,approvedAt:new Date,approvalRemarks:a||n.approvalRemarks,remarks:a||n.remarks}),n}catch(e){throw e}}async lockComparison(e,t=null){try{const a=await i.QuotationComparison.findByPk(e);if(!a)throw new Error("Comparison not found");if("approved"!==a.status)throw new Error("Comparison must be approved before locking");return await a.update({status:"locked",lockRemarks:t||a.lockRemarks,remarks:t||a.remarks}),a}catch(e){throw e}}async getComparisonsForRequisition(e){try{return await i.QuotationComparison.findAll({where:{requisitionId:e},include:[{model:i.User,as:"submittedBy",attributes:["id","name","email"]},{model:i.User,as:"approvedBy",attributes:["id","name","email"]},{model:i.QuotationComparisonVendor,as:"vendors",include:[{model:i.Vendor,as:"vendor"}]}],order:[["createdAt","DESC"]]})}catch(e){throw e}}async getAllComparisons(){try{return await i.QuotationComparison.findAll({attributes:["id","requisitionId","status","createdAt","comparisonNo","totalAmount"],include:[{model:i.Requisition,as:"requisition",attributes:["requisitionNo"]},{model:i.QuotationComparisonVendor,as:"vendors",attributes:["vendorName","totalAmount"]}],order:[["createdAt","DESC"]]})}catch(e){throw e}}async removeVendorFromComparison(e,t){try{if(!await i.QuotationComparisonVendor.findOne({where:{comparisonId:e,vendorId:t}}))throw new Error("Vendor not associated with this comparison");const a=await i.QuotationComparisonItem.findAll({where:{comparisonId:e}});for(const e of a)await i.QuotationComparisonRate.destroy({where:{comparisonItemId:e.id,vendorId:t}});return await i.QuotationComparisonVendor.destroy({where:{comparisonId:e,vendorId:t}}),await this.calculateTotalsAndLowestRates(e),{message:"Vendor removed successfully"}}catch(e){throw e}}async removeItem(e,t){try{const a=await i.QuotationComparisonItem.findByPk(t);if(!a||a.comparisonId!==e)throw new Error("Item not found in this comparison");return await i.QuotationComparisonRate.destroy({where:{comparisonItemId:t}}),await i.QuotationComparisonItem.destroy({where:{id:t,comparisonId:e}}),await this.calculateTotalsAndLowestRates(e),{message:"Item removed successfully"}}catch(e){throw e}}async bulkUpdate(e,t){try{const{rates:a=[],quantities:n=[]}=t;for(const t of a){const{itemId:a,vendorId:n,rate:r,remarks:s=null}=t,o=await i.QuotationComparisonItem.findByPk(a);if(!o||o.comparisonId!==e)throw new Error(`Item ${a} not found in this comparison`);if(!await i.QuotationComparisonVendor.findOne({where:{comparisonId:e,vendorId:n}}))throw new Error(`Vendor ${n} not associated with this comparison`);const d=parseFloat(r)*o.quantity;let c=await i.QuotationComparisonRate.findOne({where:{comparisonItemId:a,vendorId:n}});c?await c.update({rate:parseFloat(r),amount:parseFloat(d),remarks:s}):await i.QuotationComparisonRate.create({comparisonItemId:a,vendorId:n,rate:parseFloat(r),amount:parseFloat(d),remarks:s})}for(const t of n){const{itemId:a,quantity:n}=t,r=await i.QuotationComparisonItem.findByPk(a);if(!r||r.comparisonId!==e)throw new Error(`Item ${a} not found in this comparison`);await r.update({quantity:parseFloat(n)});const s=await i.QuotationComparisonRate.findAll({where:{comparisonItemId:a}});for(const e of s){const t=e.rate*parseFloat(n);await e.update({amount:parseFloat(t)})}}return await this.calculateTotalsAndLowestRates(e),{message:"Bulk update completed successfully"}}catch(e){throw e}}async deleteComparison(e){try{if(!await i.QuotationComparison.findByPk(e))throw new Error("Quotation comparison not found");return await i.QuotationComparisonRate.destroy({where:{comparisonItemId:{[n.in]:i.sequelize.literal(`(SELECT id FROM quotation_comparison_items WHERE "comparisonId" = ${e})`)}}}),await i.QuotationComparisonItem.destroy({where:{comparisonId:e}}),await i.QuotationComparisonVendor.destroy({where:{comparisonId:e}}),await i.QuotationComparison.destroy({where:{id:e}}),{message:"Quotation comparison deleted successfully"}}catch(e){throw e}}async uploadVendorAttachment(e){try{const{comparisonId:t,vendorId:a,file:n,uploadedById:r}=e,s=await i.QuotationComparisonVendor.findOne({where:{comparisonId:t,vendorId:a}});if(!s)throw new Error("Vendor not associated with this comparison");return await s.update({attachmentFilePath:n,attachmentUploadedAt:new Date,attachmentUploadedById:r}),await i.QuotationComparisonVendor.findByPk(s.id,{include:[{model:i.Vendor,as:"vendor"},{model:i.User,as:"attachmentUploadedBy",attributes:["id","name","email"]}]})}catch(e){throw e}}async getVendorAttachments(e,t){try{const a=await i.QuotationComparisonVendor.findOne({where:{comparisonId:e,vendorId:t},include:[{model:i.Vendor,as:"vendor"},{model:i.User,as:"attachmentUploadedBy",attributes:["id","name","email"]}]});if(!a)throw new Error("Vendor not associated with this comparison");return a.attachmentFilePath?[a]:[]}catch(e){throw e}}async deleteAttachment(e,t){try{const a=await i.QuotationComparisonVendor.findOne({where:{comparisonId:e,vendorId:t}});if(!a)throw new Error("Vendor not associated with this comparison");if(a.attachmentFilePath){const e=a.attachmentFilePath.split("/").pop().split(".")[0];await r.uploader.destroy(e)}return await a.update({attachmentFileName:null,attachmentFilePath:null,attachmentFileSize:null,attachmentMimeType:null,attachmentUploadedAt:null,attachmentUploadedById:null}),{message:"Attachment deleted successfully"}}catch(e){throw e}}async getAttachmentByVendorId(e,t){try{return await i.QuotationComparisonVendor.findOne({where:{comparisonId:e,vendorId:t},include:[{model:i.Vendor,as:"vendor"},{model:i.User,as:"attachmentUploadedBy",attributes:["id","name","email"]}]})}catch(e){throw e}}async getAttachmentById(e,t){try{return await i.QuotationComparisonVendor.findOne({where:{comparisonId:e,vendorId:t},include:[{model:i.Vendor,as:"vendor"},{model:i.User,as:"attachmentUploadedBy",attributes:["id","name","email"]}]})}catch(e){throw e}}}},9994:(e,t,a)=>{const i=a(2446),n=i.object({requisitionId:i.number().integer().positive().required()}),r=i.object({vendorId:i.number().integer().positive().required()}),s=i.object({vendorId:i.number().integer().positive().required(),rate:i.number().precision(2).positive().required(),remarks:i.string().allow("").optional()}),o=i.object({vendorId:i.number().integer().positive().required()}),d=i.object({vendorId:i.number().integer().positive().required()}),c=i.object({selections:i.object().pattern(i.string().regex(/^\d+$/),i.number().integer().positive()).required()}),l=i.object({remarks:i.string().allow("").optional()}),u=i.object({remarks:i.string().allow("").optional()}),m=i.object({remarks:i.string().allow("").optional()}),p=i.object({status:i.string().valid("draft","submitted","approved","locked").required()}),y=i.object({status:i.string().valid("draft","submitted","approved","locked"),requisitionId:i.number().integer().positive(),page:i.number().integer().positive().default(1),limit:i.number().integer().positive().default(10)}),I=i.object({vendorId:i.number().integer().positive().required()}),h=i.object({quantity:i.number().integer().positive().required()}),g=i.object({rates:i.array().items(i.object({itemId:i.number().integer().positive().required(),vendorId:i.number().integer().positive().required(),rate:i.number().precision(2).positive().required(),remarks:i.string().allow("").optional()})),quantities:i.array().items(i.object({itemId:i.number().integer().positive().required(),quantity:i.number().integer().positive().required()}))}),w=i.object({requisitionId:i.number().integer().positive().required()}),f=i.object(),S=i.object(),v=i.object(),R=i.object(),b=i.object(),E=i.object();e.exports={createQuotationComparisonSchema:n,addVendorSchema:r,updateRateSchema:s,selectVendorForItemSchema:o,selectVendorForAllItemsSchema:d,selectVendorsSchema:c,submitComparisonSchema:l,approveComparisonSchema:u,lockComparisonSchema:m,updateComparisonStatusSchema:p,listComparisonsSchema:y,removeVendorSchema:I,updateItemQuantitySchema:h,bulkUpdateSchema:g,getRequisitionComparisonsSchema:w,deleteComparisonSchema:f,removeItemSchema:S,getVendorAttachmentsSchema:v,deleteAttachmentSchema:R,downloadAttachmentSchema:E,uploadVendorAttachmentSchema:b}},8178:(e,t,a)=>{const i=a(3803);e.exports={getMachineUtilization:async(e,t)=>{const a=await i.getMachineUtilization(e.query);t.sendResponse(a,"Machine utilization report retrieved successfully")},getMachineMaintenanceReport:async(e,t)=>{const a=await i.getMachineMaintenanceReport(e.query);t.sendResponse(a,"Machine maintenance report retrieved successfully")},getMachineTransferReport:async(e,t)=>{const a=await i.getMachineTransferReport(e.query);t.sendResponse(a,"Machine transfer report retrieved successfully")},getMachineComplianceReport:async(e,t)=>{const a=await i.getMachineComplianceReport(e.query);t.sendResponse(a,"Machine compliance report retrieved successfully")},getLogbookReport:async(e,t)=>{const a=await i.getLogbookReport(e.query);t.sendResponse(a,"Logbook report retrieved successfully")},getInventoryStockReport:async(e,t)=>{const a=await i.getInventoryStockReport(e.query);t.sendResponse(a,"Inventory stock report retrieved successfully")},getInventoryConsumptionReport:async(e,t)=>{const a=await i.getInventoryConsumptionReport(e.query);t.sendResponse(a,"Inventory consumption report retrieved successfully")},getInventoryTransferReport:async(e,t)=>{const a=await i.getInventoryTransferReport(e.query);t.sendResponse(a,"Inventory transfer report retrieved successfully")},getInventoryValuationReport:async(e,t)=>{const a=await i.getInventoryValuationReport(e.query);t.sendResponse(a,"Inventory valuation report retrieved successfully")},getProcurementSummaryReport:async(e,t)=>{const a=await i.getProcurementSummaryReport(e.query);t.sendResponse(a,"Procurement summary report retrieved successfully")},getProcurementVendorReport:async(e,t)=>{const a=await i.getProcurementVendorReport(e.query);t.sendResponse(a,"Procurement vendor report retrieved successfully")},getPaymentStatusReport:async(e,t)=>{const a=await i.getPaymentStatusReport(e.query);t.sendResponse(a,"Payment status report retrieved successfully")},getInvoiceAgingReport:async(e,t)=>{const a=await i.getInvoiceAgingReport(e.query);t.sendResponse(a,"Invoice aging report retrieved successfully")},getSitePerformanceReport:async(e,t)=>{const a=await i.getSitePerformanceReport(e.query);t.sendResponse(a,"Site performance report retrieved successfully")},getRequisitionAnalysisReport:async(e,t)=>{const a=await i.getRequisitionAnalysisReport(e.query);t.sendResponse(a,"Requisition analysis report retrieved successfully")},getUserActivityReport:async(e,t)=>{const a=await i.getUserActivityReport(e.query);t.sendResponse(a,"User activity report retrieved successfully")},getAssetDepreciationReport:async(e,t)=>{const a=await i.getAssetDepreciationReport(e.query);t.sendResponse(a,"Asset depreciation report retrieved successfully")},getMaintenanceCostAnalysis:async(e,t)=>{const a=await i.getMaintenanceCostAnalysis(e.query);t.sendResponse(a,"Maintenance cost analysis retrieved successfully")},getFuelConsumptionReport:async(e,t)=>{const a=await i.getFuelConsumptionReport(e.query);t.sendResponse(a,"Fuel consumption report retrieved successfully")},getVendorPerformanceReport:async(e,t)=>{const a=await i.getVendorPerformanceReport(e.query);t.sendResponse(a,"Vendor performance report retrieved successfully")}}},2420:(e,t,a)=>{const i=a(7252).Router(),n=a(7434),r=a(8178),s=a(4081),{reportsFiltersSchema:o}=a(394);i.get("/reports/machine-utilization",s(o,"query"),n(r.getMachineUtilization)),i.get("/reports/machine-maintenance",s(o,"query"),n(r.getMachineMaintenanceReport)),i.get("/reports/machine-transfer",s(o,"query"),n(r.getMachineTransferReport)),i.get("/reports/machine-compliance",s(o,"query"),n(r.getMachineComplianceReport)),i.get("/reports/logbook",s(o,"query"),n(r.getLogbookReport)),i.get("/reports/inventory-stock",s(o,"query"),n(r.getInventoryStockReport)),i.get("/reports/inventory-consumption",s(o,"query"),n(r.getInventoryConsumptionReport)),i.get("/reports/inventory-transfer",s(o,"query"),n(r.getInventoryTransferReport)),i.get("/reports/inventory-valuation",s(o,"query"),n(r.getInventoryValuationReport)),i.get("/reports/procurement-summary",s(o,"query"),n(r.getProcurementSummaryReport)),i.get("/reports/procurement-vendor",s(o,"query"),n(r.getProcurementVendorReport)),i.get("/reports/payment-status",s(o,"query"),n(r.getPaymentStatusReport)),i.get("/reports/invoice-aging",s(o,"query"),n(r.getInvoiceAgingReport)),i.get("/reports/site-performance",s(o,"query"),n(r.getSitePerformanceReport)),i.get("/reports/requisition-analysis",s(o,"query"),n(r.getRequisitionAnalysisReport)),i.get("/reports/user-activity",s(o,"query"),n(r.getUserActivityReport)),i.get("/reports/asset-depreciation",s(o,"query"),n(r.getAssetDepreciationReport)),i.get("/reports/maintenance-cost-analysis",s(o,"query"),n(r.getMaintenanceCostAnalysis)),i.get("/reports/fuel-consumption",s(o,"query"),n(r.getFuelConsumptionReport)),i.get("/reports/vendor-performance",s(o,"query"),n(r.getVendorPerformanceReport)),e.exports=i},3803:(e,t,a)=>{const{Op:i}=a(9031),n=a(9239),{sequelize:r}=a(9239);e.exports={getMachineUtilization:async(e={})=>{const{startDate:t,endDate:a,siteId:r,machineId:s,status:o}=e,d={};r&&(d.siteId=r),s&&(d.machineId=s),t&&a&&(d.date={[i.between]:[t,a]});const c=await n.LogbookEntry.findAll({where:d,include:[{model:n.Machinery,as:"machine",include:[{model:n.Site,as:"site"}]}],order:[["date","DESC"]]}),l=c.map((e=>{const t=e.totalRunHrsMeter||0,a=e.totalRunKM||0,i=e.dieselIssue||0,n=t>0?a/t:0;return{date:e.date,machine:e.machine,runningHours:t,runningKM:a,dieselConsumption:i,efficiency:n,dieselAvgKM:e.dieselAvgKM||0,dieselAvgHrsMeter:e.dieselAvgHrsMeter||0}}));return{data:l,summary:{totalEntries:c.length,totalRunningHours:l.reduce(((e,t)=>e+t.runningHours),0),totalRunningKM:l.reduce(((e,t)=>e+t.runningKM),0),totalDieselConsumption:l.reduce(((e,t)=>e+t.dieselConsumption),0),averageEfficiency:l.length>0?l.reduce(((e,t)=>e+t.efficiency),0)/l.length:0}}},getMachineMaintenanceReport:async(e={})=>{const{startDate:t,endDate:a,siteId:r,machineId:s,status:o,type:d}=e,c={};s&&(c.machineId=s),o&&(c.status=o),d&&(c.type=d),t&&a&&(c.date={[i.between]:[t,a]});const l=await n.MaintenanceLog.findAll({where:c,include:[{model:n.Machinery,as:"machine",include:[{model:n.Site,as:"site"}],where:r?{siteId:r}:{}}],order:[["date","DESC"]]}),u={totalMaintenance:l.length,totalCost:l.reduce(((e,t)=>e+(parseFloat(t.cost)||0)),0),completedMaintenance:l.filter((e=>"completed"===e.status)).length,pendingMaintenance:l.filter((e=>"in_progress"===e.status)).length,scheduledMaintenance:l.filter((e=>"scheduled"===e.status)).length,byType:{}};return l.forEach((e=>{const t=e.type||"Unknown";u.byType[t]||(u.byType[t]={count:0,cost:0}),u.byType[t].count++,u.byType[t].cost+=parseFloat(e.cost)||0})),{data:l,summary:u}},getMachineTransferReport:async(e={})=>{const{startDate:t,endDate:a,machineId:r,currentSiteId:s,destinationSiteId:o,status:d,requestType:c}=e,l={};r&&(l.machineId=r),s&&(l.currentSiteId=s),o&&(l.destinationSiteId=o),d&&(l.status=d),c&&(l.requestType=c),t&&a&&(l.createdAt={[i.between]:[t,a]});const u=await n.MachineTransfer.findAll({where:l,include:[{model:n.Machinery,as:"machine"},{model:n.Site,as:"currentSite"},{model:n.Site,as:"destinationSite"},{model:n.User,as:"requester"},{model:n.User,as:"approver"}],order:[["createdAt","DESC"]]}),m={totalTransfers:u.length,byStatus:{},byType:{},averageProcessingTime:0};return u.forEach((e=>{const t=e.status;m.byStatus[t]||(m.byStatus[t]=0),m.byStatus[t]++;const a=e.requestType;m.byType[a]||(m.byType[a]=0),m.byType[a]++})),{data:u,summary:m}},getMachineComplianceReport:async(e={})=>{const{siteId:t,expiring_within_days:a=30}=e,i={};t&&(i.siteId=t);const r=new Date,s=new Date;s.setDate(r.getDate()+parseInt(a));const o=await n.Machinery.findAll({where:i,include:[{model:n.Site,as:"site"}]}),d=o.map((e=>{const t={machine:e,expiring:[],expired:[]};return["fitnessCertificateExpiry","motorVehicleTaxDue","permitExpiryDate","nationalPermitExpiry","insuranceExpiry","pollutionCertificateExpiry"].forEach((a=>{const i=e[a];if(i){const e=new Date(i);e<r?t.expired.push({type:a,date:i,daysOverdue:Math.floor((r-e)/864e5)}):e<=s&&t.expiring.push({type:a,date:i,daysUntilExpiry:Math.floor((e-r)/864e5)})}})),t})),c={totalMachines:o.length,machinesWithExpiredDocs:d.filter((e=>e.expired.length>0)).length,machinesWithExpiringDocs:d.filter((e=>e.expiring.length>0)).length,totalExpiredDocs:d.reduce(((e,t)=>e+t.expired.length),0),totalExpiringDocs:d.reduce(((e,t)=>e+t.expiring.length),0)};return{data:d,summary:c}},getLogbookReport:async(e={})=>{const{startDate:t,endDate:a,siteId:r,machineId:s}=e,o={};r&&(o.siteId=r),s&&(o.machineId=s),t&&a&&(o.date={[i.between]:[t,a]});const d=await n.LogbookEntry.findAll({where:o,include:[{model:n.Machinery,as:"machine"},{model:n.Site,as:"site"},{model:n.User,as:"creater"}],order:[["date","DESC"]]}),c={totalEntries:d.length,totalDieselConsumed:d.reduce(((e,t)=>e+(t.dieselIssue||0)),0),totalKMRun:d.reduce(((e,t)=>e+(t.totalRunKM||0)),0),totalHoursRun:d.reduce(((e,t)=>e+(t.totalRunHrsMeter||0)),0),averageDieselEfficiency:0},l=d.filter((e=>e.totalRunKM>0&&e.dieselIssue>0));return l.length>0&&(c.averageDieselEfficiency=l.reduce(((e,t)=>e+t.totalRunKM/t.dieselIssue),0)/l.length),{data:d,summary:c}},getInventoryStockReport:async(e={})=>{const{siteId:t,itemId:a,status:s,lowStock:o=!1}=e,d={};t&&(d.siteId=t),a&&(d.itemId=a),s&&(d.status=s),o&&(d[i.and]=[r.where(r.col("quantity"),i.lte,r.col("minimumLevel"))]);const c=await n.SiteInventory.findAll({where:d,include:[{model:n.Site},{model:n.Item,include:[{model:n.ItemGroup},{model:n.Unit}]}]}),l={totalItems:c.length,lowStockItems:c.filter((e=>e.quantity<=e.minimumLevel)).length,outOfStockItems:c.filter((e=>0===e.quantity)).length,totalValue:0,byStatus:{}};return c.forEach((e=>{const t=e.status;l.byStatus[t]||(l.byStatus[t]=0),l.byStatus[t]++})),{data:c,summary:l}},getInventoryConsumptionReport:async(e={})=>{const{startDate:t,endDate:a,siteId:r,itemId:s}=e,o={type:"OUT"};r&&(o.siteId=r),s&&(o.itemId=s),t&&a&&(o.createdAt={[i.between]:[t,a]});const d=await n.StockLog.findAll({where:o,include:[{model:n.Site},{model:n.Item,include:[{model:n.ItemGroup},{model:n.Unit}]},{model:n.User}],order:[["createdAt","DESC"]]}),c={};d.forEach((e=>{const t=e.itemId;c[t]||(c[t]={item:e.Item,totalConsumed:0,transactions:[]}),c[t].totalConsumed+=Math.abs(e.change),c[t].transactions.push(e)}));const l={totalTransactions:d.length,totalItemsConsumed:Object.keys(c).length,totalQuantityConsumed:d.reduce(((e,t)=>e+Math.abs(t.change)),0)};return{data:d,byItem:c,summary:l}},getInventoryTransferReport:async(e={})=>{const{startDate:t,endDate:a,siteId:r,otherSiteId:s,status:o}=e,d={issueType:"Site Transfer"};r&&(d.siteId=r),s&&(d.otherSiteId=s),o&&(d.status=o),t&&a&&(d.createdAt={[i.between]:[t,a]});const c=await n.MaterialIssue.findAll({where:d,include:[{model:n.Site,as:"fromSite"},{model:n.Site,as:"toSite"},{model:n.MaterialIssueItem,as:"items",include:[{model:n.Item,include:[{model:n.ItemGroup},{model:n.Unit}]}]}],order:[["createdAt","DESC"]]}),l={totalTransfers:c.length,byStatus:{},totalItemsTransferred:0};return c.forEach((e=>{const t=e.status;l.byStatus[t]||(l.byStatus[t]=0),l.byStatus[t]++,l.totalItemsTransferred+=e.items.reduce(((e,t)=>e+t.quantity),0)})),{data:c,summary:l}},getInventoryValuationReport:async(e={})=>{const{siteId:t,itemGroupId:a}=e,i={};t&&(i.siteId=t);const r=await n.SiteInventory.findAll({where:i,include:[{model:n.Item,include:[{model:n.ItemGroup,where:a?{id:a}:{}},{model:n.Unit}]},{model:n.Site}]}),s=r.map((e=>({site:e.Site,item:e.Item,quantity:e.quantity,minimumLevel:e.minimumLevel,status:e.status}))),o={totalItems:r.length,totalQuantity:r.reduce(((e,t)=>e+t.quantity),0),lowStockValue:s.filter((e=>e.quantity<=e.minimumLevel)).length};return{data:s,summary:o}},getProcurementSummaryReport:async(e={})=>{const{startDate:t,endDate:a,vendorId:r,status:s}=e,o={};r&&(o.vendorId=r),s&&(o.status=s),t&&a&&(o.createdAt={[i.between]:[t,a]});const d=await n.Procurement.findAll({where:o,include:[{model:n.Vendor},{model:n.Requisition},{model:n.ProcurementItem}],order:[["createdAt","DESC"]]}),c={totalProcurements:d.length,totalAmount:d.reduce(((e,t)=>e+(parseFloat(t.totalAmount)||0)),0),byStatus:{},byVendor:{}};return d.forEach((e=>{const t=e.status;c.byStatus[t]||(c.byStatus[t]={count:0,amount:0}),c.byStatus[t].count++,c.byStatus[t].amount+=parseFloat(e.totalAmount)||0;const a=e.Vendor?.name||"Unknown";c.byVendor[a]||(c.byVendor[a]={count:0,amount:0}),c.byVendor[a].count++,c.byVendor[a].amount+=parseFloat(e.totalAmount)||0})),{data:d,summary:c}},getProcurementVendorReport:async(e={})=>{const{startDate:t,endDate:a,vendorId:r}=e,s={};r&&(s.vendorId=r),t&&a&&(s.createdAt={[i.between]:[t,a]});const o=await n.Procurement.findAll({where:s,include:[{model:n.Vendor},{model:n.ProcurementItem}]}),d={};return o.forEach((e=>{const t=e.vendorId;d[t]||(d[t]={vendor:e.Vendor,totalOrders:0,totalAmount:0,onTimeDeliveries:0,pendingOrders:0,completedOrders:0});const a=d[t];a.totalOrders++,a.totalAmount+=parseFloat(e.totalAmount)||0,"delivered"===e.status&&a.completedOrders++,"pending"===e.status&&a.pendingOrders++,e.expectedDelivery&&"delivered"===e.status&&a.onTimeDeliveries++})),{data:Object.values(d),summary:{totalVendors:Object.keys(d).length,totalProcurements:o.length,totalAmount:o.reduce(((e,t)=>e+(parseFloat(t.totalAmount)||0)),0)}}},getPaymentStatusReport:async(e={})=>{const{startDate:t,endDate:a,status:r,paymentMethod:s}=e,o={};r&&(o.status=r),s&&(o.paymentMethod=s),t&&a&&(o.paymentDate={[i.between]:[t,a]});const d=await n.Payment.findAll({where:o,include:[{model:n.Invoice,as:"invoice",include:[{model:n.Procurement,as:"procurement"}]}],order:[["paymentDate","DESC"]]}),c={totalPayments:d.length,totalAmount:d.reduce(((e,t)=>e+(parseFloat(t.amount)||0)),0),byStatus:{},byMethod:{}};return d.forEach((e=>{const t=e.status;c.byStatus[t]||(c.byStatus[t]={count:0,amount:0}),c.byStatus[t].count++,c.byStatus[t].amount+=parseFloat(e.amount)||0;const a=e.paymentMethod;c.byMethod[a]||(c.byMethod[a]={count:0,amount:0}),c.byMethod[a].count++,c.byMethod[a].amount+=parseFloat(e.amount)||0})),{data:d,summary:c}},getInvoiceAgingReport:async(e={})=>{const{vendorId:t,status:a}=e,i={};a&&(i.status=a);const r=await n.Invoice.findAll({where:i,include:[{model:n.Procurement,as:"procurement",include:[{model:n.Vendor,where:t?{id:t}:{}}]},{model:n.Payment,as:"payments"}]}),s=new Date,o=r.map((e=>{const t=new Date(e.invoiceDate),a=Math.floor((s-t)/864e5),i=e.payments.reduce(((e,t)=>e+(parseFloat(t.amount)||0)),0),n=parseFloat(e.amount)-i;let r="0-30 days";return a>90?r="90+ days":a>60?r="60-90 days":a>30&&(r="30-60 days"),{invoice:e,daysOld:a,agingBucket:r,totalPaid:i,remainingAmount:n,isOverdue:a>30&&n>0}})),d={totalInvoices:r.length,totalAmount:r.reduce(((e,t)=>e+(parseFloat(t.amount)||0)),0),totalOutstanding:o.reduce(((e,t)=>e+t.remainingAmount),0),overdueAmount:o.filter((e=>e.isOverdue)).reduce(((e,t)=>e+t.remainingAmount),0),agingBuckets:{}};return o.forEach((e=>{const t=e.agingBucket;d.agingBuckets[t]||(d.agingBuckets[t]={count:0,amount:0}),d.agingBuckets[t].count++,d.agingBuckets[t].amount+=e.remainingAmount})),{data:o,summary:d}},getSitePerformanceReport:async(e={})=>{const{startDate:t,endDate:a,siteId:r}=e,s={};r&&(s.id=r);const o=await n.Site.findAll({where:s,include:[{model:n.Machinery},{model:n.User}]}),d=[];for(const e of o){const r={requestingSiteId:e.id};t&&a&&(r.createdAt={[i.between]:[t,a]});const s=await n.Requisition.findAll({where:r}),o={siteId:e.id};t&&a&&(o.createdAt={[i.between]:[t,a]});const c=await n.MaterialIssue.findAll({where:o}),l={siteId:e.id};t&&a&&(l.date={[i.between]:[t,a]});const u=await n.LogbookEntry.findAll({where:l});d.push({site:e,metrics:{totalMachines:e.Machineries.length,activeMachines:e.Machineries.filter((e=>"In Use"===e.status)).length,totalUsers:e.Users.length,totalRequisitions:s.length,pendingRequisitions:s.filter((e=>"pending"===e.status)).length,approvedRequisitions:s.filter((e=>"approved"===e.status)).length,totalMaterialIssues:c.length,totalLogbookEntries:u.length,totalDieselConsumed:u.reduce(((e,t)=>e+(t.dieselIssue||0)),0),totalKMRun:u.reduce(((e,t)=>e+(t.totalRunKM||0)),0)}})}return{data:d,summary:{totalSites:o.length,totalMachines:d.reduce(((e,t)=>e+t.metrics.totalMachines),0),totalUsers:d.reduce(((e,t)=>e+t.metrics.totalUsers),0),totalRequisitions:d.reduce(((e,t)=>e+t.metrics.totalRequisitions),0)}}},getRequisitionAnalysisReport:async(e={})=>{const{startDate:t,endDate:a,siteId:r,status:s,priority:o}=e,d={};r&&(d.requestingSiteId=r),s&&(d.status=s),o&&(d.requestPriority=o),t&&a&&(d.createdAt={[i.between]:[t,a]});const c=await n.Requisition.findAll({where:d,include:[{model:n.Site,as:"requestingSite"},{model:n.User,as:"preparedBy"},{model:n.User,as:"approvedBy"},{model:n.RequisitionItem,as:"items"}],order:[["createdAt","DESC"]]}),l={totalRequisitions:c.length,byStatus:{},byPriority:{},bySite:{},averageProcessingTime:0,totalItems:0};c.forEach((e=>{const t=e.status;l.byStatus[t]||(l.byStatus[t]={count:0,items:0}),l.byStatus[t].count++,l.byStatus[t].items+=e.items.length;const a=e.requestPriority;l.byPriority[a]||(l.byPriority[a]={count:0,items:0}),l.byPriority[a].count++,l.byPriority[a].items+=e.items.length;const i=e.requestingSite?.name||"Unknown";if(l.bySite[i]||(l.bySite[i]={count:0,items:0}),l.bySite[i].count++,l.bySite[i].items+=e.items.length,"approved"===e.status&&e.approvedAt){const t=new Date(e.approvedAt)-new Date(e.createdAt);l.averageProcessingTime+=t}l.totalItems+=e.items.length}));const u=c.filter((e=>"approved"===e.status&&e.approvedAt));return u.length>0&&(l.averageProcessingTime=l.averageProcessingTime/u.length/864e5),{data:c,summary:l}},getUserActivityReport:async(e={})=>{const{startDate:t,endDate:a,userId:r,siteId:s,activityType:o}=e,d={};r&&(d.userId=r),s&&(d.siteId=s),o&&(d.activityType=o),t&&a&&(d.createdAt={[i.between]:[t,a]});const c=await n.UserActivity.findAll({where:d,include:[{model:n.User,as:"user"},{model:n.Site,as:"site"}],order:[["createdAt","DESC"]]}),l={totalActivities:c.length,uniqueUsers:[...new Set(c.map((e=>e.userId)))].length,byActivityType:{},bySite:{},byUser:{}};return c.forEach((e=>{const t=e.activityType;l.byActivityType[t]||(l.byActivityType[t]=0),l.byActivityType[t]++;const a=e.site?.name||"Unknown";l.bySite[a]||(l.bySite[a]=0),l.bySite[a]++;const i=e.user?.name||"Unknown";l.byUser[i]||(l.byUser[i]=0),l.byUser[i]++})),{data:c,summary:l}},getAssetDepreciationReport:async(e={})=>{const{siteId:t,assetType:a,status:i}=e,r={};t&&(r.siteId=t),a&&(r.assetType=a),i&&(r.status=i);const s=await n.Machinery.findAll({where:r,include:[{model:n.Site,as:"site"}]}),o=new Date,d=s.map((e=>{const t=new Date(e.purchaseDate),a=(o-t)/31536e6,i=parseFloat(e.purchaseValue)||0,n=Math.max(0,i*(1-.1*a));return{asset:e,originalValue:i,currentValue:n,totalDepreciation:i-n,depreciationRate:10,ageInYears:Math.round(100*a)/100}})),c={totalAssets:s.length,totalOriginalValue:d.reduce(((e,t)=>e+t.originalValue),0),totalCurrentValue:d.reduce(((e,t)=>e+t.currentValue),0),totalDepreciation:d.reduce(((e,t)=>e+t.totalDepreciation),0),averageAge:d.length>0?d.reduce(((e,t)=>e+t.ageInYears),0)/d.length:0};return{data:d,summary:c}},getMaintenanceCostAnalysis:async(e={})=>{const{startDate:t,endDate:a,siteId:r,machineId:s,maintenanceType:o}=e,d={};r&&(d.siteId=r),s&&(d.machineId=s),o&&(d.type=o),t&&a&&(d.date={[i.between]:[t,a]});const c=await n.MaintenanceLog.findAll({where:d,include:[{model:n.Machinery,as:"machine",include:[{model:n.Site,as:"site"}]}],order:[["date","DESC"]]}),l={};c.forEach((e=>{const t=e.machineId;l[t]||(l[t]={machine:e.machine,totalCost:0,maintenanceCount:0,lastMaintenance:null,avgCostPerMaintenance:0,byType:{}});const a=l[t];a.totalCost+=parseFloat(e.cost)||0,a.maintenanceCount++,(!a.lastMaintenance||new Date(e.date)>new Date(a.lastMaintenance))&&(a.lastMaintenance=e.date);const i=e.type;a.byType[i]||(a.byType[i]={count:0,cost:0}),a.byType[i].count++,a.byType[i].cost+=parseFloat(e.cost)||0})),Object.values(l).forEach((e=>{e.avgCostPerMaintenance=e.maintenanceCount>0?e.totalCost/e.maintenanceCount:0}));const u={totalMaintenanceRecords:c.length,totalCost:c.reduce(((e,t)=>e+(parseFloat(t.cost)||0)),0),averageCostPerMaintenance:c.length>0?c.reduce(((e,t)=>e+(parseFloat(t.cost)||0)),0)/c.length:0,machinesWithMaintenance:Object.keys(l).length,highestCostMachine:null,lowestCostMachine:null},m=Object.values(l);return m.length>0&&(u.highestCostMachine=m.reduce(((e,t)=>t.totalCost>e.totalCost?t:e)),u.lowestCostMachine=m.reduce(((e,t)=>t.totalCost<e.totalCost?t:e))),{data:m,summary:u}},getFuelConsumptionReport:async(e={})=>{const{startDate:t,endDate:a,siteId:r,machineId:s}=e,o={};r&&(o.siteId=r),s&&(o.machineId=s),t&&a&&(o.date={[i.between]:[t,a]});const d=await n.LogbookEntry.findAll({where:o,include:[{model:n.Machinery,as:"machine"},{model:n.Site,as:"site"}],order:[["date","DESC"]]}),c={};d.forEach((e=>{const t=e.machineId;c[t]||(c[t]={machine:e.machine,totalFuelConsumed:0,totalKMRun:0,totalHoursRun:0,entries:0,avgFuelPerKM:0,avgFuelPerHour:0,efficiency:0});const a=c[t];a.totalFuelConsumed+=e.dieselIssue||0,a.totalKMRun+=e.totalRunKM||0,a.totalHoursRun+=e.totalRunHrsMeter||0,a.entries++})),Object.values(c).forEach((e=>{e.avgFuelPerKM=e.totalKMRun>0?e.totalFuelConsumed/e.totalKMRun:0,e.avgFuelPerHour=e.totalHoursRun>0?e.totalFuelConsumed/e.totalHoursRun:0,e.efficiency=e.totalFuelConsumed>0?e.totalKMRun/e.totalFuelConsumed:0}));const l={totalEntries:d.length,totalFuelConsumed:d.reduce(((e,t)=>e+(t.dieselIssue||0)),0),totalKMRun:d.reduce(((e,t)=>e+(t.totalRunKM||0)),0),totalHoursRun:d.reduce(((e,t)=>e+(t.totalRunHrsMeter||0)),0),averageEfficiency:0,machinesTracked:Object.keys(c).length},u=Object.values(c);return u.length>0&&(l.averageEfficiency=u.reduce(((e,t)=>e+t.efficiency),0)/u.length),{data:u,summary:l}},getVendorPerformanceReport:async(e={})=>{const{startDate:t,endDate:a,vendorId:r,status:s}=e,o={};r&&(o.vendorId=r),s&&(o.status=s),t&&a&&(o.createdAt={[i.between]:[t,a]});const d=await n.Procurement.findAll({where:o,include:[{model:n.Vendor},{model:n.ProcurementItem}]}),c={};d.forEach((e=>{const t=e.vendorId;c[t]||(c[t]={vendor:e.Vendor,totalOrders:0,totalValue:0,completedOrders:0,pendingOrders:0,cancelledOrders:0,averageOrderValue:0,onTimeDeliveryRate:0,qualityScore:0});const a=c[t];switch(a.totalOrders++,a.totalValue+=parseFloat(e.totalAmount)||0,e.status){case"delivered":a.completedOrders++;break;case"pending":a.pendingOrders++;break;case"cancelled":a.cancelledOrders++}})),Object.values(c).forEach((e=>{e.averageOrderValue=e.totalOrders>0?e.totalValue/e.totalOrders:0,e.onTimeDeliveryRate=e.completedOrders>0?e.completedOrders/e.totalOrders*100:0,e.qualityScore=100*Math.random()}));const l={totalVendors:Object.keys(c).length,totalOrders:d.length,totalValue:d.reduce(((e,t)=>e+(parseFloat(t.totalAmount)||0)),0),topPerformer:null,averageOrderValue:0},u=Object.values(c);return u.length>0&&(l.topPerformer=u.reduce(((e,t)=>t.onTimeDeliveryRate>e.onTimeDeliveryRate?t:e)),l.averageOrderValue=l.totalValue/l.totalOrders),{data:u,summary:l}}}},394:(e,t,a)=>{const i=a(2446),n=i.object({startDate:i.date().optional(),endDate:i.date().optional().when("startDate",{is:i.exist(),then:i.date().min(i.ref("startDate")).required(),otherwise:i.optional()}),siteId:i.number().integer().positive().optional(),currentSiteId:i.number().integer().positive().optional(),destinationSiteId:i.number().integer().positive().optional(),otherSiteId:i.number().integer().positive().optional(),machineId:i.number().integer().positive().optional(),itemId:i.number().integer().positive().optional(),itemGroupId:i.number().integer().positive().optional(),userId:i.number().integer().positive().optional(),vendorId:i.number().integer().positive().optional(),status:i.string().optional(),type:i.string().optional(),maintenanceType:i.string().optional(),requestType:i.string().optional(),activityType:i.string().optional(),assetType:i.string().optional(),priority:i.string().optional(),paymentMethod:i.string().optional(),lowStock:i.boolean().optional(),expiring_within_days:i.number().integer().min(1).max(365).optional(),page:i.number().integer().min(1).optional(),limit:i.number().integer().min(1).max(1e3).optional()}).unknown(!1);e.exports={reportsFiltersSchema:n}},5146:(e,t,a)=>{const i=a(1459);e.exports={createRequisition:async(e,t)=>{const a=await i.createRequisition(e.body,e.user.id);t.sendResponse(a,"Requisition created successfully")},getRequisitionById:async(e,t)=>{const a=await i.getRequisitionById(e.params.id);t.sendResponse(a,"Requisition fetched successfully")},getAllRequisitions:async(e,t)=>{const a=e.user.siteId,n=await i.getAllRequisitions(a);t.sendResponse(n,"Requisitions fetched successfully")},approveRequisition:async(e,t)=>{const{requisitionId:a}=e.params,n=e.user.id,r=await i.approveRequisition(a,n);t.sendResponse(r,"Requisition approved successfully")},pmApproveRequisition:async(e,t)=>{const{requisitionId:a}=e.params,n=e.user.id,r=await i.pmApproveRequisition(a,n);t.sendResponse(r,"Requisition approved by PM successfully")},hoApproveRequisition:async(e,t)=>{const{requisitionId:a}=e.params,n=e.user.id,r=await i.hoApproveRequisition(a,n);t.sendResponse(r,"Requisition approved by HO successfully")},requisitionDelete:async(e,t)=>{const{requisitionId:a}=e.params,n=await i.requisitionDelete(a);t.sendResponse(n,"Requisition deleted successfully")},completeRequisition:async(e,t)=>{const{requisitionId:a}=e.params,n=e.user.id,r=await i.completeRequisition(a,n);t.sendResponse(r,"Requisition marked as completed successfully")},rejectRequisition:async(e,t)=>{const{requisitionId:a}=e.params,{rejectionReason:n}=e.body,r=e.user.id,s=await i.rejectRequisition(a,r,n);t.sendResponse(s,"Requisition rejected successfully")},rejectRequisitionBySite:async(e,t)=>{const{id:a}=e.params,n=await i.rejectRequisitionBySite(a,e.body,e.user);t.sendResponse(n,"Requisition rejected successfully")},getRequisitionRejections:async(e,t)=>{const{id:a}=e.params,n=await i.getRequisitionRejections(a);t.sendResponse(n,"Rejections retrieved successfully")},updateItemQuantity:async(e,t)=>{const{id:a}=e.params,{items:n}=e.body,r=await i.updateItemQuantity(a,n);t.sendResponse(r,"Item quantity updated successfully")}}},1116:(e,t,a)=>{const i=a(7252).Router(),n=a(5146),r=a(7434),s=a(4081),{createRequisitionSchema:o}=a(9554);i.post("/requisitions/",s(o),r(n.createRequisition)),i.get("/requisitions/:id",r(n.getRequisitionById)),i.get("/requisitions/",r(n.getAllRequisitions)),i.post("/requisitions/:requisitionId/approve",r(n.approveRequisition)),i.post("/requisitions/:requisitionId/pm-approve",r(n.pmApproveRequisition)),i.post("/requisitions/:requisitionId/ho-approve",r(n.hoApproveRequisition)),i.delete("/requisitions/:requisitionId",r(n.requisitionDelete)),i.post("/requisitions/:requisitionId/complete",r(n.completeRequisition)),i.post("/requisitions/:requisitionId/reject",r(n.rejectRequisition)),i.post("/requisitions/:id/site-reject",r(n.rejectRequisitionBySite)),i.put("/requisitions/:id/item-quantity-update",r(n.updateItemQuantity)),i.get("/requisitions/:id/site-rejections",r(n.getRequisitionRejections)),e.exports=i},1459:(e,t,a)=>{const i=a(9239),n=a(5771),r=a(7715),s=async e=>await i.User.findByPk(e);e.exports={createRequisition:async(e,t)=>{const a=await i.sequelize.transaction((async t=>{const{items:a,...n}=e,r=await i.Requisition.create(n,{transaction:t}),s=a.map((e=>({requisitionId:r.id,itemId:e.itemId,quantity:e.quantity})));return await i.RequisitionItem.bulkCreate(s,{transaction:t}),await i.Requisition.findByPk(r.id,{include:[{model:i.RequisitionItem,as:"items"}],transaction:t})})),o=await s(t);return await r({eventType:"MaterialRequisition",eventAction:"Requested",referenceId:a.id,siteId:a.requestingSiteId,createdBy:a.preparedById,roles:[n.MECHANICAL_HEAD,n.ADMIN,n.MECHANICAL_MANAGER],title:"Material Requisition Requested",description:`New requisition (#${a.requisitionNo}) has been created by user #${o.name}.`}),a},getRequisitionById:async e=>await i.Requisition.findByPk(e,{include:[{model:i.RequisitionItem,as:"items",include:[{model:i.Item}]},{model:i.User,as:"preparedBy",attributes:["id","name","email"]},{model:i.Site,as:"requestingSite",attributes:["id","name","code"]},{model:i.User,as:"approvedByPMUser",attributes:["id","name","email"]},{model:i.User,as:"approvedByHOUser",attributes:["id","name","email"]},{model:i.User,as:"rejectedBy",attributes:["id","name","email"]},{model:i.User,as:"completedBy",attributes:["id","name","email"]},{model:i.Site,as:"requestingSite",attributes:["id","name","code"]},{model:i.MaterialIssue,as:"materialIssues",include:[{model:i.User,as:"issuedBy",attributes:["id","name","email"]},{model:i.User,as:"approvedBy",attributes:["id","name","email"]},{model:i.User,as:"dispatchedBy",attributes:["id","name","email"]},{model:i.User,as:"receivedBy",attributes:["id","name","email"]},{model:i.Site,as:"fromSite",attributes:["id","name","code"]},{model:i.Site,as:"toSite",attributes:["id","name","code"]},{model:i.MaterialIssueItem,as:"items",include:[{model:i.Item}]}]},{model:i.Procurement,as:"procurements",include:[{model:i.Vendor},{model:i.ProcurementItem}]},{model:i.RequisitionSiteRejection,as:"siteRejections",include:[{model:i.User,as:"rejectedBy",attributes:["id","name","email"]}]}]}),getAllRequisitions:async e=>{const t=[{model:i.User,as:"preparedBy",attributes:["id","name","email"]},{model:i.Site,as:"requestingSite",attributes:["id","name","code"]}],a={};return e&&(a[i.Sequelize.Op.or]=[{requestingSiteId:e},{status:{[i.Sequelize.Op.in]:["approvedByHo","completed"]}}]),e||(a.status={[i.Sequelize.Op.notIn]:["pending"]}),await i.Requisition.findAll({where:a,attributes:["id","requisitionNo","status","requestedFor","chargeType","requestPriority","requestedAt"],include:t,order:[["requestedAt","DESC"]]})},approveRequisition:async(e,t)=>{const a=await i.Requisition.findByPk(e);if(!a)throw new Error("Requisition not found");if("pending"!==a.status)throw new Error("Requisition already processed");a.status="approved",a.approvedById=t,a.approvedAt=new Date,await a.save();const o=await s(t);return await r({eventType:"MaterialRequisition",eventAction:"Approved",referenceId:a.id,siteId:a.requestingSiteId,createdBy:t,roles:[n.STORE_MANAGER],title:"Material Requisition Approved",description:`Requisition (#${a.requisitionNo}) has been approved by user #${o.name}.`}),a},pmApproveRequisition:async(e,t,a)=>{const o=await i.Requisition.findByPk(e,{include:[{model:i.RequisitionItem,as:"items"}]});if(!o)throw new Error("Requisition not found");if("pending"!==o.status)throw new Error("Already processed");o.status="approvedByPm",o.approvedByPM=t,o.approvedAtPM=new Date,await o.save();const d=await s(t);return await r({eventType:"MaterialRequisition",eventAction:"PMApproved",referenceId:o.id,siteId:o.requestingSiteId,createdBy:t,roles:[n.MECHANICAL_HEAD,n.ADMIN,n.MECHANICAL_MANAGER],title:"Material Requisition PM Approved",description:`Requisition (#${o.requisitionNo}) has been approved by PM #${d.name}.`}),o},hoApproveRequisition:async(e,t)=>{const a=await i.Requisition.findByPk(e,{include:[{model:i.RequisitionItem,as:"items"}]});if(!a)throw new Error("Requisition not found");if("approvedByPm"!==a.status)throw new Error("Requisition must be approved by PM first");a.status="approvedByHo",a.approvedByHO=t,a.approvedAtHO=new Date,await a.save();const o=await s(t);return await r({eventType:"MaterialRequisition",eventAction:"HOApproved",referenceId:a.id,siteId:a.requestingSiteId,createdBy:t,roles:[n.MECHANICAL_HEAD,n.ADMIN,n.MECHANICAL_MANAGER],title:"Material Requisition HO Approved",description:`Requisition (#${a.requisitionNo}) has been approved by HO #${o.name}.`}),a},requisitionDelete:async e=>{const t=await i.Requisition.findByPk(e);if(!t)throw new Error("Requisition not found");return await i.sequelize.transaction((async a=>{await i.RequisitionItem.destroy({where:{requisitionId:e},transaction:a}),await t.destroy({transaction:a})})),{message:"Requisition deleted successfully"}},completeRequisition:async(e,t)=>{const a=await i.Requisition.findByPk(e);if(!a)throw new Error("Requisition not found");if("approvedByHo"!==a.status)throw new Error("Only approved requisitions can be marked as completed");a.status="completed",a.completedById=t,a.completedAt=new Date,await a.save();const o=await s(t);return await r({eventType:"MaterialRequisition",eventAction:"Completed",referenceId:a.id,siteId:a.requestingSiteId,createdBy:t,roles:[n.STORE_MANAGER],title:"Material Requisition Completed",description:`Requisition (#${a.requisitionNo}) has been marked as completed by user #${o.name}.`}),a},rejectRequisition:async(e,t,a)=>{const o=await i.Requisition.findByPk(e);if(!o)throw new Error("Requisition not found");if(["approved","completed","rejected"].includes(o.status))throw new Error(`Cannot reject. Requisition is already ${o.status}`);o.status="rejected",o.rejectedById=t,o.rejectedAt=new Date,o.rejectionReason=a;const d=await s(t);return await o.save(),await r({eventType:"MaterialRequisition",eventAction:"Rejected",referenceId:o.id,siteId:o.requestingSiteId,createdBy:t,roles:[n.STORE_MANAGER],title:"Material Requisition Rejected",description:`Requisition (#${o.requisitionNo}) has been rejected by user #${d.name}. Reason: ${a||"Not provided"}`}),o},rejectRequisitionBySite:async(e,t,a)=>{const n=await i.User.findByPk(a.id,{include:[{model:i.Site}]});if(!n||!n.Site)throw new Error("User must be associated with a site");const r=await i.Requisition.findByPk(e);if(!r)throw new Error("Requisition not found");if(n.siteId===r.requestingSiteId)throw new Error("Requesting site cannot reject its own requisition");if(await i.RequisitionSiteRejection.findOne({where:{requisitionId:e,siteId:n.siteId}}))throw new Error("Site has already rejected this requisition");return await i.RequisitionSiteRejection.create({requisitionId:e,siteId:n.siteId,rejectedById:a.id,rejectionReason:t.rejectionReason})},getRequisitionRejections:async e=>await i.RequisitionSiteRejection.findAll({where:{requisitionId:e},include:[{model:i.Site,as:"site",attributes:["id","name","location"]},{model:i.User,as:"rejectedBy",attributes:["id","name","email"]}],order:[["rejectedAt","DESC"]]}),updateItemQuantity:async(e,t)=>await i.sequelize.transaction((async a=>{for(const n of t){const{itemId:t,newQuantity:r}=n,s=await i.RequisitionItem.findOne({where:{requisitionId:e,id:t},transaction:a});if(!s)throw new Error("Requisition item not found");s.quantity=r,await s.save({transaction:a})}}))}},9554:(e,t,a)=>{const i=a(2446),n=i.object({itemId:i.number().integer().required(),quantity:i.number().positive().required()}),r=i.object({requestedAt:i.date().required(),requestingSiteId:i.number().required(),requestedFor:i.string().required(),chargeType:i.string().required(),requestPriority:i.string().valid("High","Medium","Low").required(),dueDate:i.date().required(),preparedById:i.number().required(),items:i.array().items(n).min(1).required()});e.exports={createRequisitionSchema:r}},7186:(e,t,a)=>{const i=a(1515);e.exports={createSite:async(e,t)=>{const a=await i.createSite(e.body);t.sendResponse(a,"Site created successfully")},getAllSites:async(e,t)=>{const a=await i.getAllSites(e.user.siteId,e.query.searchQuery);t.sendResponse(a,"All sites fetched successfully")},getSiteById:async(e,t)=>{const a=await i.getSiteById(e.params.id);t.sendResponse(a,"Site fetched successfully")},getVirtualSite:async(e,t)=>{const a=await i.getVirtualSite();t.sendResponse(a,"Virtual site fetched successfully")},updateSite:async(e,t)=>{const a=await i.updateSite(e.params.id,e.body);t.sendResponse(a,"Site updated successfully")},deleteSite:async(e,t)=>{const a=await i.deleteSite(e.params.id);t.sendResponse(null,a.message)},restoreSite:async(e,t)=>{const a=await i.restoreSite(e.params.id);t.sendResponse(null,a.message)},getSiteInventoryMovement:async(e,t)=>{const{id:a}=e.params,n=e.query,r=await i.getSiteInventoryMovement(a,n);t.sendResponse(r,"Site inventory movement fetched successfully")},getSiteSummaryStats:async(e,t)=>{const{id:a}=e.params,n=await i.getSiteSummaryStats(a);t.sendResponse(n,"Site summary statistics fetched successfully")},getDiscrepancyReport:async(e,t)=>{const{id:a}=e.params,n=await i.getDiscrepancyReport(a);t.sendResponse(n,"Discrepancy report fetched successfully")},getVirtualSiteProcurementSummary:async(e,t)=>{const a=await i.getVirtualSiteProcurementSummary();t.sendResponse(a,"Virtual site procurement summary fetched successfully")},dispatchProcurementItems:async(e,t)=>{const a=await i.dispatchProcurementItems(e.body);t.sendResponse(a,"Items dispatched successfully")},getIncomingDispatches:async(e,t)=>{const{siteId:a}=e.user,n=await i.getIncomingDispatches(a);t.sendResponse(n,"Incoming dispatches fetched successfully")},receiveDispatch:async(e,t)=>{const{siteId:a,dispatchId:n}=e.params,r=await i.receiveDispatch(a,n);t.sendResponse(r,"Dispatch received successfully")}}},5380:(e,t,a)=>{const i=a(7252),n=a(7186),r=a(3034),s=a(4081),o=a(7434),d=a(7242),c=i.Router();c.get("/virtual",o(n.getVirtualSite)),c.get("/virtual/procurement-summary",o(n.getVirtualSiteProcurementSummary)),c.post("/virtual/dispatch",o(n.dispatchProcurementItems)),c.post("/",s(r.createSiteSchema),o(n.createSite)),c.get("/",o(n.getAllSites)),c.get("/:id/inventory-movement",o(n.getSiteInventoryMovement)),c.get("/:id/summary-stats",o(n.getSiteSummaryStats)),c.get("/:id/discrepancy-report",o(n.getDiscrepancyReport)),c.get("/:siteId/incoming-dispatches",o(n.getIncomingDispatches)),c.post("/:siteId/dispatch/:dispatchId/receive",o(n.receiveDispatch)),c.get("/:id",o(n.getSiteById)),c.put("/:id",d([1,2,3]),s(r.updateSiteSchema),o(n.updateSite)),c.delete("/:id",d([1,2,3]),o(n.deleteSite)),c.post("/:id/restore",d([1,2,3]),o(n.restoreSite)),e.exports=c},1515:(e,t,a)=>{const i=a(9239),{Op:n,Sequelize:r,col:s,fn:o,literal:d}=a(9031),c=async()=>await i.Site.findOne({where:{type:"virtual"},include:[{model:i.Department,attributes:["id","name"]}]});e.exports={createSite:async e=>await i.Site.create(e),getAllSites:async(e,t)=>t?await i.Site.findAll({where:{[i.Sequelize.Op.or]:[{name:{[i.Sequelize.Op.like]:`%${t}%`}},{code:{[i.Sequelize.Op.like]:`%${t}%`}},{address:{[i.Sequelize.Op.like]:`%${t}%`}}]},include:[{model:i.Department,attributes:["id","name"]}]}):await i.Site.findAll({include:[{model:i.Department,attributes:["id","name"]}]}),getSiteById:async e=>{const t=await i.Site.findByPk(e,{include:[{model:i.Department,attributes:["id","name"]},{model:i.Machinery,attributes:["id","machineName","capacity","ownerName","ownerType"]}]});if(!t)throw new Error("Site not found.");return t},getVirtualSite:c,updateSite:async(e,t)=>{const a=await i.Site.findByPk(e);if(!a)throw new Error("Site not found.");return await a.update(t)},deleteSite:async e=>{const t=await i.Site.findByPk(e);if(!t)throw new Error("Site not found.");return await t.destroy(),{message:"Site deleted successfully."}},restoreSite:async e=>{const t=await i.Site.findByPk(e,{paranoid:!1});if(!t)throw new Error("Site not found.");if(!t.deletedAt)throw new Error("Site is not deleted.");return await t.restore(),{message:"Site restored successfully."}},getAllSitesV2:async(e,t)=>{const{page:a=1,limit:r=20,search:s="",sortBy:o="name",sortOrder:d="ASC",departmentId:c,status:l}=e.query,u=(a-1)*r,m={};s&&(m[n.or]=[{name:{[n.iLike]:`%${s}%`}},{code:{[n.iLike]:`%${s}%`}},{address:{[n.iLike]:`%${s}%`}}]),c&&(m.departmentId=c),l&&(m.status=l);const{count:p,rows:y}=await i.Site.findAndCountAll({where:m,include:[{model:i.Department,attributes:["id","name"]}],order:[[o,d]],offset:u,limit:r});t.sendResponse({data:y,totalCount:p,totalPages:Math.ceil(p/r),currentPage:Number(a)})},getSiteInventoryMovement:async(e,t={})=>{const{startDate:a,endDate:r,itemType:c,page:l=1,limit:u=20}=t,m={siteId:e};a&&r&&(m.createdAt={[n.between]:[new Date(a),new Date(r)]});const p=["itemId","sourceType","sourceId",s("Item.id"),s("Item.name"),s("Item.ItemGroup.id"),s("Item.ItemGroup.name")],{count:y,rows:I}=await i.StockLog.findAndCountAll({where:m,attributes:[...p,[o("SUM",d("CASE WHEN type = 'IN' THEN change ELSE 0 END")),"totalIn"],[o("SUM",d("CASE WHEN type = 'OUT' THEN change ELSE 0 END")),"totalOut"],[o("MIN",d("CASE WHEN type = 'IN' THEN \"createdAt\" ELSE NULL END")),"firstInDate"],[o("MAX",d("CASE WHEN type = 'IN' THEN \"createdAt\" ELSE NULL END")),"latestInDate"],[o("MIN",d("CASE WHEN type = 'OUT' THEN \"createdAt\" ELSE NULL END")),"firstOutDate"],[o("MAX",d("CASE WHEN type = 'OUT' THEN \"createdAt\" ELSE NULL END")),"latestOutDate"]],include:[{model:i.Item,attributes:["id","name"],include:[{model:i.ItemGroup,attributes:["id","name"]}]}],group:p,order:[[o("MAX",s("createdAt")),"DESC"]],limit:parseInt(u),offset:(parseInt(l)-1)*parseInt(u)});return{data:await Promise.all(I.map((async e=>{let t="",a=null,n=null;const r=e.get({plain:!0});let s=null;switch("Requisition"===r.sourceType&&(s=await i.Requisition.findByPk(r.sourceId,{include:[{model:i.Site,as:"requestingSite"}]})),"Procurement"!==r.sourceType||s||(s=await i.Procurement.findByPk(r.sourceId,{include:[{model:i.Requisition,attributes:["id","requisitionNo"],include:[{model:i.Site,as:"requestingSite"}]}]})),r.sourceType){case"Issue":case"Consumption":const e=await i.MaterialIssue.findByPk(r.sourceId,{include:[{model:i.Site,as:"fromSite"},{model:i.Site,as:"toSite"}]});e&&("Site Transfer"===e.issueType?(a=e.fromSite?.name||"Unknown Site",n=e.toSite?.name||"Another Site",t=`Transfer by ${e.issueNumber}`):(a=e.fromSite?.name||"-",n="Consumption",t=`Issue by ${e.issueNumber}`));break;case"Requisition":s&&(a="Fulfilling Requisition (Current Site)",n=s.requestingSite?.name||"Requesting Site",t=`Requisition by ${s.requisitionNo}`);break;case"Procurement":const o=await i.Procurement.findByPk(r.sourceId);o&&(a="Supplier/External Source",n=s?.requestingSite?.name||"Current Site (Receipt)",t=`Procurement by ${o.procurementNo}`);break;case"Dispatch":const d=await i.Dispatch.findByPk(r.sourceId,{include:[{model:i.Procurement,include:[{model:i.Requisition,include:[{model:i.Site,as:"requestingSite"}]}]}]});if(d&&d.Procurement){const e=d.Procurement.Requisition?.requestingSite?.name||"Unknown Site";r.type,a="Virtual Site",n=e,t=`Dispatch for PO ${d.Procurement.procurementNo} (${d.vehicleNo||"No Vehicle"})`}break;default:t=r.sourceType||"Other",a=r.totalOut>0?"Current Site":"External Source",n=r.totalIn>0?"Current Site":"External Destination"}return{...r,reference:t,sourceDescription:a,destinationDescription:n,inDates:r.firstInDate,outDates:r.firstOutDate}}))),totalCount:Array.isArray(y)?y.length:y,totalPages:Math.ceil((Array.isArray(y)?y.length:y)/u),currentPage:parseInt(l)}},getSiteSummaryStats:async e=>{const[t,a,n]=await Promise.all([i.StockLog.sum("change",{where:{siteId:e,type:"IN"}}),i.StockLog.sum("change",{where:{siteId:e,type:"OUT"}}),i.SiteInventory.sum("quantity",{where:{siteId:e}})]),[r,s]=await Promise.all([i.StockLog.count({where:{siteId:e,type:"IN"}}),i.StockLog.count({where:{siteId:e,type:"OUT"}})]);return{totalIn:t||0,totalOut:a||0,currentInventory:n||0,inTransactionCount:r||0,outTransactionCount:s||0,netMovement:(t||0)-(a||0)}},getDiscrepancyReport:async e=>{const t=await i.StockLog.findAll({where:{siteId:e},include:[{model:i.Item}],order:[["createdAt","ASC"]]}),a={};return t.forEach((e=>{a[e.itemId]||(a[e.itemId]={item:e.Item,inTotal:0,outTotal:0,net:0}),"IN"===e.type?(a[e.itemId].inTotal+=e.change,a[e.itemId].net+=e.change):(a[e.itemId].outTotal+=e.change,a[e.itemId].net-=e.change)})),Object.values(a).filter((e=>0!==e.net))},getVirtualSiteProcurementSummary:async()=>{const e=await c();if(!e)throw new Error("Virtual site not found");const t=await i.StockLog.findAll({where:{siteId:e.id,type:"IN",sourceType:"Procurement"},include:[{model:i.Item}],order:[["createdAt","DESC"]]}),a={},n=[];return t.forEach((e=>{a[e.sourceId]||(a[e.sourceId]={procurementId:e.sourceId,items:[],totalIn:0,totalOut:0,dispatchedItems:{}},n.push(e.sourceId)),a[e.sourceId].items.push({item:e.Item,change:e.change,type:e.type,createdAt:e.createdAt}),a[e.sourceId].totalIn+=e.change})),n.length>0&&(await i.Procurement.findAll({where:{id:n},attributes:["id","procurementNo","createdAt"],include:[{model:i.Requisition,attributes:["id","requisitionNo"],include:[{model:i.Site,as:"requestingSite",attributes:["id","name"]}]},{model:i.Dispatch,include:[{model:i.DispatchItem,as:"items"}]}]})).forEach((e=>{a[e.id]&&(a[e.id].procurementNo=e.procurementNo,a[e.id].procurementDate=e.createdAt,a[e.id].requisitionNo=e.Requisition?.requisitionNo||"N/A",a[e.id].destinationSite=e.Requisition?.requestingSite?.name||"Unknown",e.Dispatches&&e.Dispatches.forEach((t=>{t.items&&t.items.forEach((t=>{a[e.id].dispatchedItems[t.itemId]||(a[e.id].dispatchedItems[t.itemId]=0),a[e.id].dispatchedItems[t.itemId]+=t.quantity,a[e.id].totalOut+=t.quantity}))})))})),{virtualSiteId:e.id,virtualSiteName:e.name,procurementMovements:n.map((e=>a[e])),summary:{totalIn:t.reduce(((e,t)=>e+t.change),0),totalOut:Object.values(a).reduce(((e,t)=>e+t.totalOut),0),activeProcurements:n.length}}},dispatchProcurementItems:async e=>{const{procurementId:t,items:a,vehicleNo:n,driverName:r,remarks:s}=e,o=await i.sequelize.transaction();try{const e=await c();if(!e)throw new Error("Virtual site not found");const d=await i.Procurement.findByPk(t,{include:[{model:i.Requisition,include:[{model:i.Site,as:"requestingSite"}]}],transaction:o});if(!d)throw new Error("Procurement not found");const l=d.Requisition?.requestingSite;if(!l)throw new Error("Requesting site not found for this procurement");const u=await i.Dispatch.create({vehicleNo:n,driverName:r,remarks:s,procurementId:d.id,fromSiteId:e.id,toSiteId:l.id},{transaction:o});for(const t of a){const a=await i.SiteInventory.findOne({where:{siteId:e.id,itemId:t.itemId},transaction:o});if(!a||a.quantity<t.quantity)throw new Error(`Insufficient stock for item ID ${t.itemId} in Virtual Site`);await i.DispatchItem.create({dispatchId:u.id,itemId:t.itemId,quantity:t.quantity},{transaction:o}),await a.decrement("quantity",{by:t.quantity,transaction:o}),await i.StockLog.create({siteId:e.id,itemId:t.itemId,change:t.quantity,type:"OUT",sourceType:"Dispatch",sourceId:u.id,userId:null},{transaction:o})}return await o.commit(),{message:"Items dispatched successfully",dispatchId:u.id}}catch(e){throw await o.rollback(),e}},getIncomingDispatches:async e=>await i.Dispatch.findAll({where:{toSiteId:e,status:"dispatched"},include:[{model:i.DispatchItem,as:"items",include:[{model:i.Item,attributes:["id","name","partNumber"],include:[{model:i.Unit,attributes:["name","shortName"]}]}]},{model:i.Procurement,attributes:["procurementNo"]},{model:i.Site,as:"fromSite",attributes:["name"]}],order:[["createdAt","DESC"]]}),receiveDispatch:async(e,t)=>{const a=await i.sequelize.transaction();try{const n=await i.Dispatch.findOne({where:{id:t,toSiteId:e,status:"dispatched"},include:[{model:i.DispatchItem,as:"items"}],transaction:a});if(!n)throw new Error("Dispatch not found or already received");for(const t of n.items){const[r,s]=await i.SiteInventory.findOrCreate({where:{siteId:e,itemId:t.itemId},defaults:{quantity:0},transaction:a});await r.increment("quantity",{by:t.quantity,transaction:a}),await i.StockLog.create({siteId:e,itemId:t.itemId,change:t.quantity,type:"IN",sourceType:"Dispatch",sourceId:n.id,userId:null},{transaction:a})}return await n.update({status:"received"},{transaction:a}),await a.commit(),{message:"Dispatch received successfully"}}catch(e){throw await a.rollback(),e}}}},3034:(e,t,a)=>{const i=a(2446),n=i.object({name:i.string().min(3).max(100).required().messages({"string.base":"Name must be a string","string.empty":"Name is required","string.min":"Name must be at least 3 characters long","string.max":"Name must not exceed 100 characters","any.required":"Name is required"}),address:i.string().min(3).max(200).required().messages({"string.base":"Site adress must be a string","string.empty":"Site adress is required","string.min":"Site adress must be at least 3 characters long","string.max":"Site adress must not exceed 200 characters","any.required":"Site adress is required"}),departmentId:i.number().integer().positive().required().messages({"number.base":"Department ID must be a number","number.integer":"Department ID must be an integer","number.positive":"Department ID must be a positive number","any.required":"Department ID is required"}),mobileNumber:i.string().optional().messages({"string.base":"Mobile number must be a string","string.empty":"Mobile number is required"}),pincode:i.string().optional().messages({"string.base":"Pincode must be a string","string.empty":"Pincode is required"}),code:i.string().allow(null,"").optional(),status:i.string().valid("active","closed","paused").default("active").messages({"any.only":'Status must be one of "active", "closed", or "paused"'})}),r=i.object({name:i.string().min(3).max(100).optional().messages({"string.base":"Name must be a string","string.empty":"Name must not be empty","string.min":"Name must be at least 3 characters long","string.max":"Name must not exceed 100 characters"}),address:i.string().min(3).max(200).required().messages({"string.base":"Site adress must be a string","string.empty":"Site adress is required","string.min":"Site adress must be at least 3 characters long","string.max":"Site adress must not exceed 200 characters","any.required":"Site adress is required"}),mobileNumber:i.string().optional().messages({"string.base":"Mobile number must be a string","string.empty":"Mobile number is required"}),departmentId:i.number().integer().positive().optional().messages({"number.base":"Department ID must be a number","number.integer":"Department ID must be an integer","number.positive":"Department ID must be a positive number"}),status:i.string().valid("active","closed","paused").optional().messages({"any.only":'Status must be one of "active", "closed", or "paused"'}),pincode:i.string().optional().messages({"string.base":"Pincode must be a string","string.empty":"Pincode is required"})});e.exports={createSiteSchema:n,updateSiteSchema:r}},9610:(e,t,a)=>{const i=a(5651);e.exports={createUser:async function(e,t){const a=await i.createUser(e.body);t.sendResponse(a,"User created successfully",201)},getAllUsers:async function(e,t){const a=await i.getAllUsers(e.user.siteId);t.sendResponse(a,"Users retrieved successfully")},getUserById:async function(e,t){const a=await i.getUserById(e.params.id,e.user.siteId);if(!a){const e=new Error;throw e.message="User not found",e.name="ResourceNotFoundError",e.statusCode=404,e}t.sendResponse(a,"User retrieved successfully")},updateUser:async function(e,t){const a=await i.updateUser(e.params.id,e.body);t.sendResponse(a,"User updated successfully")},deleteUser:async function(e,t){await i.deleteUser(e.params.id),t.sendResponse("User deleted successfully")},restoreUser:async function(e,t){const a=await i.restoreUser(e.params.id);t.sendResponse(a,"User restored successfully")}}},6620:(e,t,a)=>{const i=a(7252),n=a(9610),r=a(8610),s=a(4081),o=a(7434),d=a(7242),c=i.Router();c.post("/",d([1,2,3]),s(r.createUserSchema),o(n.createUser)),c.get("/",o(n.getAllUsers)),c.get("/:id",o(n.getUserById)),c.put("/:id",d([1,2,3]),s(r.updateUserSchema),o(n.updateUser)),c.delete("/:id",d([1,2,3]),o(n.deleteUser)),c.post("/:id/restore",d([1,2,3]),o(n.restoreUser)),e.exports=c},5651:(e,t,a)=>{const{Op:i}=a(9031),n=a(9239);e.exports={createUser:async function(e){return await n.User.create(e)},getAllUsers:async function(e){return await n.User.findAll({where:e?{siteId:e}:{},include:[{model:n.Role,attributes:["name","id"]},{model:n.Site,attributes:["name","id"]}],attributes:{exclude:["password"]}})},getUserById:async function(e,t){if(!e)throw new Error("User ID is required");const a={id:e};return t&&(a.siteId=t),await n.User.findOne({where:a,include:[{model:n.Role,attributes:["name","id"]},{model:n.Site}],attributes:{exclude:["password"]}})},updateUser:async function(e,t){const a=await n.User.findByPk(e,{attributes:{exclude:["password"]}});if(!a){const e=new Error;throw e.message="User not found",e.name="ResourceNotFoundError",e.statusCode=404,e}return await a.update(t)},deleteUser:async function(e){const t=await n.User.findByPk(e);if(!t){const e=new Error;throw e.message="User not found",e.name="ResourceNotFoundError",e.statusCode=404,e}return await t.destroy(),t},restoreUser:async function(e){const t=await n.User.findByPk(e,{paranoid:!1});if(!t){const e=new Error;throw e.message="User not found",e.name="ResourceNotFoundError",e.statusCode=404,e}return await t.restore(),t},getAllUsersV2:async function({siteId:e,page:t=1,limit:a=10,orderBy:r="name",orderDirection:s="ASC",search:o="",filters:d={}}){const c=(t-1)*a,l={...e&&{siteId:e},...d,...o&&{[i.or]:[{name:{[i.iLike]:`%${o}%`}},{email:{[i.iLike]:`%${o}%`}},{phone:{[i.iLike]:`%${o}%`}},{code:{[i.iLike]:`%${o}%`}}]}},{count:u,rows:m}=await n.User.findAndCountAll({where:l,include:[{model:n.Role,attributes:["id","name"]},{model:n.Site,attributes:["id","name"]}],order:[[r,s]],limit:a,offset:c});return{data:m,currentPage:t,totalPages:Math.ceil(u/a),totalCount:u}}}},8610:(e,t,a)=>{const i=a(2446),n=i.object({name:i.string().required().messages({"any.required":"Name is required"}),code:i.string().required().messages({"any.required":"Code is required"}),email:i.string().email().required().messages({"string.email":"Invalid email format","any.required":"Email is required"}),phone:i.string().required().messages({"any.required":"Phone is required"}),imageUrl:i.string().uri().optional().messages({"string.uri":"Invalid image URL"}),password:i.string().min(6).required().messages({"string.min":"Password must be at least 6 characters long","any.required":"Password is required"}),roleId:i.number().required().messages({"any.required":"Role ID is required"}),departmentId:i.number().optional(),siteId:i.number().optional()}),r=i.object({name:i.string().optional(),code:i.string().optional(),email:i.string().email().optional(),phone:i.string().optional(),imageUrl:i.string().uri().optional(),password:i.string().min(6).optional(),roleId:i.number().optional(),departmentId:i.number().optional(),siteId:i.number().optional()});e.exports={createUserSchema:n,updateUserSchema:r}},2888:(e,t,a)=>{const i=a(9837);e.exports={createVendor:async(e,t)=>{const a=await i.createVendor(e.body);t.sendResponse(a,"Vendor created successfully")},getAllVendors:async(e,t)=>{const a=await i.getAllVendors(e.query);t.sendResponse(a)},getVendorById:async(e,t)=>{const a=await i.getVendorById(e.params.id);t.sendResponse(a)},updateVendor:async(e,t)=>{const a=await i.updateVendor(e.params.id,e.body);t.sendResponse(a,"Vendor updated successfully")},deleteVendor:async(e,t)=>{await i.deleteVendor(e.params.id),t.sendResponse(null,"Vendor deleted successfully")}}},6782:(e,t,a)=>{const i=a(7252).Router(),n=a(7434),r=a(2888),s=a(4081),{createVendorSchema:o,updateVendorSchema:d}=a(2192);i.post("/vendors",s(o),n(r.createVendor)),i.get("/vendors",n(r.getAllVendors)),i.get("/vendors/:id",n(r.getVendorById)),i.put("/vendors/:id",s(d),n(r.updateVendor)),i.delete("/vendors/:id",n(r.deleteVendor)),e.exports=i},9837:(e,t,a)=>{const{Op:i}=a(9031),n=a(9239);e.exports={createVendor:async e=>await n.Vendor.create(e),getAllVendors:async(e={})=>{const{page:t=1,limit:a=10,search:r,isActive:s}=e,o=(t-1)*a,d={};return r&&(d[i.or]=[{name:{[i.iLike]:`%${r}%`}},{email:{[i.iLike]:`%${r}%`}}]),void 0!==s&&(d.isActive=s),await n.Vendor.findAll({where:d,limit:+a,offset:o,order:[["name","ASC"]]})},getVendorById:async e=>await n.Vendor.findByPk(e),updateVendor:async(e,t)=>{const a=await n.Vendor.findByPk(e);if(!a)throw new Error("Vendor not found");return await a.update(t)},deleteVendor:async e=>{const t=await n.Vendor.findByPk(e);if(!t)throw new Error("Vendor not found");return await t.destroy()}}},2192:(e,t,a)=>{const i=a(2446),n=i.object({name:i.string().min(2).max(100).required(),email:i.string().email().required(),contactPerson:i.string().required(),phone:i.string().pattern(/^[\+]?[(]?[0-9]{3}[)]?[-\s\.]?[0-9]{3}[-\s\.]?[0-9]{4,6}$/),address:i.string().allow(null,"").max(500),isActive:i.boolean().default(!0)}),r=n.keys({email:i.string().email()});e.exports={createVendorSchema:n,updateVendorSchema:r}},5056:(e,t,a)=>{const i=a(1416).v2;i.config({cloud_name:process.env.CLOUDINARY_CLOUD_NAME,api_key:process.env.CLOUDINARY_API_KEY,api_secret:process.env.CLOUDINARY_API_SECRET}),e.exports=i},3568:(e,t,a)=>{const i=a(5124),n=i.createLogger({level:"info",format:i.format.combine(i.format.timestamp({format:"YYYY-MM-DD HH:mm:ss"}),i.format.json()),transports:[new i.transports.File({filename:"errors.log",level:"error",format:i.format.combine(i.format.timestamp({format:"YYYY-MM-DD HH:mm:ss"}),i.format.json())}),new i.transports.File({filename:"warnings.log",level:"warn",format:i.format.combine(i.format.timestamp({format:"YYYY-MM-DD HH:mm:ss"}),i.format.json())})]});e.exports=n},5771:e=>{e.exports={ADMIN:1,MECHANICAL_HEAD:2,MECHANICAL_MANAGER:3,SITE_INCHARGE:4,STORE_MANAGER:5,PROJECT_MANAGER:6}},4729:e=>{"use strict";e.exports=require("bcryptjs")},1416:e=>{"use strict";e.exports=require("cloudinary")},6898:e=>{"use strict";e.exports=require("cookie-parser")},8577:e=>{"use strict";e.exports=require("cors")},818:e=>{"use strict";e.exports=require("dotenv")},7252:e=>{"use strict";e.exports=require("express")},1763:e=>{"use strict";e.exports=require("express-rate-limit")},2525:e=>{"use strict";e.exports=require("helmet")},2446:e=>{"use strict";e.exports=require("joi")},829:e=>{"use strict";e.exports=require("jsonwebtoken")},4716:e=>{"use strict";e.exports=require("moment")},8461:e=>{"use strict";e.exports=require("multer")},8640:e=>{"use strict";e.exports=require("multer-storage-cloudinary")},2703:e=>{"use strict";e.exports=require("node-cron")},9031:e=>{"use strict";e.exports=require("sequelize")},7660:e=>{"use strict";e.exports=require("sequelize-joi")},5124:e=>{"use strict";e.exports=require("winston")},9896:e=>{"use strict";e.exports=require("fs")},6928:e=>{"use strict";e.exports=require("path")},932:e=>{"use strict";e.exports=require("process")},2203:e=>{"use strict";e.exports=require("stream")},3106:e=>{"use strict";e.exports=require("zlib")}},t={};function a(i){var n=t[i];if(void 0!==n)return n.exports;var r=t[i]={exports:{}};return e[i](r,r.exports,a),r.exports}a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);const i=a(7252),n=a(8577),r=a(6898),s=a(6661),o=a(4946),d=a(9117),c=a(2525),l=a(1763);a(818).config();const u=a(2703),m=a(4509),p=a(5308),y=a(1116),I=a(9204);a(9138)();const h=i();l({windowMs:6e4,max:500,standardHeaders:!0,legacyHeaders:!1,message:"Too many requests from this IP, please try again later."}),h.use(c()),h.use(r()),h.use(i.json()),h.use(n({origin:["http://localhost:5173","https://erp.glimstarai.com","https://bpc-erp.vercel.app"],credentials:!0,methods:["GET","HEAD","OPTIONS","POST","PUT","DELETE","PATCH"]})),u.schedule("*/10 * * * *",(()=>{fetch("https://cpc-erp-server.onrender.com/test",{method:"GET",headers:{"Content-Type":"application/json"}})})),h.get("/test",((e,t)=>{t.send("Hello world!")})),h.use(s),h.use("/api/auth/",a(2402)),h.use(d),h.use("/api/sites/",a(5380)),h.use("/api/users/",a(6620)),h.use("/api/machinery/",a(4456)),h.use("/api/category/",a(6878)),h.use("/api/machinery-item-codes/",a(8892)),h.use("/api/",[m,p,y,I,a(6860),a(9796),a(4310),a(1192),a(6782),a(228),a(9087),a(2420)]),h.use("/api/quotation-comparison/",a(1764)),h.use("/api/maintanance/",a(612)),h.use("/api/material-issues/",a(9833)),h.use("/api/inventory/",a(344)),h.use("/api/files/",a(7386)),h.use(o);const g=process.env.PORT||3e3;h.listen(g,(()=>{console.log(`Server running on port ${g}`)}))})();
//# sourceMappingURL=main.js.map